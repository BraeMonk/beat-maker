<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="theme-color" content="#0a0e1a"/>
  <title>8-Beat Studio</title>
  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="./apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
    
    :root{
      --bg-primary:#0a0e1a; --bg-secondary:#0f1421; --bg-tertiary:#151b2e;
      --text-primary:#e8edf4; --text-secondary:#a0aec0; --text-muted:#6b7280;
      --accent-primary:#6366f1; --accent-secondary:#8b5cf6; --accent-hover:#7c3aed;
      --success:#10b981; --warning:#f59e0b; --danger:#ef4444; --info:#3b82f6;
      --card-bg:rgba(15, 20, 33, 0.8); --card-border:rgba(99, 102, 241, 0.15);
      --glass-bg:rgba(255, 255, 255, 0.03); --glass-border:rgba(255, 255, 255, 0.08);
      --shadow-sm:0 2px 8px rgba(0,0,0,0.15); --shadow-md:0 4px 16px rgba(0,0,0,0.25);
      --shadow-lg:0 8px 32px rgba(0,0,0,0.35); --shadow-xl:0 12px 48px rgba(0,0,0,0.45);
      --radius-sm:8px; --radius-md:12px; --radius-lg:16px; --radius-xl:20px;
    }
    
    *{box-sizing:border-box; margin:0; padding:0}
    html,body{height:100%; overflow-x:hidden}
    body{
      font-family:'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      color:var(--text-primary); background:var(--bg-primary);
      background: radial-gradient(ellipse 1400px 800px at 20% 0%, rgba(99,102,241,0.08), transparent),
                  radial-gradient(ellipse 1200px 700px at 80% 100%, rgba(139,92,246,0.06), transparent),
                  linear-gradient(135deg, var(--bg-primary), var(--bg-secondary));
      line-height:1.6; -webkit-font-smoothing:antialiased; padding:clamp(12px, 2.5vw, 24px);
    }
    
    .app{
      max-width:1600px; margin:0 auto; background:var(--card-bg); backdrop-filter:blur(20px);
      border-radius:var(--radius-xl); box-shadow:var(--shadow-xl);
      border:1px solid var(--card-border); overflow:hidden;
    }
    
    /* Header */
    header{
      display:grid; grid-template-columns:auto 1fr auto; gap:16px; align-items:center;
      padding:20px 24px; background:linear-gradient(135deg, rgba(99,102,241,0.08), rgba(139,92,246,0.05));
      border-bottom:1px solid var(--glass-border); backdrop-filter:blur(12px);
    }
    
    .logo-section{display:flex; align-items:center; gap:12px}
    .logo{
      width:48px; height:48px; border-radius:12px;
      background:linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      display:grid; place-items:center; font-size:24px; font-weight:900;
      box-shadow:0 4px 16px rgba(99,102,241,0.3);
    }
    
    h1{
      font-size:clamp(20px, 2.5vw, 28px); font-weight:900;
      background:linear-gradient(135deg, #fff, var(--text-secondary));
      -webkit-background-clip:text; background-clip:text; color:transparent;
      letter-spacing:-0.02em;
    }
    .tagline{color:var(--text-muted); font-size:0.9rem; font-weight:600}
    
    .genre-selector{
      display:flex; gap:8px; padding:6px; background:var(--glass-bg);
      border-radius:var(--radius-md); border:1px solid var(--glass-border);
    }
    .genre-btn{
      padding:8px 16px; border:none; border-radius:var(--radius-sm);
      background:transparent; color:var(--text-secondary); font-weight:700;
      cursor:pointer; transition:all 0.2s; font-size:0.875rem;
    }
    .genre-btn:hover{background:var(--glass-bg); color:var(--text-primary)}
    .genre-btn.active{
      background:linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      color:#fff; box-shadow:0 2px 8px rgba(99,102,241,0.3);
    }
    
    .header-actions{display:flex; gap:8px}
    
    /* Tabs */
    .tabs{
      display:flex; gap:4px; padding:12px 24px; background:var(--glass-bg);
      border-bottom:1px solid var(--glass-border); overflow-x:auto;
    }
    .tab{
      padding:10px 20px; border:none; border-radius:var(--radius-sm);
      background:transparent; color:var(--text-secondary); font-weight:700;
      cursor:pointer; transition:all 0.2s; white-space:nowrap; font-size:0.875rem;
    }
    .tab:hover{background:var(--glass-bg); color:var(--text-primary)}
    .tab.active{
      background:linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      color:#fff; box-shadow:0 2px 8px rgba(99,102,241,0.25);
    }
    
    /* Transport */
    .transport{
      position:sticky; top:0; z-index:100; padding:16px 24px;
      background:linear-gradient(180deg, rgba(10,14,26,0.95), rgba(10,14,26,0.8));
      backdrop-filter:blur(16px); border-bottom:1px solid var(--glass-border);
      display:grid; grid-template-columns:auto 1fr auto; gap:16px; align-items:center;
    }
    
    .transport-controls{display:flex; gap:8px; align-items:center}
    
    .progress-area{display:flex; flex-direction:column; gap:8px; flex:1}
    .time-info{
      display:flex; justify-content:space-between; align-items:center;
      font-size:0.875rem; font-weight:700; color:var(--text-secondary);
    }
    .time-display{
      font-variant-numeric:tabular-nums; color:var(--accent-primary);
      font-size:1rem; font-weight:900;
    }
    
    .progress-bar{
      height:8px; background:var(--glass-bg); border-radius:999px;
      overflow:hidden; position:relative; border:1px solid var(--glass-border);
    }
    .progress-fill{
      height:100%; width:0; border-radius:999px;
      background:linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
      transition:width 0.1s linear; box-shadow:0 0 12px rgba(99,102,241,0.5);
    }
    
    .transport-params{
      display:grid; grid-template-columns:repeat(2, 1fr); gap:12px;
      padding:12px; background:var(--glass-bg); border-radius:var(--radius-md);
      border:1px solid var(--glass-border);
    }
    .param-control{display:flex; flex-direction:column; gap:4px}
    .param-label{
      display:flex; justify-content:space-between; align-items:center;
      font-size:0.75rem; font-weight:700; color:var(--text-muted);
      text-transform:uppercase; letter-spacing:0.05em;
    }
    .param-value{
      color:var(--accent-primary); font-weight:900;
      font-variant-numeric:tabular-nums;
    }
    
    /* Buttons */
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:10px 18px; border:none; border-radius:var(--radius-sm);
      font-weight:700; font-size:0.875rem; cursor:pointer; transition:all 0.2s;
      white-space:nowrap; text-decoration:none;
    }
    .btn:disabled{opacity:0.5; cursor:not-allowed}
    
    .btn-primary{
      background:linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      color:#fff; box-shadow:0 2px 8px rgba(99,102,241,0.3);
    }
    .btn-primary:hover:not(:disabled){
      transform:translateY(-1px); box-shadow:0 4px 12px rgba(99,102,241,0.4);
    }
    
    .btn-secondary{
      background:var(--glass-bg); color:var(--text-primary);
      border:1px solid var(--glass-border);
    }
    .btn-secondary:hover:not(:disabled){
      background:var(--glass-border); border-color:var(--accent-primary);
    }
    
    .btn-ghost{
      background:transparent; color:var(--text-secondary); border:1px solid transparent;
    }
    .btn-ghost:hover:not(:disabled){
      background:var(--glass-bg); border-color:var(--glass-border); color:var(--text-primary);
    }
    
    .btn-success{background:var(--success); color:#fff}
    .btn-warning{background:var(--warning); color:#fff}
    .btn-danger{background:var(--danger); color:#fff}
    
    .btn-sm{padding:6px 12px; font-size:0.8rem}
    .btn-lg{padding:14px 24px; font-size:1rem}
    
    /* Sections */
    .section{display:none; padding:24px}
    .section.active{display:block}
    
    /* Panels */
    .panel{
      background:var(--card-bg); border:1px solid var(--card-border);
      border-radius:var(--radius-lg); padding:20px; backdrop-filter:blur(12px);
      box-shadow:var(--shadow-md);
    }
    .panel + .panel{margin-top:16px}
    
    .panel-header{
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:16px; padding-bottom:12px; border-bottom:1px solid var(--glass-border);
    }
    .panel-title{
      font-size:1.1rem; font-weight:900; color:var(--text-primary);
      display:flex; align-items:center; gap:10px;
    }
    
    /* Grid Layouts */
    .grid{display:grid; gap:16px}
    .grid-2{grid-template-columns:repeat(auto-fit, minmax(300px, 1fr))}
    .grid-3{grid-template-columns:repeat(auto-fit, minmax(250px, 1fr))}
    .grid-4{grid-template-columns:repeat(auto-fit, minmax(200px, 1fr))}
    
    /* Visualizer */
    .visualizer{
      height:140px; border-radius:var(--radius-md); position:relative;
      background:linear-gradient(135deg, rgba(99,102,241,0.05), rgba(139,92,246,0.03));
      border:1px solid var(--glass-border); overflow:hidden;
    }
    .viz-bar{
      position:absolute; bottom:0; width:4px; border-radius:2px 2px 0 0;
      background:linear-gradient(to top, var(--accent-primary), var(--accent-secondary));
      opacity:0.8; transition:height 0.08s ease-out;
    }
    .viz-overlay{
      position:absolute; inset:0; display:grid; place-items:center;
      background:rgba(10,14,26,0.5); backdrop-filter:blur(4px);
      font-weight:700; color:var(--text-muted); pointer-events:none;
    }
    
    /* Sequencer */
    .sequencer{overflow-x:auto; overflow-y:visible}
    .seq-grid{display:grid; gap:6px; min-width:800px}
    .seq-row{
      display:grid; grid-template-columns:140px repeat(16, 1fr);
      gap:6px; align-items:center;
    }
    .seq-label{
      display:flex; align-items:center; justify-content:space-between;
      padding:8px 12px; background:var(--glass-bg); border-radius:var(--radius-sm);
      border:1px solid var(--glass-border); font-weight:700; font-size:0.85rem;
    }
    .seq-icons{display:flex; gap:4px}
    .seq-icon{
      width:24px; height:24px; border:none; border-radius:4px;
      background:var(--glass-bg); color:var(--text-muted);
      cursor:pointer; display:grid; place-items:center; font-size:0.7rem;
      transition:all 0.2s;
    }
    .seq-icon:hover{background:var(--glass-border); color:var(--text-primary)}
    .seq-icon.active{background:var(--danger); color:#fff}
    
    .step{
      aspect-ratio:1; border-radius:var(--radius-sm); cursor:pointer;
      background:var(--glass-bg); border:2px solid var(--glass-border);
      position:relative; display:grid; place-items:center; transition:all 0.15s;
    }
    .step:hover{border-color:var(--accent-primary); transform:scale(1.05)}
    .step.active{
      background:linear-gradient(135deg, rgba(99,102,241,0.8), rgba(139,92,246,0.9));
      border-color:var(--accent-primary); box-shadow:0 0 12px rgba(99,102,241,0.5),
      inset 0 0 0 1px rgba(255,255,255,0.2);
    }
    .step.playing{
      animation:pulse 0.3s ease-out;
      box-shadow:0 0 20px var(--warning), 0 0 40px rgba(245,158,11,0.3);
      border-color:var(--warning);
    }
    @keyframes pulse{0%, 100%{transform:scale(1)} 50%{transform:scale(1.15)}}
    
    .step-prob{
      position:absolute; top:4px; right:4px; font-size:0.65rem;
      background:rgba(0,0,0,0.7); padding:2px 5px; border-radius:4px;
      color:#fff; font-weight:700; pointer-events:none;
    }
    .step-vel{
      position:absolute; bottom:4px; left:4px; right:4px; height:4px;
      background:rgba(255,255,255,0.2); border-radius:2px; overflow:hidden;
    }
    .step-vel-fill{
      height:100%; background:#fff; opacity:0.9; transition:width 0.2s;
    }
    
    /* Sliders */
    input[type=range]{
      width:100%; height:6px; border-radius:999px;
      background:var(--glass-bg); border:1px solid var(--glass-border);
      appearance:none; cursor:pointer;
    }
    input[type=range]::-webkit-slider-thumb{
      appearance:none; width:20px; height:20px; border-radius:50%;
      background:linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      box-shadow:0 2px 8px rgba(99,102,241,0.4); cursor:pointer;
    }
    input[type=range]::-moz-range-thumb{
      width:20px; height:20px; border-radius:50%; border:none;
      background:linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      box-shadow:0 2px 8px rgba(99,102,241,0.4); cursor:pointer;
    }
    
    /* Select */
    select{
      padding:8px 12px; border-radius:var(--radius-sm);
      background:var(--glass-bg); border:1px solid var(--glass-border);
      color:var(--text-primary); font-weight:600; cursor:pointer;
      font-family:inherit;
    }
    
    /* Chips */
    .chips{display:flex; flex-wrap:wrap; gap:8px}
    .chip{
      padding:8px 14px; border-radius:999px; cursor:pointer;
      background:var(--glass-bg); border:1px solid var(--glass-border);
      color:var(--text-secondary); font-weight:700; font-size:0.85rem;
      transition:all 0.2s;
    }
    .chip:hover{border-color:var(--accent-primary); color:var(--text-primary)}
    .chip.active{
      background:linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      color:#fff; border-color:transparent; box-shadow:0 2px 8px rgba(99,102,241,0.3);
    }
    
    /* Presets */
    .preset-grid{
      display:grid; grid-template-columns:repeat(auto-fill, minmax(160px, 1fr)); gap:12px;
    }
    .preset{
      padding:16px; border-radius:var(--radius-md); cursor:pointer;
      background:var(--glass-bg); border:2px solid var(--glass-border);
      text-align:center; font-weight:700; transition:all 0.2s;
      display:flex; flex-direction:column; gap:8px; align-items:center;
    }
    .preset:hover{
      border-color:var(--accent-primary); transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(99,102,241,0.2);
    }
    .preset-icon{font-size:1.8rem}
    .preset-name{font-size:0.9rem; color:var(--text-primary)}
    
    /* Mixer Channel */
    .mixer-channel{
      background:var(--glass-bg); border:1px solid var(--glass-border);
      border-radius:var(--radius-md); padding:16px; display:flex; flex-direction:column; gap:12px;
    }
    .channel-header{
      display:flex; justify-content:space-between; align-items:center;
      padding-bottom:8px; border-bottom:1px solid var(--glass-border);
    }
    .channel-name{font-weight:900; color:var(--text-primary)}
    .channel-btns{display:flex; gap:4px}
    .channel-btn{
      width:28px; height:28px; border:none; border-radius:6px;
      background:var(--glass-bg); color:var(--text-muted);
      cursor:pointer; font-weight:900; font-size:0.75rem; transition:all 0.2s;
    }
    .channel-btn:hover{background:var(--glass-border); color:var(--text-primary)}
    .channel-btn.active{color:#fff}
    .channel-btn.mute.active{background:var(--danger)}
    .channel-btn.solo.active{background:var(--warning)}
    
    /* FX Unit */
    .fx-unit{
      background:var(--glass-bg); border:1px solid var(--glass-border);
      border-radius:var(--radius-md); padding:16px;
    }
    .fx-header{
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:12px; padding-bottom:8px; border-bottom:1px solid var(--glass-border);
    }
    .fx-name{font-weight:900; color:var(--text-primary)}
    .fx-toggle{
      width:48px; height:24px; border-radius:12px; cursor:pointer;
      background:var(--glass-bg); border:2px solid var(--glass-border);
      position:relative; transition:all 0.3s;
    }
    .fx-toggle::after{
      content:''; position:absolute; left:2px; top:2px;
      width:16px; height:16px; border-radius:50%; background:var(--text-muted);
      transition:all 0.3s;
    }
    .fx-toggle.active{background:var(--success); border-color:var(--success)}
    .fx-toggle.active::after{left:26px; background:#fff}
    
    /* Footer */
    .footer{
      padding:20px 24px; background:var(--glass-bg);
      border-top:1px solid var(--glass-border); text-align:center;
      color:var(--text-muted); font-size:0.85rem;
    }
    
    /* Responsive */
    @media (max-width:1024px){
      header{grid-template-columns:1fr; text-align:center}
      .genre-selector{justify-content:center; flex-wrap:wrap}
      .transport{grid-template-columns:1fr; gap:12px}
      .transport-params{grid-template-columns:1fr}
      .grid-2,.grid-3,.grid-4{grid-template-columns:1fr}
    }
    
    /* Animations */
    @keyframes fadeIn{from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:translateY(0)}}
    .panel{animation:fadeIn 0.3s ease-out}
    
    /* Utility */
    .flex{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .flex-col{display:flex; flex-direction:column; gap:12px}
    .mb-2{margin-bottom:8px}
    .mb-3{margin-bottom:12px}
    .mt-2{margin-top:8px}
    .mt-3{margin-top:12px}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="logo-section">
        <div class="logo">🎹</div>
        <div>
          <h1>8-Beat Studio</h1>
          <div class="tagline">Fun With Noise</div>
        </div>
      </div>
      
      <div class="genre-selector" id="genreSelector">
        <button class="genre-btn active" data-genre="lofi">Lo-Fi</button>
        <button class="genre-btn" data-genre="hiphop">Hip-Hop</button>
        <button class="genre-btn" data-genre="trap">Trap</button>
        <button class="genre-btn" data-genre="house">House</button>
        <button class="genre-btn" data-genre="techno">Techno</button>
        <button class="genre-btn" data-genre="dnb">DnB</button>
        <button class="genre-btn" data-genre="ambient">Ambient</button>
      </div>
      
      <div class="header-actions">
        <button class="btn btn-secondary btn-sm" id="installBtn" hidden>📱 Install</button>
      </div>
    </header>
    
    <div class="tabs" id="tabs">
      <button class="tab active" data-tab="generate">🎲 Generate</button>
      <button class="tab" data-tab="sequencer">🎹 Sequencer</button>
      <button class="tab" data-tab="mixer">🎚️ Mixer</button>
      <button class="tab" data-tab="fx">🎛️ Effects</button>
      <button class="tab" data-tab="harmony">🎼 Harmony</button>
    </div>
    
    <div class="transport">
      <div class="transport-controls">
        <button class="btn btn-primary" id="playBtn">▶️ Play</button>
        <button class="btn btn-secondary" id="stopBtn">⏹️ Stop</button>
        <button class="btn btn-secondary" id="exportBtn">💾 Export</button>
      </div>
      
      <div class="progress-area">
        <div class="time-info">
          <span class="time-display" id="timeDisplay">00:00</span>
          <span id="durationDisplay">/ 05:00</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
      </div>
      
      <div class="transport-params">
        <div class="param-control">
          <div class="param-label">
            <span>BPM</span>
            <span class="param-value" id="bpmValue">120</span>
          </div>
          <input type="range" id="bpmSlider" min="60" max="180" value="120">
        </div>
        <div class="param-control">
          <div class="param-label">
            <span>Swing</span>
            <span class="param-value" id="swingValue">50%</span>
          </div>
          <input type="range" id="swingSlider" min="0" max="100" value="50">
        </div>
      </div>
    </div>
    
    <section class="section active" id="tab-generate">
      <div class="panel">
        <div class="visualizer" id="visualizer">
          <div class="viz-overlay" id="vizOverlay">Press Play to Start</div>
        </div>
      </div>
      
      <div class="grid grid-2">
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">⚙️ Project Settings</div>
          </div>
          
          <div class="grid grid-3 mb-3">
            <div class="param-control">
              <div class="param-label">
                <span>Duration</span>
                <span class="param-value" id="durValue">5 min</span>
              </div>
              <input type="range" id="durSlider" min="1" max="20" value="5">
            </div>
            <div class="param-control">
              <div class="param-label">
                <span>Complexity</span>
                <span class="param-value" id="complexValue">Medium</span>
              </div>
              <input type="range" id="complexSlider" min="1" max="3" value="2">
            </div>
            <div class="param-control">
              <div class="param-label">
                <span>Humanize</span>
                <span class="param-value" id="humanValue">10ms</span>
              </div>
              <input type="range" id="humanSlider" min="0" max="30" value="10">
            </div>
          </div>
          
          <div class="flex">
            <button class="btn btn-primary" id="generateBtn">🎲 Generate Beat</button>
            <button class="btn btn-secondary" id="randomVelBtn">🎯 Random Velocity</button>
            <button class="btn btn-secondary" id="randomProbBtn">🎲 Random Prob</button>
            <button class="btn btn-ghost" id="clearBtn">🧹 Clear</button>
          </div>
        </div>
        
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">💾 Project Management</div>
          </div>
          
          <div class="flex-col">
            <div class="flex">
              <button class="btn btn-success" id="saveBtn">💾 Save Project</button>
              <button class="btn btn-secondary" id="loadBtn">📂 Load Project</button>
            </div>
            <div class="flex">
              <input type="text" id="projectName" placeholder="Project Name" 
                style="flex:1; padding:10px; background:var(--glass-bg); border:1px solid var(--glass-border); border-radius:var(--radius-sm); color:var(--text-primary); font-family:inherit">
            </div>
          </div>
        </div>
      </div>
      
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">🎨 Genre Presets</div>
        </div>
        <div class="preset-grid" id="presetGrid"></div>
      </div>
    </section>
    
    <section class="section" id="tab-sequencer">
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">🎹 Pattern Sequencer</div>
          <div class="flex">
            <button class="btn btn-secondary btn-sm" id="lenDecBtn">− Length</button>
            <button class="btn btn-secondary btn-sm" id="lenIncBtn">+ Length</button>
            <select id="resSelect">
              <option value="16n" selected>1/16</option>
              <option value="8n">1/8</option>
              <option value="32n">1/32</option>
            </select>
            <button class="btn btn-secondary btn-sm" id="euclidBtn">∷ Euclidean</button>
            <button class="btn btn-secondary btn-sm" id="ghostBtn">👻 Ghost Notes</button>
          </div>
        </div>
        
        <div class="sequencer">
          <div class="seq-grid" id="seqGrid"></div>
        </div>
      </div>
    </section>
    
    <section class="section" id="tab-mixer">
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">🎚️ Channel Mixer</div>
        </div>
        <div class="grid grid-4" id="mixerGrid"></div>
      </div>
      
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">🎛️ Master Bus</div>
        </div>
        
        <div class="grid grid-3">
          <div class="param-control">
            <div class="param-label">
              <span>Master Volume</span>
              <span class="param-value" id="masterVolValue">0dB</span>
            </div>
            <input type="range" id="masterVolSlider" min="-40" max="10" value="0">
          </div>
          <div class="param-control">
            <div class="param-label">
              <span>Tape Saturation</span>
              <span class="param-value" id="tapeValue">25%</span>
            </div>
            <input type="range" id="tapeSlider" min="0" max="100" value="25">
          </div>
          <div class="param-control">
            <div class="param-label">
              <span>Vinyl Noise</span>
              <span class="param-value" id="vinylValue">15%</span>
            </div>
            <input type="range" id="vinylSlider" min="0" max="100" value="15">
          </div>
        </div>
        
        <div class="grid grid-3 mt-3">
          <div class="param-control">
            <div class="param-label">
              <span>Low Cut</span>
              <span class="param-value" id="lowCutValue">30Hz</span>
            </div>
            <input type="range" id="lowCutSlider" min="20" max="200" value="30">
          </div>
          <div class="param-control">
            <div class="param-label">
              <span>High Cut</span>
              <span class="param-value" id="highCutValue">16kHz</span>
            </div>
            <input type="range" id="highCutSlider" min="4000" max="20000" value="16000">
          </div>
          <div class="param-control">
            <div class="param-label">
              <span>Compressor</span>
              <span class="param-value" id="compValue">-18dB</span>
            </div>
            <input type="range" id="compSlider" min="-40" max="0" value="-18">
          </div>
        </div>
      </div>
    </section>
    
    <section class="section" id="tab-fx">
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">🎛️ Effects Rack</div>
        </div>
        <div class="grid grid-3" id="fxGrid"></div>
      </div>
    </section>
    
    <section class="section" id="tab-harmony">
      <div class="grid grid-2">
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">🎼 Key & Scale</div>
          </div>
          
          <div class="flex mb-3">
            <label style="display:flex; align-items:center; gap:8px">
              Key: <select id="keySelect"></select>
            </label>
            <label style="display:flex; align-items:center; gap:8px">
              Scale: <select id="scaleSelect"></select>
            </label>
            <label style="display:flex; align-items:center; gap:8px">
              Octave: <select id="octaveSelect"></select>
            </label>
          </div>
          
          <div class="panel-header">
            <div class="panel-title">Available Chords</div>
            <button class="btn btn-secondary btn-sm" id="genProgBtn">↻ Generate</button>
          </div>
          <div class="chips" id="chordChips"></div>
        </div>
        
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">🎵 Chord Progression</div>
            <button class="btn btn-ghost btn-sm" id="clearProgBtn">Clear</button>
          </div>
          
          <div class="chips mb-3" id="progressionChips"></div>
          
          <div class="panel-header">
            <div class="panel-title">Progression Templates</div>
          </div>
          <div class="grid grid-4">
            <button class="preset" data-prog="ii-v-i">
              <div class="preset-icon">🎷</div>
              <div class="preset-name">II-V-I</div>
            </button>
            <button class="preset" data-prog="lofi">
              <div class="preset-icon">😌</div>
              <div class="preset-name">Lo-Fi</div>
            </button>
            <button class="preset" data-prog="neosoul">
              <div class="preset-icon">🎹</div>
              <div class="preset-name">Neo-Soul</div>
            </button>
            <button class="preset" data-prog="modal">
              <div class="preset-icon">🌙</div>
              <div class="preset-name">Modal</div>
            </button>
          </div>
        </div>
      </div>
    </section>
    
    <footer class="footer">
      <strong>ProStudio Beat Lab</strong> • Professional Multi-Genre Production • 
      Shortcuts: <kbd>Space</kbd> Play/Pause • <kbd>S</kbd> Stop • <kbd>E</kbd> Export • 
      Sequencer: <kbd>Alt</kbd> Accent Velocity • <kbd>Shift</kbd> Increase Probability
    </footer>
  </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

<script>
// ========================================
// 8-Beat / ProStudio - Updated JavaScript
// - Fixes toggle bugs (single delegated listeners)
// - Stable audio graph (per-channel -> master FX)
// - Reduced crackle (no reconnects, lighter viz)
// - Real save dialog on export (with fallback)
// - Warmer synths (AMSynth/FMSynth) for instruments
// - Swing actually affects timing
// ========================================

// -------------------- Global State --------------------
let state = {
  currentGenre: 'lofi',
  currentTab: 'generate',
  isPlaying: false,
  bpm: 120,
  swing: 50,
  duration: 5,
  complexity: 2,
  humanize: 10,
  sequenceLength: 16,
  resolution: '16n',
  currentStep: 0,
  key: 'C',
  scale: 'major',
  octave: 4,
  progression: [],
  masterVolume: 0,
  tapeSaturation: 25,
  vinylNoise: 15,
  lowCut: 30,
  highCut: 16000,
  compressor: -18
};

// Instruments and Patterns
const instruments = {
  kick: { name: 'Kick', icon: '🥁', mute: false, solo: false, volume: 0, pan: 0, type: 'drum' },
  snare: { name: 'Snare', icon: '🎤', mute: false, solo: false, volume: 0, pan: 0, type: 'drum' },
  hihat: { name: 'Hi-Hat', icon: '🎩', mute: false, solo: false, volume: 0, pan: 0, type: 'drum' },
  clap: { name: 'Clap', icon: '👏', mute: false, solo: false, volume: 0, pan: 0, type: 'drum' },
  rimshot: { name: 'Rimshot', icon: '🔊', mute: false, solo: false, volume: 0, pan: 0, type: 'drum' },
  tom: { name: 'Tom', icon: '🪘', mute: false, solo: false, volume: 0, pan: 0, type: 'drum' },
  crash: { name: 'Crash', icon: '💥', mute: false, solo: false, volume: 0, pan: 0, type: 'drum' },
  ride: { name: 'Ride', icon: '🌊', mute: false, solo: false, volume: 0, pan: 0, type: 'drum' },
  bass: { name: 'Bass', icon: '🎸', mute: false, solo: false, volume: -3, pan: 0, type: 'melodic', note: 'C2' },
  keys: { name: 'Keys', icon: '🎹', mute: false, solo: false, volume: -6, pan: 0, type: 'melodic', note: 'C4' },
  lead: { name: 'Lead', icon: '🎺', mute: false, solo: false, volume: -8, pan: 0, type: 'melodic', note: 'C5' }
};
const patterns = {};
const synths = {};
const effects = {};
const master = {};

// Initialize patterns
Object.keys(instruments).forEach(inst => {
  patterns[inst] = Array(16).fill(null).map(() => ({
    active: false,
    velocity: 0.8,
    probability: 100
  }));
});

// -------------------- Presets (unchanged content trimmed for brevity) --------------------
const genrePresets = {
  lofi: { name: 'Lo-Fi Hip-Hop', icon: '😌', bpm: 85,
    patterns:{kick:[1,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0],snare:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],hihat:[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],bass:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],keys:[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0]},
    notes:{bass:['C2','C2','C2','C2','D#2','D#2','D#2','D#2','F2','F2','F2','F2','G2','G2','G2','G2'],
           keys:['C4','E4','G4','C4','D#4','G4','A#4','D#4','F4','A4','C5','F4','G4','B4','D5','G4'],
           lead:['C5','D5','E5','G5','A5','G5','E5','D5']}
  },
  hiphop:{name:'Hip-Hop',icon:'🎤',bpm:95,
    patterns:{kick:[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0],snare:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],hihat:[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],bass:[1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0],keys:[1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0]},
    notes:{bass:['A1','A1','A1','C2','C2','C2','D2','D2','D2','F2','F2','F2','G2','G2','G2','G2'],
           keys:['A3','C4','E4','A4','C4','E4','D4','F4','A4','D4','F4','G3','B3','D4','G4','B4'],
           lead:['A4','C5','E5','A5','G5','E5','D5','C5']}
  },
  trap:{name:'Trap',icon:'💎',bpm:140,
    patterns:{kick:[1,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0],snare:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,1],hihat:[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],bass:[1,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0],lead:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0]},
    notes:{bass:['C1','C1','C1','C1','C1','C1','D#1','D#1','D#1','D#1','F1','F1','F1','F1','G1','G1'],
           keys:['C4','D#4','G4','C5','D#4','G4','A#4','D#4'],
           lead:['C5','D#5','G5','C6','A#5','G5','D#5','C5']}
  },
  house:{name:'House',icon:'🏠',bpm:125,
    patterns:{kick:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],snare:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],hihat:[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],bass:[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],keys:[1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0]},
    notes:{bass:['F2','F2','F2','F2','G2','G2','G2','G2','A2','A2','A2','A2','C3','C3','C3','C3'],
           keys:['F4','A4','C5','F5','G4','B4','D5','G5','A4','C5','E5','A5','C5','E5','G5','C6'],
           lead:['F5','G5','A5','C6','D6','C6','A5','G5']}
  },
  techno:{name:'Techno',icon:'⚡',bpm:130,
    patterns:{kick:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],snare:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],hihat:[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],bass:[1,0,0,0,1,0,1,0,1,0,0,0,1,0,1,0],lead:[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0]},
    notes:{bass:['A1','A1','A1','A1','A1','A1','C2','C2','C2','C2','D2','D2','D2','D2','F2','F2'],
           keys:['A3','C4','E4','A4','C4','E4','D4','F4'],
           lead:['A5','C6','E6','A6','C6','E6','D6','F6']}
  },
  dnb:{name:'Drum & Bass',icon:'🔊',bpm:174,
    patterns:{kick:[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],snare:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],hihat:[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],bass:[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],lead:[0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0]},
    notes:{bass:['D2','D2','D3','D2','D2','D3','F2','F2','F3','F2','G2','G2','G3','G2','A2','A2'],
           keys:['D4','F4','A4','D5','F4','A4','G4','B4'],
           lead:['D5','F5','A5','D6','F6','A6','D6','A5']}
  },
  ambient:{name:'Ambient',icon:'🌌',bpm:60,
    patterns:{kick:[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],snare:[0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],hihat:[0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0],bass:[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],keys:[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],lead:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0]},
    notes:{bass:['C2','C2','C2','C2','C2','C2','C2','C2','G1','G1','G1','G1','G1','G1','G1','G1'],
           keys:['C3','E3','G3','C4','E4','G4','G3','B3','D4','G4','B4','D5'],
           lead:['C5','E5','G5','C6','B5','G5','E5','D5']}
  }
};

// Music Theory
const keysArr = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
const scales = {
  major:[0,2,4,5,7,9,11], minor:[0,2,3,5,7,8,10], dorian:[0,2,3,5,7,9,10],
  phrygian:[0,1,3,5,7,8,10], lydian:[0,2,4,6,7,9,11],
  mixolydian:[0,2,4,5,7,9,10], pentatonic:[0,2,4,7,9]
};

// Effects Configuration (UI state)
const fxConfig = {
  reverb: { name:'Reverb', active:false, decay:2, wet:0.3 },
  delay: { name:'Delay', active:false, time:'8n', feedback:0.4 },
  chorus:{ name:'Chorus', active:false, frequency:1.5, depth:0.7 },
  distortion:{ name:'Distortion', active:false, amount:0.5 },
  filter:{ name:'Filter', active:false, frequency:1000, type:'lowpass' },
  phaser:{ name:'Phaser', active:false, frequency:0.5, octaves:3 }
};

// -------------------- Tone.js Setup --------------------
function initAudio() {
  // MASTER chain
  master.fxIn = new Tone.Gain(1);

  effects.filter = new Tone.Filter(fxConfig.filter.frequency, fxConfig.filter.type);
  effects.distortion = new Tone.Distortion(fxConfig.distortion.amount);
  effects.chorus = new Tone.Chorus(1.5, 2.5, fxConfig.chorus.depth).start();
  effects.phaser = new Tone.Phaser({ frequency: fxConfig.phaser.frequency, octaves: fxConfig.phaser.octaves, baseFrequency: 350 });
  effects.delay = new Tone.FeedbackDelay(fxConfig.delay.time, fxConfig.delay.feedback);
  effects.reverb = new Tone.Reverb(fxConfig.reverb.decay);

  master.comp = new Tone.Compressor(-18, 3);
  master.limiter = new Tone.Limiter(-1);

  master.fxIn
    .chain(
      effects.filter,
      effects.distortion,
      effects.chorus,
      effects.phaser,
      effects.delay,
      effects.reverb,
      master.comp,
      master.limiter,
      Tone.Destination
    );

  // Start with all FX dry
  Object.values(effects).forEach(fx => { if (fx.wet) fx.wet.value = 0; });

  // Create synths and channel strips
  Object.keys(instruments).forEach(inst => {
    const instData = instruments[inst];

    if (instData.type === 'drum') {
      if (inst === 'kick') {
        synths[inst] = new Tone.MembraneSynth({
          pitchDecay: 0.08, octaves: 8, oscillator: { type: 'sine' },
          envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 1.4 }
        });
      } else if (inst === 'snare' || inst === 'clap') {
        synths[inst] = new Tone.NoiseSynth({
          noise: { type: 'white' },
          envelope: { attack: 0.001, decay: 0.2, sustain: 0 }
        });
      } else if (inst === 'hihat') {
        synths[inst] = new Tone.MetalSynth({
          frequency: 200,
          envelope: { attack: 0.001, decay: 0.1, release: 0.01 },
          harmonicity: 5.1, modulationIndex: 32, resonance: 4000, octaves: 1.5
        });
      } else {
        synths[inst] = new Tone.MembraneSynth({
          pitchDecay: 0.05, octaves: 6, oscillator: { type: 'sine' },
          envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 1.4 }
        });
      }
    } else if (instData.type === 'melodic') {
      if (inst === 'bass') {
        synths[inst] = new Tone.MonoSynth({
          oscillator: { type: 'sawtooth' },
          filter: { Q: 2, type: 'lowpass', rolloff: -24 },
          envelope: { attack: 0.01, decay: 0.3, sustain: 0.4, release: 0.8 },
          filterEnvelope: { attack: 0.01, decay: 0.2, sustain: 0.3, release: 0.5, baseFrequency: 100, octaves: 2.5 }
        });
      } else if (inst === 'keys') {
        // Warmer keys
        synths[inst] = new Tone.PolySynth(Tone.AMSynth, {
          harmonicity: 1.01,
          envelope: { attack: 0.02, decay: 0.4, sustain: 0.6, release: 1.5 },
          modulationEnvelope: { attack: 0.2, decay: 0.3, sustain: 0.2, release: 0.8 }
        });
      } else if (inst === 'lead') {
        // Mellow lead
        synths[inst] = new Tone.FMSynth({
          modulationIndex: 6,
          oscillator: { type: 'sine' },
          envelope: { attack: 0.01, decay: 0.25, sustain: 0.5, release: 0.8 },
          modulation: { type: 'triangle' },
          modulationEnvelope: { attack: 0.01, decay: 0.2, sustain: 0.3, release: 0.7 }
        });
      }
      synths[inst].volume.value = instData.volume;
    }

    // One channel per instrument (no reconnecting later)
    const ch = new Tone.Channel({
      pan: 0,
      volume: instData.volume
    }).connect(master.fxIn);
    instruments[inst].channel = ch;
    synths[inst].connect(ch);
  });

  // Transport
  Tone.Transport.bpm.value = state.bpm;
  Tone.Transport.swing = state.swing / 100;
  Tone.Transport.swingSubdivision = '8n';

  // Sequencer loop
  const loop = new Tone.Sequence((time, step) => {
    state.currentStep = step;
    updateStepVisuals(step);

    Object.keys(instruments).forEach(inst => {
      const stepData = patterns[inst][step];
      if (!stepData.active) return;

      const instData = instruments[inst];
      if (instData.mute) return;

      // Solo logic
      const anySolo = Object.values(instruments).some(i => i.solo);
      if (anySolo && !instData.solo) return;

      // Probability
      if (Math.random() * 100 > stepData.probability) return;

      // Humanize
      const humanize = (Math.random() - 0.5) * (state.humanize / 1000);

      if (instData.type === 'drum') {
        if (inst === 'kick') {
          synths[inst].triggerAttackRelease('C1', '8n', time + humanize, stepData.velocity);
        } else if (inst === 'snare' || inst === 'clap') {
          synths[inst].triggerAttackRelease('16n', time + humanize, stepData.velocity);
        } else if (inst === 'hihat') {
          synths[inst].triggerAttackRelease('16n', time + humanize, stepData.velocity * 0.5);
        } else {
          synths[inst].triggerAttackRelease('C2', '16n', time + humanize, stepData.velocity);
        }
      } else {
        const note = stepData.note || instruments[inst].note || 'C4';
        const duration = stepData.duration || '8n';
        synths[inst].triggerAttackRelease(note, duration, time + humanize, stepData.velocity);
      }
    });

    updateVisualizer();
  }, Array.from({ length: state.sequenceLength }, (_, i) => i), state.resolution);

  loop.start(0);
}

// -------------------- UI Init & Delegated Listeners --------------------
function init() {
  initAudio();
  setupEventListeners();
  renderSequencer();
  renderMixer();
  renderFX();
  renderHarmony();
  renderPresets();
  updateAllDisplays();
  initVisualizerOnce();
}

function setupEventListeners() {
  // Genre selector
  document.getElementById('genreSelector').addEventListener('click', e => {
    const btn = e.target.closest('.genre-btn');
    if (!btn) return;
    document.querySelectorAll('.genre-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    state.currentGenre = btn.dataset.genre;
    updateGenrePresets();
  });

  // Tabs
  document.getElementById('tabs').addEventListener('click', e => {
    const tab = e.target.closest('.tab');
    if (!tab) return;
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    const tabId = 'tab-' + tab.dataset.tab;
    document.getElementById(tabId).classList.add('active');
    state.currentTab = tab.dataset.tab;
  });

  // Transport
  document.getElementById('playBtn').addEventListener('click', togglePlay);
  document.getElementById('stopBtn').addEventListener('click', stop);
  document.getElementById('exportBtn').addEventListener('click', exportAudio);

  // BPM
  document.getElementById('bpmSlider').addEventListener('input', e => {
    state.bpm = parseInt(e.target.value, 10);
    Tone.Transport.bpm.value = state.bpm;
    document.getElementById('bpmValue').textContent = state.bpm;
  });

  // Swing (now actually applied)
  document.getElementById('swingSlider').addEventListener('input', e => {
    state.swing = parseInt(e.target.value, 10);
    document.getElementById('swingValue').textContent = state.swing + '%';
    Tone.Transport.swing = state.swing / 100;
    Tone.Transport.swingSubdivision = '8n';
  });

  // Duration/Complexity/Humanize
  document.getElementById('durSlider').addEventListener('input', e => {
    state.duration = parseInt(e.target.value, 10);
    document.getElementById('durValue').textContent = state.duration + ' min';
    document.getElementById('durationDisplay').textContent =
      '/ ' + String(state.duration).padStart(2, '0') + ':00';
  });
  document.getElementById('complexSlider').addEventListener('input', e => {
    state.complexity = parseInt(e.target.value, 10);
    const labels = ['Simple', 'Medium', 'Complex'];
    document.getElementById('complexValue').textContent = labels[state.complexity - 1];
  });
  document.getElementById('humanSlider').addEventListener('input', e => {
    state.humanize = parseInt(e.target.value, 10);
    document.getElementById('humanValue').textContent = state.humanize + 'ms';
  });

  // Generate
  document.getElementById('generateBtn').addEventListener('click', generateBeat);
  document.getElementById('randomVelBtn').addEventListener('click', randomizeVelocity);
  document.getElementById('randomProbBtn').addEventListener('click', randomizeProbability);
  document.getElementById('clearBtn').addEventListener('click', clearPattern);

  // Add melodic generator button next to Generate
  const melodicGenBtn = document.createElement('button');
  melodicGenBtn.className = 'btn btn-primary';
  melodicGenBtn.innerHTML = '🎼 Generate Melody';
  melodicGenBtn.addEventListener('click', generateMelodicPatterns);
  document.getElementById('generateBtn').parentElement.appendChild(melodicGenBtn);

  // Sequencer length & resolution
  document.getElementById('lenDecBtn').addEventListener('click', () => {
    state.sequenceLength = Math.max(4, state.sequenceLength - 4);
    renderSequencer();
  });
  document.getElementById('lenIncBtn').addEventListener('click', () => {
    state.sequenceLength = Math.min(32, state.sequenceLength + 4);
    renderSequencer();
  });
  document.getElementById('resSelect').addEventListener('change', e => {
    state.resolution = e.target.value;
  });
  document.getElementById('euclidBtn').addEventListener('click', applyEuclidean);
  document.getElementById('ghostBtn').addEventListener('click', addGhostNotes);

  // Master controls
  document.getElementById('masterVolSlider').addEventListener('input', e => {
    state.masterVolume = parseInt(e.target.value, 10);
    document.getElementById('masterVolValue').textContent = state.masterVolume + 'dB';
    Tone.Destination.volume.value = state.masterVolume;
  });
  document.getElementById('tapeSlider').addEventListener('input', e => {
    state.tapeSaturation = parseInt(e.target.value, 10);
    document.getElementById('tapeValue').textContent = state.tapeSaturation + '%';
  });
  document.getElementById('vinylSlider').addEventListener('input', e => {
    state.vinylNoise = parseInt(e.target.value, 10);
    document.getElementById('vinylValue').textContent = state.vinylNoise + '%';
  });
  document.getElementById('lowCutSlider').addEventListener('input', e => {
    state.lowCut = parseInt(e.target.value, 10);
    document.getElementById('lowCutValue').textContent = state.lowCut + 'Hz';
  });
  document.getElementById('highCutSlider').addEventListener('input', e => {
    state.highCut = parseInt(e.target.value, 10);
    document.getElementById('highCutValue').textContent = (state.highCut / 1000).toFixed(1) + 'kHz';
  });
  document.getElementById('compSlider').addEventListener('input', e => {
    state.compressor = parseInt(e.target.value, 10);
    document.getElementById('compValue').textContent = state.compressor + 'dB';
  });

  // Harmony
  document.getElementById('keySelect').addEventListener('change', e => { state.key = e.target.value; updateChords(); });
  document.getElementById('scaleSelect').addEventListener('change', e => { state.scale = e.target.value; updateChords(); });
  document.getElementById('octaveSelect').addEventListener('change', e => { state.octave = parseInt(e.target.value, 10); });
  document.getElementById('genProgBtn').addEventListener('click', generateProgression);
  document.getElementById('clearProgBtn').addEventListener('click', () => { state.progression = []; renderProgression(); });
  document.querySelectorAll('[data-prog]').forEach(btn => btn.addEventListener('click', e => loadProgressionTemplate(e.currentTarget.dataset.prog)));

  // Project management
  document.getElementById('saveBtn').addEventListener('click', saveProject);
  document.getElementById('loadBtn').addEventListener('click', loadProject);

  // Keyboard shortcuts
  document.addEventListener('keydown', e => {
    if (e.code === 'Space') { e.preventDefault(); togglePlay(); }
    else if (e.code === 'KeyS') { e.preventDefault(); stop(); }
    else if (e.code === 'KeyE') { e.preventDefault(); exportAudio(); }
  });

  // ---- Delegated handlers (fix "only first toggle works") ----
  // Sequencer
  const seqGrid = document.getElementById('seqGrid');
  seqGrid.addEventListener('click', (e) => {
    const stepEl = e.target.closest('.step');
    if (stepEl) {
      const inst = stepEl.dataset.inst;
      const i = parseInt(stepEl.dataset.step, 10);
      toggleStep(inst, i, e);
      return;
    }
    const icon = e.target.closest('.seq-icon');
    if (icon) {
      const inst = icon.dataset.inst;
      const action = icon.dataset.action;
      if (action === 'mute') instruments[inst].mute = !instruments[inst].mute;
      else if (action === 'solo') instruments[inst].solo = !instruments[inst].solo;
      else if (action === 'note') openNoteEditor(inst);
      renderSequencer();
    }
  });

  // Mixer
  const mixerGrid = document.getElementById('mixerGrid');
  mixerGrid.addEventListener('click', (e) => {
    const btn = e.target.closest('.channel-btn');
    if (!btn) return;
    const inst = btn.dataset.inst;
    const action = btn.dataset.action;
    if (action === 'mute') instruments[inst].mute = !instruments[inst].mute;
    if (action === 'solo') instruments[inst].solo = !instruments[inst].solo;
    renderMixer();
    renderSequencer();
  });
  mixerGrid.addEventListener('input', (e) => {
    const slider = e.target;
    if (slider.type !== 'range') return;
    const inst = slider.dataset.inst;
    const param = slider.dataset.param;
    const value = parseFloat(slider.value);
    instruments[inst][param] = value;

    if (param === 'volume' && instruments[inst].channel) {
      instruments[inst].channel.volume.value = value;
    } else if (param === 'pan' && instruments[inst].channel) {
      instruments[inst].channel.pan.value = value / 100;
    }

    const parent = slider.closest('.param-control');
    const valEl = parent.querySelector('.param-value');
    if (param === 'volume') valEl.textContent = value + 'dB';
    if (param === 'pan') valEl.textContent = (value>0?'R':value<0?'L':'C') + Math.abs(value);
  });

  // FX
  const fxGrid = document.getElementById('fxGrid');
  fxGrid.addEventListener('click', (e) => {
    const t = e.target.closest('.fx-toggle');
    if (!t) return;
    const fx = t.dataset.fx;
    fxConfig[fx].active = !fxConfig[fx].active;
    if (effects[fx] && effects[fx].wet) {
      effects[fx].wet.value = fxConfig[fx].active ? 0.5 : 0;
    }
    renderFX();
  });
  fxGrid.addEventListener('input', (e) => {
    if (e.target.type !== 'range') return;
    const fx = e.target.dataset.fx;
    const param = e.target.dataset.param;
    const raw = parseInt(e.target.value, 10);
    const val = mapFxParam(param, raw);
    fxConfig[fx][param] = val;
    applyFxParam(fx, param, val);
    // reflect label
    const label = e.target.closest('.param-control').querySelector('.param-value');
    label.textContent = formatFxDisplay(param, val);
  });
}

// -------------------- Helpers for FX sliders --------------------
function mapFxParam(param, raw) {
  // raw 0..100
  if (param === 'decay') return raw / 20;                 // 0..5 s
  if (param === 'wet') return raw / 100;                  // 0..1
  if (param === 'time') return ['16n','8n','4n','2n'][Math.min(3, Math.floor(raw/25))];
  if (param === 'feedback') return raw / 100;             // 0..1
  if (param === 'frequency') return 100 + raw * 79;       // 100..8000 Hz (linear)
  if (param === 'depth' || param === 'amount') return raw / 100; // 0..1
  if (param === 'octaves') return Math.floor(raw/20) + 1; // 1..6
  return raw / 50;
}
function applyFxParam(fx, param, val) {
  const node = effects[fx];
  if (!node) return;
  if (param === 'decay' && node.decay !== undefined) node.decay = val;
  if (param === 'wet' && node.wet) node.wet.value = val;
  if (param === 'time' && node.delayTime) node.delayTime.value = Tone.Time(val);
  if (param === 'feedback' && node.feedback) node.feedback.value = val;
  if (param === 'frequency' && node.frequency) node.frequency.value = val;
  if (param === 'depth' && node.depth !== undefined) node.depth = val;
  if (param === 'amount' && node.distortion !== undefined) node.distortion = val;
  if (param === 'octaves' && node.octaves !== undefined) node.octaves = val;
}
function formatFxDisplay(param, val) {
  if (param === 'wet' || param === 'feedback' || param === 'depth' || param === 'amount')
    return Math.round(val*100) + '%';
  if (param === 'decay') return val.toFixed(2) + 's';
  if (param === 'time') return String(val);
  if (param === 'frequency') return Math.round(val) + 'Hz';
  if (param === 'octaves') return val + ' oct';
  return String(val);
}

// -------------------- Sequencer Rendering (no inline listeners) --------------------
function renderSequencer() {
  const grid = document.getElementById('seqGrid');
  grid.innerHTML = '';

  Object.keys(instruments).forEach(inst => {
    const instData = instruments[inst];
    const row = document.createElement('div');
    row.className = 'seq-row';

    const label = document.createElement('div');
    label.className = 'seq-label';
    label.innerHTML = `
      <span>${instData.icon} ${instData.name}</span>
      <div class="seq-icons">
        <button class="seq-icon ${instData.mute ? 'active' : ''}" data-inst="${inst}" data-action="mute">M</button>
        <button class="seq-icon ${instData.solo ? 'active' : ''}" data-inst="${inst}" data-action="solo">S</button>
        ${instData.type === 'melodic' ? `<button class="seq-icon" data-inst="${inst}" data-action="note">🎵</button>` : ''}
      </div>
    `;
    row.appendChild(label);

    for (let i = 0; i < state.sequenceLength; i++) {
      const cell = document.createElement('div');
      cell.className = 'step';
      cell.dataset.inst = inst;
      cell.dataset.step = i;

      const pat = patterns[inst][i];
      if (pat.active) {
        cell.classList.add('active');

        const top = document.createElement('div');
        top.className = 'step-prob';
        if (instData.type === 'melodic' && pat.note) {
          top.textContent = pat.note;
          top.style.fontSize = '0.6rem';
        } else {
          top.textContent = pat.probability + '%';
        }
        cell.appendChild(top);

        const vel = document.createElement('div');
        vel.className = 'step-vel';
        vel.innerHTML = `<div class="step-vel-fill" style="width:${Math.round((pat.velocity||0)*100)}%"></div>`;
        cell.appendChild(vel);
      }
      row.appendChild(cell);
    }
    grid.appendChild(row);
  });
}

function openNoteEditor(inst) {
  const currentNote = instruments[inst].note || 'C4';
  const newNote = prompt(`Enter note for ${instruments[inst].name} (e.g., C4, D#3, F5):\n\nCurrent: ${currentNote}`, currentNote);
  if (newNote && /^[A-G]#?[1-6]$/.test(newNote)) {
    instruments[inst].note = newNote;
    patterns[inst].forEach(step => {
      if (step.active && !step.note) step.note = newNote;
    });
    renderSequencer();
  }
}

function toggleStep(inst, step, e) {
  const pattern = patterns[inst][step];
  const instData = instruments[inst];

  if (e.altKey) {
    if (pattern.active) {
      pattern.velocity = Math.min(1, (pattern.velocity || 0.8) + 0.2);
      if (pattern.velocity > 1) pattern.velocity = 0.4;
    }
  } else if (e.shiftKey) {
    if (pattern.active) {
      if (instData.type === 'melodic') {
        cycleNote(inst, step);
      } else {
        pattern.probability = Math.min(100, pattern.probability + 25);
        if (pattern.probability > 100) pattern.probability = 50;
      }
    }
  } else if (e.ctrlKey || e.metaKey) {
    if (instData.type === 'melodic' && pattern.active) {
      const newNote = prompt(`Enter note (e.g., C4, D#3):`, pattern.note || instData.note);
      if (newNote && /^[A-G]#?[1-6]$/.test(newNote)) pattern.note = newNote;
    }
  } else {
    pattern.active = !pattern.active;
    if (pattern.active) {
      pattern.velocity = 0.8;
      pattern.probability = 100;
      if (instData.type === 'melodic') {
        pattern.note = instData.note;
        pattern.duration = '8n';
      }
    }
  }
  renderSequencer();
}

function cycleNote(inst, stepIndex) {
  const pattern = patterns[inst][stepIndex];
  const scaleIntervals = scales[state.scale];
  const keyIndex = keysArr.indexOf(state.key);

  const currentNote = pattern.note || instruments[inst].note;
  const m = currentNote.match(/^([A-G]#?)(\d+)$/);
  if (!m) return;
  const [, noteName, octave] = m;

  const scaleNotes = scaleIntervals.map(iv => keysArr[(keyIndex + iv) % 12]);
  const idx = scaleNotes.indexOf(noteName);
  const next = scaleNotes[(idx + 1 + scaleNotes.length) % scaleNotes.length] + octave;
  pattern.note = next;
}

function updateStepVisuals(step) {
  document.querySelectorAll('.step').forEach((el, idx) => {
    el.classList.toggle('playing', (idx % state.sequenceLength) === step);
  });
}

// -------------------- Pattern Generators --------------------
function generateBeat() {
  const preset = genrePresets[state.currentGenre];
  if (!preset) return;

  Object.keys(instruments).forEach(inst => {
    const pat = preset.patterns[inst];
    const notes = preset.notes ? preset.notes[inst] : null;
    if (pat) {
      pat.forEach((val, i) => {
        if (i < state.sequenceLength) {
          patterns[inst][i].active = val === 1;
          patterns[inst][i].velocity = 0.7 + Math.random() * 0.3;
          patterns[inst][i].probability = 100;
          if (instruments[inst].type === 'melodic' && notes && notes[i]) {
            patterns[inst][i].note = notes[i];
            patterns[inst][i].duration = '8n';
          }
        }
      });
    }
  });

  if (state.complexity >= 2) addVariations();
  if (state.complexity >= 3) addGhostNotes();

  state.bpm = preset.bpm;
  document.getElementById('bpmSlider').value = preset.bpm;
  Tone.Transport.bpm.value = preset.bpm;
  document.getElementById('bpmValue').textContent = preset.bpm;

  renderSequencer();
}

function addVariations() {
  Object.keys(instruments).forEach(inst => {
    for (let i = 0; i < state.sequenceLength; i++) {
      if (Math.random() < 0.2 && !patterns[inst][i].active) {
        patterns[inst][i].active = true;
        patterns[inst][i].velocity = 0.4 + Math.random() * 0.3;
        patterns[inst][i].probability = 50 + Math.random() * 50;
      }
    }
  });
}

function addGhostNotes() {
  ['snare', 'hihat', 'rimshot'].forEach(inst => {
    for (let i = 0; i < state.sequenceLength; i++) {
      if (Math.random() < 0.15 && !patterns[inst][i].active) {
        patterns[inst][i].active = true;
        patterns[inst][i].velocity = 0.2 + Math.random() * 0.2;
        patterns[inst][i].probability = 60 + Math.random() * 40;
      }
    }
  });
  renderSequencer();
}

function randomizeVelocity() {
  Object.keys(instruments).forEach(inst => {
    patterns[inst].forEach(step => { if (step.active) step.velocity = 0.5 + Math.random() * 0.5; });
  });
  renderSequencer();
}

function randomizeProbability() {
  Object.keys(instruments).forEach(inst => {
    patterns[inst].forEach(step => { if (step.active) step.probability = 50 + Math.floor(Math.random() * 51); });
  });
  renderSequencer();
}

function clearPattern() {
  Object.keys(instruments).forEach(inst => {
    patterns[inst].forEach(step => {
      step.active = false; step.velocity = 0.8; step.probability = 100;
      step.note = instruments[inst].note; step.duration = '8n';
    });
  });
  renderSequencer();
}

function generateMelodicPatterns() {
  generateBassLine();
  generateKeyPattern();
  generateLeadMelody();
  renderSequencer();
}

function generateBassLine() {
  const scaleIntervals = scales[state.scale];
  const keyIndex = keysArr.indexOf(state.key);
  const root = state.key;
  const octave = 2;

  const bassNotes = [
    root + octave,
    keysArr[(keyIndex + scaleIntervals[4]) % 12] + octave,
    root + (octave + 1),
    keysArr[(keyIndex + scaleIntervals[3]) % 12] + octave
  ];

  const density = state.complexity === 1 ? 4 : state.complexity === 2 ? 6 : 8;

  for (let i = 0; i < state.sequenceLength; i++) {
    if (i % (16 / density) === 0 || (state.complexity >= 3 && Math.random() < 0.3)) {
      patterns.bass[i].active = true;
      patterns.bass[i].note = bassNotes[Math.floor(i / 4) % bassNotes.length];
      patterns.bass[i].velocity = 0.7 + Math.random() * 0.3;
      patterns.bass[i].duration = '8n';
      patterns.bass[i].probability = 100;
    }
  }
}

function generateKeyPattern() {
  const scaleIntervals = scales[state.scale];
  const keyIndex = keysArr.indexOf(state.key);
  const octave = 4;

  const chords = [];
  for (let i = 0; i < 4; i++) {
    const degree = [0,3,4,0][i]; // I - IV - V - I
    const root = keysArr[(keyIndex + scaleIntervals[degree]) % 12];
    const third = keysArr[(keyIndex + scaleIntervals[(degree + 2) % scaleIntervals.length]) % 12];
    const fifth = keysArr[(keyIndex + scaleIntervals[(degree + 4) % scaleIntervals.length]) % 12];
    chords.push([root + octave, third + octave, fifth + octave]);
  }

  for (let i = 0; i < state.sequenceLength; i++) {
    if (i % 4 === 0) {
      const idx = Math.floor(i / 4) % chords.length;
      patterns.keys[i].active = true;
      patterns.keys[i].note = chords[idx];
      patterns.keys[i].velocity = 0.6 + Math.random() * 0.2;
      patterns.keys[i].duration = '2n';
      patterns.keys[i].probability = 100;
    }
  }
}

function generateLeadMelody() {
  const scaleIntervals = scales[state.scale];
  const keyIndex = keysArr.indexOf(state.key);
  const octave = 5;

  const scaleNotes = scaleIntervals.map(iv => keysArr[(keyIndex + iv) % 12] + octave);
  const extended = [...scaleNotes, ...scaleIntervals.map(iv => keysArr[(keyIndex + iv) % 12] + (octave + 1))];

  let lastIdx = 0;
  const density = state.complexity === 1 ? 4 : state.complexity === 2 ? 6 : 10;

  for (let i = 0; i < state.sequenceLength; i++) {
    if (Math.random() < (density / 16)) {
      const jump = Math.random() < 0.7 ? (Math.random() < 0.5 ? 1 : -1) : (Math.floor(Math.random() * 5) - 2);
      lastIdx = Math.max(0, Math.min(extended.length - 1, lastIdx + jump));
      patterns.lead[i].active = true;
      patterns.lead[i].note = extended[lastIdx];
      patterns.lead[i].velocity = 0.6 + Math.random() * 0.4;
      patterns.lead[i].duration = Math.random() < 0.7 ? '8n' : '16n';
      patterns.lead[i].probability = Math.random() < 0.8 ? 100 : 75;
    }
  }
}

function applyEuclidean() {
  const insts = Object.keys(instruments);
  const inst = insts[Math.floor(Math.random() * insts.length)];
  const hits = Math.floor(Math.random() * 8) + 3;
  const steps = state.sequenceLength;

  const pat = generateEuclidean(hits, steps);
  pat.forEach((v, i) => {
    patterns[inst][i].active = v === 1;
    if (v === 1) {
      patterns[inst][i].velocity = 0.7 + Math.random() * 0.3;
      patterns[inst][i].probability = 100;
    }
  });
  renderSequencer();
}
function generateEuclidean(hits, steps) {
  const res = Array(steps).fill(0);
  const bucket = [];
  for (let i = 0; i < steps; i++) bucket.push(Math.floor((i * hits) / steps));
  for (let i = 0; i < steps; i++) if (i === 0 || bucket[i] !== bucket[i - 1]) res[i] = 1;
  return res;
}

// -------------------- Mixer Rendering (no inline listeners) --------------------
function renderMixer() {
  const grid = document.getElementById('mixerGrid');
  grid.innerHTML = '';

  Object.keys(instruments).forEach(inst => {
    const ch = document.createElement('div');
    ch.className = 'mixer-channel';
    ch.innerHTML = `
      <div class="channel-header">
        <div class="channel-name">${instruments[inst].icon} ${instruments[inst].name}</div>
        <div class="channel-btns">
          <button class="channel-btn mute ${instruments[inst].mute ? 'active' : ''}" data-inst="${inst}" data-action="mute">M</button>
          <button class="channel-btn solo ${instruments[inst].solo ? 'active' : ''}" data-inst="${inst}" data-action="solo">S</button>
        </div>
      </div>
      <div class="param-control">
        <div class="param-label">
          <span>Volume</span>
          <span class="param-value">${instruments[inst].volume}dB</span>
        </div>
        <input type="range" min="-40" max="10" value="${instruments[inst].volume}" data-inst="${inst}" data-param="volume">
      </div>
      <div class="param-control">
        <div class="param-label">
          <span>Pan</span>
          <span class="param-value">${instruments[inst].pan > 0 ? 'R' : instruments[inst].pan < 0 ? 'L' : 'C'}${Math.abs(instruments[inst].pan)}</span>
        </div>
        <input type="range" min="-100" max="100" value="${instruments[inst].pan}" data-inst="${inst}" data-param="pan">
      </div>
    `;
    grid.appendChild(ch);
  });
}

// -------------------- FX Rack Rendering (no inline listeners) --------------------
function renderFX() {
  const grid = document.getElementById('fxGrid');
  grid.innerHTML = '';

  Object.keys(fxConfig).forEach(fx => {
    const unit = document.createElement('div');
    unit.className = 'fx-unit';
    const config = fxConfig[fx];
    const params = Object.keys(config).filter(k => k !== 'name' && k !== 'active');

    let paramsHTML = '';
    params.forEach(param => {
      const val = config[param];
      const display = formatFxDisplay(param, val);
      // Slider positions derived inversely from mapFxParam, approximate
      let sliderVal = 50;
      if (param === 'decay') sliderVal = Math.max(0, Math.min(100, Math.round(val * 20)));
      else if (param === 'wet' || param === 'feedback' || param === 'depth' || param === 'amount') sliderVal = Math.round(val * 100);
      else if (param === 'time') sliderVal = { '16n': 0, '8n': 33, '4n': 66, '2n': 100 }[val] ?? 50;
      else if (param === 'frequency') sliderVal = Math.round((val - 100) / 79); // inverse of 100..8000
      else if (param === 'octaves') sliderVal = (val - 1) * 20;

      paramsHTML += `
        <div class="param-control">
          <div class="param-label">
            <span>${param}</span>
            <span class="param-value">${display}</span>
          </div>
          <input type="range" min="0" max="100" value="${sliderVal}" data-fx="${fx}" data-param="${param}">
        </div>
      `;
    });

    unit.innerHTML = `
      <div class="fx-header">
        <div class="fx-name">${config.name}</div>
        <div class="fx-toggle ${config.active ? 'active' : ''}" data-fx="${fx}"></div>
      </div>
      ${paramsHTML}
    `;
    grid.appendChild(unit);
  });
}

// -------------------- Harmony --------------------
function renderHarmony() {
  const keySelect = document.getElementById('keySelect');
  keySelect.innerHTML = keysArr.map(k => `<option value="${k}" ${k===state.key?'selected':''}>${k}</option>`).join('');

  const scaleSelect = document.getElementById('scaleSelect');
  scaleSelect.innerHTML = Object.keys(scales).map(s => `<option value="${s}" ${s===state.scale?'selected':''}>${s}</option>`).join('');

  const octaveSelect = document.getElementById('octaveSelect');
  octaveSelect.innerHTML = [2,3,4,5,6].map(o => `<option value="${o}" ${o===state.octave?'selected':''}>${o}</option>`).join('');

  updateChords();
}

function updateChords() {
  const chordChips = document.getElementById('chordChips');
  chordChips.innerHTML = '';

  const keyIndex = keysArr.indexOf(state.key);
  const scaleIntervals = scales[state.scale];

  const chords = [];
  scaleIntervals.forEach((interval, i) => {
    const root = keysArr[(keyIndex + interval) % 12];
    const third = scaleIntervals[(i + 2) % scaleIntervals.length];
    const thirdInterval = (third - interval + 12) % 12;
    const type = thirdInterval === 3 ? 'minor' : thirdInterval === 4 ? 'major' : 'dim';
    chords.push({ root, type, roman: ['I','II','III','IV','V','VI','VII'][i] });
  });

  chords.forEach(chord => {
    const chip = document.createElement('div');
    chip.className = 'chip';
    chip.textContent = `${chord.roman} - ${chord.root}${chord.type==='minor'?'m':chord.type==='dim'?'°':''}`;
    chip.addEventListener('click', () => { state.progression.push(chord); renderProgression(); });
    chordChips.appendChild(chip);
  });
}

function renderProgression() {
  const wrap = document.getElementById('progressionChips');
  wrap.innerHTML = '';
  if (!state.progression.length) {
    wrap.innerHTML = '<div style="color: var(--text-muted); font-size: 0.9rem;">Click chords above to build progression</div>';
    return;
  }
  state.progression.forEach((chord, idx) => {
    const chip = document.createElement('div');
    chip.className = 'chip active';
    chip.textContent = `${chord.roman} - ${chord.root}${chord.type==='minor'?'m':chord.type==='dim'?'°':''}`;
    chip.addEventListener('click', () => { state.progression.splice(idx, 1); renderProgression(); });
    wrap.appendChild(chip);
  });
}

function generateProgression() {
  const keyIndex = keysArr.indexOf(state.key);
  const scaleIntervals = scales[state.scale];
  const templates = [
    [0,3,4,0], [0,5,3,4], [1,4,0], [0,4,5,3]
  ];
  const tpl = templates[Math.floor(Math.random()*templates.length)];
  state.progression = [];

  tpl.forEach(degree => {
    const interval = scaleIntervals[degree];
    const root = keysArr[(keyIndex + interval) % 12];
    const third = scaleIntervals[(degree + 2) % scaleIntervals.length];
    const thirdInterval = (third - interval + 12) % 12;
    const type = thirdInterval === 3 ? 'minor' : thirdInterval === 4 ? 'major' : 'dim';
    state.progression.push({ root, type, roman: ['I','II','III','IV','V','VI','VII'][degree] });
  });

  renderProgression();
}

function loadProgressionTemplate(name) {
  const t = {
    'ii-v-i': [{root:'D',type:'minor',roman:'II'},{root:'G',type:'major',roman:'V'},{root:'C',type:'major',roman:'I'}],
    'lofi':   [{root:'C',type:'major',roman:'I'},{root:'A',type:'minor',roman:'VI'},{root:'F',type:'major',roman:'IV'},{root:'G',type:'major',roman:'V'}],
    'neosoul':[ {root:'D',type:'minor',roman:'II'},{root:'E',type:'minor',roman:'III'},{root:'A',type:'minor',roman:'VI'},{root:'D',type:'minor',roman:'II'}],
    'modal':  [{root:'D',type:'minor',roman:'I'},{root:'E',type:'minor',roman:'II'},{root:'F',type:'major',roman:'III'},{root:'G',type:'major',roman:'IV'}]
  };
  state.progression = t[name] || [];
  renderProgression();
}

// -------------------- Presets Grid --------------------
function renderPresets() {
  const grid = document.getElementById('presetGrid');
  grid.innerHTML = '';
  Object.keys(genrePresets).forEach(genre => {
    const preset = genrePresets[genre];
    const div = document.createElement('div');
    div.className = 'preset';
    div.innerHTML = `<div class="preset-icon">${preset.icon}</div><div class="preset-name">${preset.name}</div>`;
    div.addEventListener('click', () => loadPreset(genre));
    grid.appendChild(div);
  });
}
function loadPreset(genre) {
  state.currentGenre = genre;
  document.querySelectorAll('.genre-btn').forEach(b => b.classList.toggle('active', b.dataset.genre === genre));
  generateBeat();
}
function updateGenrePresets(){ renderPresets(); }

// -------------------- Transport --------------------
async function togglePlay() {
  if (state.isPlaying) {
    Tone.Transport.pause();
    state.isPlaying = false;
    document.getElementById('playBtn').innerHTML = '▶️ Play';
  } else {
    await Tone.start();
    Tone.Transport.start();
    state.isPlaying = true;
    document.getElementById('playBtn').innerHTML = '⏸️ Pause';
    startTimer();
    document.getElementById('vizOverlay').style.display = 'none';
  }
}
function stop() {
  Tone.Transport.stop();
  state.isPlaying = false;
  state.currentStep = 0;
  document.getElementById('playBtn').innerHTML = '▶️ Play';
  document.getElementById('timeDisplay').textContent = '00:00';
  document.getElementById('progressFill').style.width = '0%';
  document.querySelectorAll('.step').forEach(el => el.classList.remove('playing'));
  stopTimer();
}

// Timer
let timerInterval;
function startTimer() {
  stopTimer();
  timerInterval = setInterval(() => {
    const seconds = Tone.Transport.seconds;
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    document.getElementById('timeDisplay').textContent =
      String(mins).padStart(2,'0') + ':' + String(secs).padStart(2,'0');
    const total = state.duration * 60;
    const progress = (seconds / total) * 100;
    document.getElementById('progressFill').style.width = Math.min(100, progress) + '%';
  }, 100);
}
function stopTimer() { if (timerInterval) { clearInterval(timerInterval); timerInterval = null; } }

// -------------------- Visualizer (lighter DOM work) --------------------
function initVisualizerOnce(){
  const viz = document.getElementById('visualizer');
  if (viz.dataset.ready) return;
  viz.dataset.ready = '1';
  for (let i = 0; i < 32; i++) {
    const bar = document.createElement('div');
    bar.className = 'viz-bar';
    bar.style.left = (i * 100 / 32) + '%';
    bar.style.height = '10%';
    viz.appendChild(bar);
  }
}
function updateVisualizer() {
  const viz = document.getElementById('visualizer');
  const bars = viz.querySelectorAll('.viz-bar');
  bars.forEach(bar => {
    bar.style.height = (Math.random() * 60 + 10) + '%';
  });
}

// -------------------- Project Save/Load --------------------
function saveProject() {
  const projectName = document.getElementById('projectName').value || 'Untitled';
  const project = {
    name: projectName, state, patterns, instruments, timestamp: Date.now()
  };
  const json = JSON.stringify(project, null, 2);
  const blob = new Blob([json], { type:'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `${projectName.replace(/\s+/g,'_')}.prostudio.json`;
  a.click();
  URL.revokeObjectURL(url);
  alert('✅ Project saved!');
}

function loadProject() {
  const input = document.createElement('input');
  input.type = 'file'; input.accept = '.json,.prostudio.json';
  input.onchange = e => {
    const file = e.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      try {
        const project = JSON.parse(ev.target.result);
        Object.assign(state, project.state);
        Object.keys(patterns).forEach(k => delete patterns[k]);
        Object.assign(patterns, project.patterns);
        Object.assign(instruments, project.instruments);
        document.getElementById('projectName').value = project.name;
        updateAllDisplays();
        renderSequencer();
        renderMixer();
        alert('✅ Project loaded!');
      } catch (err) {
        alert('❌ Error loading project: ' + err.message);
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

function updateAllDisplays() {
  document.getElementById('bpmSlider').value = state.bpm;
  document.getElementById('bpmValue').textContent = state.bpm;
  document.getElementById('swingSlider').value = state.swing;
  document.getElementById('swingValue').textContent = state.swing + '%';
  document.getElementById('durSlider').value = state.duration;
  document.getElementById('durValue').textContent = state.duration + ' min';
  document.getElementById('durationDisplay').textContent = '/ ' + String(state.duration).padStart(2,'0') + ':00';
  document.getElementById('complexSlider').value = state.complexity;
  document.getElementById('complexValue').textContent = ['Simple','Medium','Complex'][state.complexity-1];
  document.getElementById('humanSlider').value = state.humanize;
  document.getElementById('humanValue').textContent = state.humanize + 'ms';
  Tone.Transport.bpm.value = state.bpm;
  Tone.Transport.swing = state.swing / 100;
  Tone.Transport.swingSubdivision = '8n';
}

// -------------------- Export (Offline render + save dialog) --------------------
async function exportAudio() {
  let hasActive = false;
  Object.keys(patterns).forEach(inst => {
    if (patterns[inst].some(s => s.active)) hasActive = true;
  });
  if (!hasActive) { alert('❌ No active notes! Please create a pattern first.'); return; }

  const exportDuration = state.duration * 60;
  alert('🎵 Rendering audio...');

  try {
    const buffer = await Tone.Offline(async ({ transport }) => {
      // Recreate chain in Offline context
      const fx = {
        filter: new Tone.Filter(fxConfig.filter.frequency, fxConfig.filter.type),
        distortion: new Tone.Distortion(fxConfig.distortion.amount),
        chorus: new Tone.Chorus(1.5, 2.5, fxConfig.chorus.depth).start(),
        phaser: new Tone.Phaser({ frequency: fxConfig.phaser.frequency, octaves: fxConfig.phaser.octaves, baseFrequency: 350 }),
        delay: new Tone.FeedbackDelay(fxConfig.delay.time, fxConfig.delay.feedback),
        reverb: new Tone.Reverb(fxConfig.reverb.decay)
      };
      Object.keys(fx).forEach(k => { if (fx[k].wet) fx[k].wet.value = fxConfig[k]?.active ? 0.5 : 0; });

      const offlineMaster = new Tone.Gain(1);
      const comp = new Tone.Compressor(-18, 3);
      const lim = new Tone.Limiter(-1);

      offlineMaster.chain(fx.filter, fx.distortion, fx.chorus, fx.phaser, fx.delay, fx.reverb, comp, lim, Tone.Destination);

      const exSynths = {};
      const exChannels = {};
      Object.keys(instruments).forEach(inst => {
        const data = instruments[inst];
        // synths
        if (data.type === 'drum') {
          if (inst === 'kick') {
            exSynths[inst] = new Tone.MembraneSynth({ pitchDecay:0.08, octaves:8, oscillator:{type:'sine'}, envelope:{attack:0.001,decay:0.4,sustain:0.01,release:1.4}});
          } else if (inst === 'snare' || inst === 'clap') {
            exSynths[inst] = new Tone.NoiseSynth({ noise:{type:'white'}, envelope:{attack:0.001,decay:0.2,sustain:0}});
          } else if (inst === 'hihat') {
            exSynths[inst] = new Tone.MetalSynth({ frequency:200, envelope:{attack:0.001,decay:0.1,release:0.01}, harmonicity:5.1, modulationIndex:32, resonance:4000, octaves:1.5 });
          } else {
            exSynths[inst] = new Tone.MembraneSynth({ pitchDecay:0.05, octaves:6, oscillator:{type:'sine'}, envelope:{attack:0.001,decay:0.4,sustain:0.01,release:1.4}});
          }
        } else {
          if (inst === 'bass') {
            exSynths[inst] = new Tone.MonoSynth({ oscillator:{type:'sawtooth'}, filter:{Q:2, type:'lowpass', rolloff:-24},
              envelope:{attack:0.01,decay:0.3,sustain:0.4,release:0.8},
              filterEnvelope:{attack:0.01,decay:0.2,sustain:0.3,release:0.5,baseFrequency:100,octaves:2.5} });
          } else if (inst === 'keys') {
            exSynths[inst] = new Tone.PolySynth(Tone.AMSynth, {
              harmonicity: 1.01,
              envelope: { attack: 0.02, decay: 0.4, sustain: 0.6, release: 1.5 },
              modulationEnvelope: { attack: 0.2, decay: 0.3, sustain: 0.2, release: 0.8 }
            });
          } else if (inst === 'lead') {
            exSynths[inst] = new Tone.FMSynth({
              modulationIndex: 6, oscillator:{type:'sine'},
              envelope:{attack:0.01,decay:0.25,sustain:0.5,release:0.8},
              modulation:{type:'triangle'}, modulationEnvelope:{attack:0.01,decay:0.2,sustain:0.3,release:0.7}
            });
          }
          exSynths[inst].volume.value = data.volume;
        }

        exChannels[inst] = new Tone.Channel({ pan: 0, volume: data.volume }).connect(offlineMaster);
        exSynths[inst].connect(exChannels[inst]);
      });

      transport.bpm.value = state.bpm;
      transport.swing = state.swing / 100;
      transport.swingSubdivision = '8n';

      new Tone.Sequence((time, step) => {
        Object.keys(instruments).forEach(inst => {
          const s = patterns[inst][step];
          if (!s.active) return;
          const d = instruments[inst];
          if (d.mute) return;
          const anySolo = Object.values(instruments).some(i => i.solo);
          if (anySolo && !d.solo) return;
          if (Math.random() * 100 > s.probability) return;

          const humanize = (Math.random() - 0.5) * (state.humanize / 1000);
          if (d.type === 'drum') {
            if (inst === 'kick') exSynths[inst].triggerAttackRelease('C1','8n',time+humanize,s.velocity);
            else if (inst === 'snare' || inst === 'clap') exSynths[inst].triggerAttackRelease('16n',time+humanize,s.velocity);
            else if (inst === 'hihat') exSynths[inst].triggerAttackRelease('16n',time+humanize,s.velocity*0.5);
            else exSynths[inst].triggerAttackRelease('C2','16n',time+humanize,s.velocity);
          } else {
            const note = s.note || d.note || 'C4';
            const dur = s.duration || '8n';
            exSynths[inst].triggerAttackRelease(note, dur, time+humanize, s.velocity);
          }
        });
      }, Array.from({length: state.sequenceLength}, (_, i) => i), state.resolution).start(0);

      transport.start();
    }, exportDuration);

    // Convert to WAV
    const wav = await bufferToWav(buffer);
    const blob = new Blob([wav], { type: 'audio/wav' });

    const projectName = (document.getElementById('projectName').value || 'beat').replace(/\s+/g,'_');
    const fileName = `${projectName}_${Date.now()}.wav`;

    if (window.showSaveFilePicker) {
      const handle = await showSaveFilePicker({
        suggestedName: fileName,
        types: [{ description: 'WAV file', accept: { 'audio/wav': ['.wav'] } }]
      });
      const writable = await handle.createWritable();
      await writable.write(blob);
      await writable.close();
    } else {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = fileName;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    alert('✅ Export complete! Your WAV file has been saved.');
  } catch (err) {
    console.error(err);
    alert('❌ Export error: ' + err.message);
  }
}

// Convert AudioBuffer to WAV (16-bit PCM)
function bufferToWav(buffer) {
  const numChannels = buffer.numberOfChannels;
  const sampleRate = buffer.sampleRate;
  const bitDepth = 16;

  const bytesPerSample = bitDepth / 8;
  const blockAlign = numChannels * bytesPerSample;

  const data = [];
  for (let i = 0; i < numChannels; i++) data.push(buffer.getChannelData(i));

  const dataLength = data[0].length * numChannels * bytesPerSample;
  const arrayBuffer = new ArrayBuffer(44 + dataLength);
  const view = new DataView(arrayBuffer);

  writeString(view, 0, 'RIFF');
  view.setUint32(4, 36 + dataLength, true);
  writeString(view, 8, 'WAVE');
  writeString(view, 12, 'fmt ');
  view.setUint32(16, 16, true);
  view.setUint16(20, 1, true); // PCM
  view.setUint16(22, numChannels, true);
  view.setUint32(24, sampleRate, true);
  view.setUint32(28, sampleRate * blockAlign, true);
  view.setUint16(32, blockAlign, true);
  view.setUint16(34, bitDepth, true);
  writeString(view, 36, 'data');
  view.setUint32(40, dataLength, true);

  let offset = 44;
  for (let i = 0; i < data[0].length; i++) {
    for (let ch = 0; ch < numChannels; ch++) {
      const sample = Math.max(-1, Math.min(1, data[ch][i]));
      view.setInt16(offset, sample < 0 ? sample * 0x8000 : sample * 0x7FFF, true);
      offset += 2;
    }
  }
  return arrayBuffer;
}
function writeString(view, offset, str) {
  for (let i = 0; i < str.length; i++) view.setUint8(offset + i, str.charCodeAt(i));
}

// -------------------- PWA Install (unchanged) --------------------
let deferredPrompt;
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredPrompt = e;
  document.getElementById('installBtn').hidden = false;
});
document.getElementById('installBtn').addEventListener('click', async () => {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;
  if (outcome === 'accepted') document.getElementById('installBtn').hidden = true;
  deferredPrompt = null;
});

// -------------------- Initialize --------------------
document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>
