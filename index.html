<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="theme-color" content="#000000"/>
  <title>8-Beat Studio</title>
  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="./8beat.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <style>
   /* =========================================================
  8-BEAT STUDIO — PROFESSIONAL ULTRA-MODERN REDESIGN
  Premium glassmorphic design with advanced micro-interactions
  Responsive grid system • Advanced animations • Pro gradients
========================================================= */

/* Professional Font Stack */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;600;700&display=swap');

/* -------- Design System Tokens -------- */
:root{
  /* Typography Scale */
  --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  --font-mono: 'JetBrains Mono', 'Courier New', monospace;
  
  --text-xs: clamp(0.7rem, 0.65rem + 0.25vw, 0.75rem);
  --text-sm: clamp(0.8rem, 0.75rem + 0.25vw, 0.875rem);
  --text-base: clamp(0.9rem, 0.85rem + 0.25vw, 1rem);
  --text-lg: clamp(1rem, 0.95rem + 0.25vw, 1.125rem);
  --text-xl: clamp(1.125rem, 1rem + 0.5vw, 1.25rem);
  --text-2xl: clamp(1.25rem, 1.125rem + 0.625vw, 1.5rem);
  --text-3xl: clamp(1.5rem, 1.25rem + 1vw, 2rem);
  --text-4xl: clamp(1.875rem, 1.5rem + 1.5vw, 2.5rem);

  /* Spacing System */
  --space-1: 0.25rem;
  --space-2: 0.5rem;
  --space-3: 0.75rem;
  --space-4: 1rem;
  --space-5: 1.25rem;
  --space-6: 1.5rem;
  --space-8: 2rem;
  --space-10: 2.5rem;
  --space-12: 3rem;
  --space-16: 4rem;
  
  /* Layout */
  --container-max: 1800px;
  --gutter: clamp(1rem, 3vw, 2rem);
  --sidebar-width: clamp(280px, 18vw, 340px);
  
  /* Border Radius System */
  --radius-xs: 6px;
  --radius-sm: 10px;
  --radius-md: 14px;
  --radius-lg: 18px;
  --radius-xl: 24px;
  --radius-2xl: 32px;
  --radius-full: 9999px;

  /* Professional Shadow System */
  --shadow-xs: 0 1px 2px rgba(0,0,0,.05);
  --shadow-sm: 0 2px 8px rgba(0,0,0,.08);
  --shadow-md: 0 4px 16px rgba(0,0,0,.12);
  --shadow-lg: 0 8px 32px rgba(0,0,0,.16);
  --shadow-xl: 0 12px 48px rgba(0,0,0,.22);
  --shadow-2xl: 0 20px 64px rgba(0,0,0,.32);
  --shadow-inner: inset 0 2px 8px rgba(0,0,0,.08);
  
  /* Glow Effects */
  --glow-sm: 0 0 20px;
  --glow-md: 0 0 40px;
  --glow-lg: 0 0 60px;

  /* Component Heights */
  --header-h: clamp(68px, 8vh, 80px);
  --tabs-h: clamp(52px, 6vh, 60px);
  --transport-h: clamp(88px, 10vh, 104px);

  /* Focus Ring */
  --ring-w: 3px;
  --ring-offset: 2px;
  --ring: rgba(180,190,255,.6);
  
  /* Glass Effects */
  --glass-border: rgba(255,255,255,.12);
  --glass-border-strong: rgba(255,255,255,.2);
  --glass-bg: rgba(255,255,255,.04);
  --glass-bg-strong: rgba(255,255,255,.08);

  /* Safe Areas */
  --inset-top: env(safe-area-inset-top, 0px);
  --inset-right: env(safe-area-inset-right, 0px);
  --inset-bottom: env(safe-area-inset-bottom, 0px);
  --inset-left: env(safe-area-inset-left, 0px);

  /* Animation Curves */
  --ease-smooth: cubic-bezier(0.4, 0, 0.2, 1);
  --ease-bounce: cubic-bezier(0.68, -0.55, 0.265, 1.55);
  --ease-elastic: cubic-bezier(0.68, -0.6, 0.32, 1.6);
  
  /* Transition Durations */
  --duration-fast: 150ms;
  --duration-base: 200ms;
  --duration-slow: 300ms;
  --duration-slower: 500ms;

  /* Default Theme (overridden by vibes) */
  --bg-primary: #0a0e1a;
  --bg-secondary: #0f1420;
  --bg-tertiary: #141824;
  
  --text-primary: #e9ecff;
  --text-secondary: #c8ccff;
  --text-tertiary: #9aa0c7;
  --text-muted: #6b7199;
  
  --accent-primary: #7c83ff;
  --accent-secondary: #8d6cff;
  --accent-tertiary: #9f7eff;
  
  --success: #22c55e;
  --warning: #f59e0b;
  --error: #ef4444;
  --info: #3b82f6;

  --surface: linear-gradient(135deg, rgba(255,255,255,.08) 0%, rgba(255,255,255,.04) 100%);
  --surface-elevated: linear-gradient(135deg, rgba(255,255,255,.12) 0%, rgba(255,255,255,.06) 100%);
}

/* -------- Premium Vibe Palettes -------- */
body[data-vibe="moon"]{
  --bg-primary: #0a0e1a;
  --bg-secondary: #0f1420;
  --bg-tertiary: #141824;
  --accent-primary: #7c83ff;
  --accent-secondary: #8d6cff;
  --accent-tertiary: #9f7eff;
  --text-primary: #e9ecff;
  --text-secondary: #cfd4ff;
  --text-tertiary: #a6acd6;
}

body[data-vibe="dawn"]{
  --bg-primary: #1a0e14;
  --bg-secondary: #221318;
  --bg-tertiary: #2a1820;
  --accent-primary: #ff8fb1;
  --accent-secondary: #ffb385;
  --accent-tertiary: #ffc799;
  --text-primary: #fff4f8;
  --text-secondary: #ffdfe9;
  --text-tertiary: #f2cbd8;
}

body[data-vibe="nebula"]{
  --bg-primary: #0b0d18;
  --bg-secondary: #0f0a1c;
  --bg-tertiary: #150f24;
  --accent-primary: #9a6bff;
  --accent-secondary: #33d1ff;
  --accent-tertiary: #66e0ff;
  --text-primary: #eaf5ff;
  --text-secondary: #cfe7ff;
  --text-tertiary: #a6c9e6;
}

body[data-vibe="forest"]{
  --bg-primary: #091312;
  --bg-secondary: #0b1418;
  --bg-tertiary: #0e1a1e;
  --accent-primary: #5de6a4;
  --accent-secondary: #86f7c1;
  --accent-tertiary: #a0ffd0;
  --text-primary: #e7fff5;
  --text-secondary: #c9ffe9;
  --text-tertiary: #a1d4c2;
}

body[data-vibe="sunset"]{
  --bg-primary: #1a0e0f;
  --bg-secondary: #221214;
  --bg-tertiary: #2a161a;
  --accent-primary: #ff7a59;
  --accent-secondary: #ffb86b;
  --accent-tertiary: #ffd699;
  --text-primary: #fff1eb;
  --text-secondary: #ffd9c9;
  --text-tertiary: #ffc6ae;
}

/* -------- Global Canvas -------- */
*, *::before, *::after{
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

html{
  font-size: 16px;
  height: 100%;
  scroll-behavior: smooth;
}

body{
  min-height: 100%;
  font-family: var(--font-sans);
  font-size: var(--text-base);
  font-weight: 400;
  line-height: 1.6;
  color: var(--text-primary);
  background: 
    radial-gradient(ellipse 1200px 800px at 15% -5%, 
      color-mix(in oklab, var(--accent-primary) 15%, transparent), 
      transparent 65%),
    radial-gradient(ellipse 1000px 700px at 85% 105%, 
      color-mix(in oklab, var(--accent-secondary) 12%, transparent), 
      transparent 65%),
    radial-gradient(ellipse 800px 600px at 50% 50%, 
      color-mix(in oklab, var(--accent-tertiary) 6%, transparent), 
      transparent 70%),
    linear-gradient(135deg, 
      var(--bg-primary) 0%, 
      var(--bg-secondary) 50%, 
      var(--bg-tertiary) 100%);
  background-attachment: fixed;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  text-rendering: optimizeLegibility;
  
  padding:
    calc(var(--space-4) + var(--inset-top))
    calc(var(--space-4) + var(--inset-right))
    calc(var(--space-4) + var(--inset-bottom))
    calc(var(--space-4) + var(--inset-left));
}

@media (display-mode: standalone){
  body{ 
    min-height: 100dvh;
    padding-top: calc(var(--space-6) + var(--inset-top));
  }
}

/* -------- Premium App Container -------- */
.app{
  max-width: var(--container-max);
  margin: 0 auto;
  display: grid;
  gap: var(--gutter);
  padding: clamp(var(--space-4), 2vw, var(--space-8));
  background: 
    linear-gradient(135deg, 
      color-mix(in oklab, var(--bg-secondary) 85%, transparent) 0%, 
      color-mix(in oklab, var(--bg-primary) 70%, transparent) 100%);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-2xl);
  box-shadow: 
    var(--shadow-2xl),
    inset 0 1px 0 rgba(255,255,255,.06),
    inset 0 -1px 0 rgba(0,0,0,.2);
  backdrop-filter: blur(32px) saturate(140%);
  position: relative;
  overflow: hidden;
  
  grid-template-columns: 1fr;
  grid-template-areas:
    "header"
    "main"
    "footer";
}

/* Ambient glow effect */
.app::before{
  content: '';
  position: absolute;
  inset: -50%;
  background: 
    radial-gradient(circle at 20% 30%, 
      color-mix(in oklab, var(--accent-primary) 8%, transparent), 
      transparent 40%),
    radial-gradient(circle at 80% 70%, 
      color-mix(in oklab, var(--accent-secondary) 6%, transparent), 
      transparent 40%);
  opacity: 0.6;
  animation: ambientPulse 8s ease-in-out infinite;
  pointer-events: none;
  z-index: 0;
}

@keyframes ambientPulse{
  0%, 100%{ transform: scale(1) rotate(0deg); opacity: 0.6; }
  50%{ transform: scale(1.1) rotate(5deg); opacity: 0.4; }
}

.app > *{
  position: relative;
  z-index: 1;
}

/* Sidebar Layout */
.app:has(.sidebar),
.app.with-sidebar{
  grid-template-columns: var(--sidebar-width) 1fr;
  grid-template-areas:
    "header header"
    "sidebar main"
    "footer footer";
  gap: var(--space-6);
}

header{ grid-area: header; }
.tabs{ grid-area: header; }
.transport{ grid-area: header; }
section.section{ grid-area: main; }
footer.footer{ grid-area: footer; }

/* -------- Premium Header -------- */
header{
  position: sticky;
  top: var(--space-4);
  z-index: 50;
  height: var(--header-h);
  display: grid;
  grid-template-columns: auto 1fr auto;
  gap: var(--space-4);
  align-items: center;
  padding: var(--space-4) var(--space-5);
  background: var(--surface-elevated);
  border: 1px solid var(--glass-border-strong);
  border-radius: var(--radius-xl);
  box-shadow: 
    var(--shadow-lg),
    inset 0 1px 0 rgba(255,255,255,.1);
  backdrop-filter: blur(24px) saturate(150%);
  transition: all var(--duration-base) var(--ease-smooth);
}

header:hover{
  border-color: color-mix(in oklab, var(--accent-primary) 30%, var(--glass-border-strong));
  box-shadow: 
    var(--shadow-xl),
    var(--glow-sm) color-mix(in oklab, var(--accent-primary) 15%, transparent),
    inset 0 1px 0 rgba(255,255,255,.15);
}

.logo-section{
  display: flex;
  gap: var(--space-3);
  align-items: center;
}

.logo{
  width: clamp(48px, 6vw, 56px);
  height: clamp(48px, 6vw, 56px);
  border-radius: var(--radius-md);
  display: grid;
  place-items: center;
  font-size: var(--text-2xl);
  background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
  color: var(--bg-primary);
  font-weight: 900;
  box-shadow: 
    var(--shadow-md),
    var(--glow-sm) color-mix(in oklab, var(--accent-primary) 40%, transparent);
  position: relative;
  overflow: hidden;
  transition: transform var(--duration-base) var(--ease-bounce);
}

.logo::before{
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, transparent 30%, rgba(255,255,255,.2) 50%, transparent 70%);
  transform: translateX(-100%);
  transition: transform var(--duration-slow) var(--ease-smooth);
}

.logo:hover{
  transform: scale(1.05) rotate(5deg);
}

.logo:hover::before{
  transform: translateX(100%);
}

h1{
  margin: 0;
  font-size: var(--text-2xl);
  font-weight: 900;
  letter-spacing: -0.02em;
  background: linear-gradient(135deg, var(--text-primary), var(--accent-primary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.tagline{
  font-size: var(--text-sm);
  color: var(--text-tertiary);
  font-weight: 500;
  letter-spacing: 0.05em;
  text-transform: uppercase;
  margin-top: calc(-1 * var(--space-1));
}

/* Genre Selector - Refined */
.genre-selector{
  display: flex;
  gap: var(--space-2);
  flex-wrap: wrap;
  justify-content: center;
}

.genre-btn{
  padding: var(--space-2) var(--space-4);
  border-radius: var(--radius-full);
  border: 1px solid var(--glass-border);
  background: var(--glass-bg);
  color: var(--text-secondary);
  font-family: var(--font-sans);
  font-weight: 700;
  font-size: var(--text-sm);
  letter-spacing: 0.01em;
  cursor: pointer;
  transition: all var(--duration-fast) var(--ease-smooth);
  position: relative;
  overflow: hidden;
}

.genre-btn::before{
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
  opacity: 0;
  transition: opacity var(--duration-fast) var(--ease-smooth);
}

.genre-btn > span{
  position: relative;
  z-index: 1;
}

.genre-btn:hover{
  border-color: color-mix(in oklab, var(--accent-primary) 40%, transparent);
  color: var(--text-primary);
  transform: translateY(-1px);
  box-shadow: var(--shadow-sm);
}

.genre-btn:hover::before{
  opacity: 0.1;
}

.genre-btn.active{
  background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
  color: var(--bg-primary);
  border-color: transparent;
  box-shadow: 
    var(--shadow-md),
    var(--glow-sm) color-mix(in oklab, var(--accent-primary) 40%, transparent);
  transform: translateY(-2px);
}

.genre-btn.active::before{
  opacity: 0;
}

.genre-btn:active{
  transform: translateY(0);
}

/* Header Actions */
.header-actions{
  display: flex;
  gap: var(--space-2);
}

/* -------- Premium Tab System -------- */
.tabs{
  position: sticky;
  top: calc(var(--header-h) + var(--space-4) + var(--space-2));
  z-index: 49;
  display: flex;
  gap: var(--space-2);
  padding: var(--space-3);
  background: var(--surface);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-lg);
  box-shadow: 
    var(--shadow-md),
    inset 0 1px 0 rgba(255,255,255,.06);
  backdrop-filter: blur(20px) saturate(130%);
  overflow-x: auto;
  overflow-y: visible;
  scrollbar-width: none;
  -ms-overflow-style: none;
}

.tabs::-webkit-scrollbar{ display: none; }

.tab{
  position: relative;
  padding: var(--space-3) var(--space-5);
  border: none;
  border-radius: var(--radius-full);
  background: transparent;
  color: var(--text-tertiary);
  font-family: var(--font-sans);
  font-weight: 700;
  font-size: var(--text-sm);
  letter-spacing: 0.02em;
  cursor: pointer;
  transition: all var(--duration-base) var(--ease-smooth);
  white-space: nowrap;
  overflow: hidden;
}

.tab::before{
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
  opacity: 0;
  border-radius: inherit;
  transition: opacity var(--duration-base) var(--ease-smooth);
}

.tab > *{
  position: relative;
  z-index: 1;
}

.tab:hover{
  background: var(--glass-bg-strong);
  color: var(--text-primary);
  transform: translateY(-1px);
}

.tab.active{
  background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
  color: var(--bg-primary);
  box-shadow: 
    var(--shadow-md),
    var(--glow-sm) color-mix(in oklab, var(--accent-primary) 35%, transparent);
  transform: translateY(-2px);
}

.tab:active{
  transform: translateY(0);
}

/* -------- Transport Bar - Command Center -------- */
.transport{
  position: sticky;
  top: calc(var(--header-h) + var(--tabs-h) + var(--space-4) + var(--space-4));
  z-index: 48;
  padding: var(--space-4) var(--space-5);
  background: var(--surface-elevated);
  border: 1px solid var(--glass-border-strong);
  border-radius: var(--radius-xl);
  box-shadow: 
    var(--shadow-lg),
    inset 0 1px 0 rgba(255,255,255,.08);
  backdrop-filter: blur(24px) saturate(140%);
  display: grid;
  grid-template-columns: auto 1fr auto;
  gap: var(--space-5);
  align-items: center;
  transition: all var(--duration-base) var(--ease-smooth);
}

.transport:hover{
  border-color: color-mix(in oklab, var(--accent-primary) 25%, var(--glass-border-strong));
  box-shadow: 
    var(--shadow-xl),
    var(--glow-sm) color-mix(in oklab, var(--accent-primary) 12%, transparent),
    inset 0 1px 0 rgba(255,255,255,.12);
}

.transport-controls{
  display: flex;
  gap: var(--space-2);
  align-items: center;
}

.progress-area{
  display: flex;
  flex-direction: column;
  gap: var(--space-2);
  min-width: 0;
}

.time-info{
  display: flex;
  gap: var(--space-2);
  color: var(--text-secondary);
  font-weight: 700;
  font-size: var(--text-sm);
  font-family: var(--font-mono);
  letter-spacing: 0.05em;
}

.progress-bar{
  height: 12px;
  border-radius: var(--radius-full);
  overflow: hidden;
  background: 
    linear-gradient(90deg, 
      rgba(255,255,255,.06) 0%, 
      rgba(255,255,255,.08) 50%, 
      rgba(255,255,255,.06) 100%);
  border: 1px solid rgba(255,255,255,.1);
  box-shadow: var(--shadow-inner);
  position: relative;
}

.progress-bar::before{
  content: '';
  position: absolute;
  inset: 0;
  background: repeating-linear-gradient(
    90deg,
    transparent 0px,
    transparent 4px,
    rgba(255,255,255,.03) 4px,
    rgba(255,255,255,.03) 8px
  );
  pointer-events: none;
}

.progress-fill{
  height: 100%;
  background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary), var(--accent-tertiary));
  width: 0%;
  transition: width 120ms linear;
  box-shadow: 
    var(--glow-sm) color-mix(in oklab, var(--accent-primary) 40%, transparent),
    inset 0 0 0 1px rgba(255,255,255,.2);
  position: relative;
  overflow: hidden;
}

.progress-fill::before{
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(90deg, 
    transparent 0%, 
    rgba(255,255,255,.3) 50%, 
    transparent 100%);
  animation: progressShimmer 2s linear infinite;
}

@keyframes progressShimmer{
  0%{ transform: translateX(-100%); }
  100%{ transform: translateX(100%); }
}

.transport-params{
  display: grid;
  grid-auto-flow: column;
  gap: var(--space-4);
  align-items: center;
}

/* -------- Premium Button System -------- */
.btn{
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: var(--space-2);
  padding: var(--space-3) var(--space-5);
  border: none;
  border-radius: var(--radius-md);
  font-family: var(--font-sans);
  font-weight: 700;
  font-size: var(--text-sm);
  letter-spacing: 0.01em;
  cursor: pointer;
  transition: all var(--duration-fast) var(--ease-smooth);
  white-space: nowrap;
  text-decoration: none;
  outline: none;
  position: relative;
  overflow: hidden;
  transform: translateY(0);
}

.btn::before{
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, transparent 30%, rgba(255,255,255,.15) 50%, transparent 70%);
  transform: translateX(-100%);
  transition: transform var(--duration-slow) var(--ease-smooth);
}

.btn:hover::before{
  transform: translateX(100%);
}

.btn-sm{
  padding: var(--space-2) var(--space-4);
  font-size: var(--text-xs);
  border-radius: var(--radius-sm);
}

.btn:active{
  transform: translateY(1px) scale(0.98);
}

.btn:disabled{
  opacity: 0.5;
  cursor: not-allowed;
  transform: none !important;
}

.btn:focus-visible{
  box-shadow: 
    0 0 0 var(--ring-offset) var(--bg-primary),
    0 0 0 calc(var(--ring-offset) + var(--ring-w)) var(--ring);
}

/* Button Variants */
.btn-primary{
  background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
  color: var(--bg-primary);
  box-shadow: 
    var(--shadow-md),
    var(--glow-sm) color-mix(in oklab, var(--accent-primary) 40%, transparent),
    inset 0 1px 0 rgba(255,255,255,.2);
}

.btn-primary:hover{
  transform: translateY(-2px);
  box-shadow: 
    var(--shadow-lg),
    var(--glow-md) color-mix(in oklab, var(--accent-primary) 35%, transparent),
    inset 0 1px 0 rgba(255,255,255,.25);
}

.btn-secondary{
  background: var(--surface);
  color: var(--text-primary);
  border: 1px solid var(--glass-border);
  box-shadow: var(--shadow-sm);
}

.btn-secondary:hover{
  border-color: color-mix(in oklab, var(--accent-primary) 40%, transparent);
  background: var(--surface-elevated);
  transform: translateY(-1px);
  box-shadow: var(--shadow-md);
}

.btn-ghost{
  background: transparent;
  color: var(--text-secondary);
  border: 1px solid transparent;
}

.btn-ghost:hover{
  background: var(--glass-bg-strong);
  border-color: var(--glass-border);
  color: var(--text-primary);
}

.btn-success{
  background: linear-gradient(135deg, var(--success), color-mix(in oklab, var(--success) 70%, #ffffff));
  color: #042013;
  box-shadow: 
    var(--shadow-md),
    var(--glow-sm) color-mix(in oklab, var(--success) 35%, transparent);
}

.btn-success:hover{
  transform: translateY(-2px);
  box-shadow: 
    var(--shadow-lg),
    var(--glow-md) color-mix(in oklab, var(--success) 30%, transparent);
}

/* -------- Sidebar -------- */
.sidebar{
  grid-area: sidebar;
  position: sticky;
  top: calc(var(--header-h) + var(--tabs-h) + var(--transport-h) + var(--space-8));
  align-self: start;
  max-height: calc(100dvh - var(--header-h) - var(--tabs-h) - var(--transport-h) - var(--space-16));
  overflow-y: auto;
  overflow-x: hidden;
  -webkit-overflow-scrolling: touch;
  padding: var(--space-4);
  background: var(--surface);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-md);
  display: grid;
  gap: var(--space-3);
}

@media (max-width: 1060px){
  .app{
    grid-template-columns: 1fr;
    grid-template-areas: "header" "main" "footer";
  }
  .sidebar:not(.pinned){ display: none; }
}

/* -------- Sections & Panels -------- */
.section{
  display: none;
}

.section.active{
  display: grid;
  gap: var(--gutter);
  margin-top: var(--space-2);
  animation: sectionFadeIn var(--duration-slow) var(--ease-smooth) both;
}

@keyframes sectionFadeIn{
  from{
    opacity: 0;
    transform: translateY(20px);
  }
  to{
    opacity: 1;
    transform: translateY(0);
  }
}

.panel{
  background: var(--surface);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-lg);
  padding: var(--space-6);
  box-shadow: 
    var(--shadow-md),
    inset 0 1px 0 rgba(255,255,255,.04);
  position: relative;
  overflow: hidden;
  transition: all var(--duration-base) var(--ease-smooth);
}

.panel::before{
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 2px;
  background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary), var(--accent-tertiary));
  opacity: 0;
  transition: opacity var(--duration-base) var(--ease-smooth);
}

.panel:hover{
  border-color: color-mix(in oklab, var(--accent-primary) 20%, var(--glass-border));
}

.panel:hover::before{
  opacity: 0.6;
}

.panel-header{
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: var(--space-4);
  padding-bottom: var(--space-3);
  border-bottom: 1px solid var(--glass-border);
}

.panel-title{
  font-size: var(--text-lg);
  font-weight: 800;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: var(--space-3);
  letter-spacing: -0.01em;
}

/* -------- Input Controls -------- */
.param-control{
  display: flex;
  flex-direction: column;
  gap: var(--space-2);
}

.param-label{
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: var(--space-2);
  color: var(--text-secondary);
  font-weight: 600;
  font-size: var(--text-sm);
}

.param-value{
  color: var(--text-primary);
  font-family: var(--font-mono);
  font-weight: 700;
  font-size: var(--text-sm);
  padding: var(--space-1) var(--space-2);
  background: var(--glass-bg);
  border-radius: var(--radius-xs);
}

/* Range Sliders - Premium */
input[type="range"]{
  width: 100%;
  height: 12px;
  border-radius: var(--radius-full);
  appearance: none;
  -webkit-appearance: none;
  cursor: pointer;
  background: 
    linear-gradient(90deg, 
      rgba(255,255,255,.06) 0%, 
      rgba(255,255,255,.08) 50%, 
      rgba(255,255,255,.06) 100%);
  border: 1px solid rgba(255,255,255,.1);
  box-shadow: var(--shadow-inner);
  outline: none;
  transition: all var(--duration-base) var(--ease-smooth);
}

input[type="range"]:hover{
  border-color: color-mix(in oklab, var(--accent-primary) 30%, rgba(255,255,255,.1));
}

input[type="range"]:focus-visible{
  box-shadow: 
    var(--shadow-inner),
    0 0 0 var(--ring-offset) var(--bg-primary),
    0 0 0 calc(var(--ring-offset) + var(--ring-w)) var(--ring);
}

/* Webkit Slider Thumb */
input[type="range"]::-webkit-slider-thumb{
  appearance: none;
  -webkit-appearance: none;
  width: 22px;
  height: 22px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
  box-shadow: 
    var(--shadow-md),
    var(--glow-sm) color-mix(in oklab, var(--accent-primary) 40%, transparent),
    inset 0 1px 0 rgba(255,255,255,.3);
  border: 2px solid rgba(255,255,255,.4);
  cursor: grab;
  transition: all var(--duration-fast) var(--ease-smooth);
}

input[type="range"]::-webkit-slider-thumb:hover{
  transform: scale(1.1);
  box-shadow: 
    var(--shadow-lg),
    var(--glow-md) color-mix(in oklab, var(--accent-primary) 45%, transparent),
    inset 0 1px 0 rgba(255,255,255,.4);
}

input[type="range"]::-webkit-slider-thumb:active{
  cursor: grabbing;
  transform: scale(0.95);
}

/* Firefox Slider Thumb */
input[type="range"]::-moz-range-thumb{
  width: 22px;
  height: 22px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
  box-shadow: 
    var(--shadow-md),
    var(--glow-sm) color-mix(in oklab, var(--accent-primary) 40%, transparent),
    inset 0 1px 0 rgba(255,255,255,.3);
  border: 2px solid rgba(255,255,255,.4);
  cursor: grab;
  transition: all var(--duration-fast) var(--ease-smooth);
}

input[type="range"]::-moz-range-thumb:hover{
  transform: scale(1.1);
}

input[type="range"]::-moz-range-thumb:active{
  cursor: grabbing;
  transform: scale(0.95);
}

/* Text Inputs & Select */
input[type="text"],
input[type="email"],
input[type="number"],
select{
  padding: var(--space-3) var(--space-4);
  border-radius: var(--radius-sm);
  background: var(--glass-bg);
  border: 1px solid var(--glass-border);
  color: var(--text-primary);
  font-family: var(--font-sans);
  font-weight: 600;
  font-size: var(--text-sm);
  cursor: pointer;
  outline: none;
  transition: all var(--duration-base) var(--ease-smooth);
}

input[type="text"]:focus,
input[type="email"]:focus,
input[type="number"]:focus,
select:focus{
  border-color: color-mix(in oklab, var(--accent-primary) 40%, var(--glass-border));
  background: var(--glass-bg-strong);
  box-shadow: 
    var(--shadow-sm),
    0 0 0 var(--ring-offset) var(--bg-primary),
    0 0 0 calc(var(--ring-offset) + var(--ring-w)) var(--ring);
}

input[type="text"]::placeholder{
  color: var(--text-muted);
  font-weight: 500;
}

select{
  background-image: 
    linear-gradient(45deg, transparent 50%, var(--text-tertiary) 50%),
    linear-gradient(135deg, var(--text-tertiary) 50%, transparent 50%);
  background-position: 
    calc(100% - 16px) calc(50% - 2px),
    calc(100% - 11px) calc(50% - 2px);
  background-size: 5px 5px, 5px 5px;
  background-repeat: no-repeat;
  padding-right: var(--space-8);
  cursor: pointer;
}

/* -------- Chips & Tags -------- */
.chips{
  display: flex;
  flex-wrap: wrap;
  gap: var(--space-2);
}

.chip{
  padding: var(--space-2) var(--space-4);
  border-radius: var(--radius-full);
  cursor: pointer;
  background: var(--glass-bg);
  border: 1px solid var(--glass-border);
  color: var(--text-secondary);
  font-weight: 700;
  font-size: var(--text-sm);
  transition: all var(--duration-fast) var(--ease-smooth);
  position: relative;
  overflow: hidden;
}

.chip::before{
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
  opacity: 0;
  transition: opacity var(--duration-fast) var(--ease-smooth);
}

.chip > *{
  position: relative;
  z-index: 1;
}

.chip:hover{
  border-color: color-mix(in oklab, var(--accent-primary) 40%, transparent);
  color: var(--text-primary);
  transform: translateY(-1px);
  box-shadow: var(--shadow-sm);
}

.chip:hover::before{
  opacity: 0.1;
}

.chip.active{
  background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
  color: var(--bg-primary);
  border-color: transparent;
  box-shadow: 
    var(--shadow-md),
    var(--glow-sm) color-mix(in oklab, var(--accent-primary) 40%, transparent);
}

.chip.active::before{
  opacity: 0;
}

/* -------- Preset Grid -------- */
.preset-grid{
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: var(--space-4);
}

.preset{
  padding: var(--space-5);
  border-radius: var(--radius-md);
  cursor: pointer;
  text-align: center;
  background: var(--surface);
  border: 1px solid var(--glass-border);
  font-weight: 700;
  display: flex;
  flex-direction: column;
  gap: var(--space-3);
  align-items: center;
  transition: all var(--duration-base) var(--ease-smooth);
  position: relative;
  overflow: hidden;
}

.preset::before{
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
  opacity: 0;
  transition: opacity var(--duration-base) var(--ease-smooth);
}

.preset > *{
  position: relative;
  z-index: 1;
}

.preset:hover{
  transform: translateY(-4px);
  border-color: color-mix(in oklab, var(--accent-primary) 40%, transparent);
  box-shadow: 
    var(--shadow-lg),
    var(--glow-md) color-mix(in oklab, var(--accent-primary) 20%, transparent);
}

.preset:hover::before{
  opacity: 0.08;
}

.preset:active{
  transform: translateY(-2px);
}

.preset-icon{
  font-size: var(--text-3xl);
  line-height: 1;
  filter: drop-shadow(0 2px 8px rgba(0,0,0,.3));
}

.preset-name{
  font-size: var(--text-sm);
  color: var(--text-secondary);
  transition: color var(--duration-base) var(--ease-smooth);
}

.preset:hover .preset-name{
  color: var(--text-primary);
}

/* -------- Premium Visualizer -------- */
.visualizer{
  height: clamp(160px, 20vh, 220px);
  border-radius: var(--radius-lg);
  position: relative;
  background:
    linear-gradient(135deg, 
      color-mix(in oklab, var(--accent-primary) 10%, transparent), 
      color-mix(in oklab, var(--accent-secondary) 8%, transparent)),
    linear-gradient(180deg, rgba(0,0,0,.2), transparent 70%);
  border: 1px solid var(--glass-border-strong);
  overflow: hidden;
  box-shadow: 
    var(--shadow-md),
    inset 0 1px 0 rgba(255,255,255,.06),
    inset 0 0 0 1px rgba(255,255,255,.03);
}

.visualizer::before{
  content: '';
  position: absolute;
  inset: 0;
  background: 
    repeating-linear-gradient(
      0deg,
      transparent 0px,
      rgba(255,255,255,.01) 1px,
      transparent 2px,
      transparent 20px
    );
  pointer-events: none;
  z-index: 1;
}

.viz-bar{
  position: absolute;
  bottom: 0;
  width: 5px;
  border-radius: 3px 3px 0 0;
  opacity: 0.9;
  background: linear-gradient(
    to top, 
    var(--accent-primary) 0%,
    var(--accent-secondary) 50%,
    var(--accent-tertiary) 100%
  );
  transition: height 80ms ease-out;
  will-change: height;
  box-shadow: 
    0 -4px 12px color-mix(in oklab, var(--accent-primary) 30%, transparent),
    inset 0 0 0 1px rgba(255,255,255,.15);
  filter: brightness(1.1);
}

.viz-overlay{
  position: absolute;
  inset: 0;
  display: grid;
  place-items: center;
  background: 
    linear-gradient(180deg, 
      color-mix(in oklab, var(--bg-primary) 40%, transparent), 
      color-mix(in oklab, var(--bg-secondary) 50%, transparent));
  backdrop-filter: blur(4px);
  font-weight: 800;
  font-size: var(--text-lg);
  color: var(--text-tertiary);
  letter-spacing: 0.05em;
  text-transform: uppercase;
  pointer-events: none;
  z-index: 2;
}

/* -------- Sequencer Grid -------- */
.sequencer{
  overflow-x: auto;
  overflow-y: visible;
  scrollbar-width: thin;
  padding-bottom: var(--space-2);
}

.seq-grid{
  display: grid;
  gap: var(--space-3);
  min-width: 900px;
  position: relative;
}

.seq-grid::before{
  content: '';
  position: absolute;
  inset: 0;
  border-radius: var(--radius-md);
  background:
    repeating-linear-gradient(
      to right,
      transparent 0,
      transparent calc(100% / 16 - 1px),
      rgba(255,255,255,.04) calc(100% / 16 - 1px),
      rgba(255,255,255,.04) calc(100% / 16)
    );
  pointer-events: none;
  z-index: 0;
}

.seq-row{
  display: grid;
  grid-template-columns: 180px repeat(16, 1fr);
  gap: var(--space-2);
  align-items: center;
  position: relative;
  z-index: 1;
}

.seq-label{
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: var(--space-3) var(--space-4);
  background: var(--surface);
  border-radius: var(--radius-md);
  border: 1px solid var(--glass-border);
  font-weight: 700;
  font-size: var(--text-sm);
  transition: all var(--duration-base) var(--ease-smooth);
}

.seq-label:hover{
  border-color: color-mix(in oklab, var(--accent-primary) 30%, var(--glass-border));
  background: var(--surface-elevated);
}

.seq-icons{
  display: flex;
  gap: var(--space-1);
}

.seq-icon{
  width: 32px;
  height: 32px;
  border: none;
  border-radius: var(--radius-xs);
  background: var(--glass-bg);
  color: var(--text-tertiary);
  cursor: pointer;
  display: grid;
  place-items: center;
  font-size: var(--text-xs);
  font-weight: 800;
  transition: all var(--duration-fast) var(--ease-smooth);
  border: 1px solid transparent;
}

.seq-icon:hover{
  background: var(--glass-bg-strong);
  color: var(--text-primary);
  border-color: var(--glass-border);
  transform: scale(1.05);
}

.seq-icon.active{
  background: var(--error);
  color: #fff;
  box-shadow: var(--shadow-sm);
}

/* Sequencer Steps */
.step{
  aspect-ratio: 1;
  min-height: 48px;
  border-radius: var(--radius-md);
  cursor: pointer;
  background: 
    linear-gradient(135deg, 
      rgba(255,255,255,.06), 
      rgba(255,255,255,.04));
  border: 1px solid var(--glass-border);
  position: relative;
  display: grid;
  place-items: center;
  transition: all var(--duration-fast) var(--ease-smooth);
  overflow: hidden;
}

.step::before{
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
  opacity: 0;
  transition: opacity var(--duration-fast) var(--ease-smooth);
}

.step:hover{
  border-color: color-mix(in oklab, var(--accent-primary) 40%, transparent);
  transform: translateY(-2px);
  box-shadow: var(--shadow-sm);
}

.step:hover::before{
  opacity: 0.1;
}

.step:active{
  transform: translateY(0) scale(0.97);
}

.step.active{
  background: 
    linear-gradient(135deg, 
      color-mix(in oklab, var(--accent-primary) 75%, transparent), 
      color-mix(in oklab, var(--accent-secondary) 80%, transparent));
  border-color: color-mix(in oklab, var(--accent-primary) 70%, transparent);
  box-shadow: 
    var(--shadow-sm),
    0 0 16px color-mix(in oklab, var(--accent-primary) 45%, transparent),
    inset 0 1px 0 rgba(255,255,255,.2);
}

.step.active::before{
  opacity: 0;
}

.step.playing{
  animation: stepPulse 280ms ease-out;
  box-shadow: 
    var(--shadow-md),
    0 0 28px var(--warning),
    0 0 48px color-mix(in oklab, var(--warning) 25%, transparent);
  border-color: var(--warning);
}

@keyframes stepPulse{
  0%, 100%{ transform: scale(1); }
  50%{ transform: scale(1.12); }
}

.step-prob{
  position: absolute;
  top: var(--space-1);
  right: var(--space-1);
  font-size: var(--text-xs);
  background: rgba(0,0,0,.6);
  padding: 2px var(--space-2);
  border-radius: var(--radius-xs);
  color: #fff;
  font-weight: 800;
  pointer-events: none;
  z-index: 2;
  font-family: var(--font-mono);
  backdrop-filter: blur(4px);
}

.step-vel{
  position: absolute;
  bottom: var(--space-1);
  left: var(--space-1);
  right: var(--space-1);
  height: 6px;
  background: rgba(255,255,255,.15);
  border-radius: var(--radius-full);
  overflow: hidden;
  z-index: 2;
}

.step-vel-fill{
  height: 100%;
  background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
  opacity: 0.95;
  transition: width 200ms var(--ease-smooth);
  box-shadow: 0 0 8px color-mix(in oklab, var(--accent-primary) 50%, transparent);
}

.playhead{
  position: sticky;
  left: 0;
  top: 0;
  height: 100%;
  width: 0;
  pointer-events: none;
  z-index: 10;
}

.playhead::after{
  content: '';
  position: absolute;
  top: 0;
  bottom: 0;
  width: 4px;
  border-radius: var(--radius-xs);
  background: linear-gradient(
    to bottom,
    var(--warning),
    color-mix(in oklab, var(--warning) 20%, transparent)
  );
  box-shadow: 
    0 0 16px color-mix(in oklab, var(--warning) 50%, transparent),
    0 0 32px color-mix(in oklab, var(--warning) 25%, transparent);
  transform: translateX(-2px);
}

/* -------- Mixer Channels -------- */
#tab-mixer .panel{
  display: grid;
  gap: var(--space-5);
}

#mixerGrid{
  display: grid;
  gap: var(--space-4);
  grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
}

.mixer-channel{
  background: var(--surface);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-md);
  padding: var(--space-4);
  display: flex;
  flex-direction: column;
  gap: var(--space-3);
  transition: all var(--duration-base) var(--ease-smooth);
}

.mixer-channel:hover{
  border-color: color-mix(in oklab, var(--accent-primary) 25%, var(--glass-border));
  box-shadow: var(--shadow-md);
  transform: translateY(-2px);
}

.channel-header{
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-bottom: var(--space-2);
  border-bottom: 1px solid var(--glass-border);
}

.channel-name{
  font-weight: 800;
  font-size: var(--text-sm);
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: var(--space-2);
}

.channel-btns{
  display: flex;
  gap: var(--space-1);
}

.channel-btn{
  width: 34px;
  height: 34px;
  border: none;
  border-radius: var(--radius-xs);
  background: var(--glass-bg);
  color: var(--text-tertiary);
  cursor: pointer;
  font-weight: 800;
  font-size: var(--text-xs);
  transition: all var(--duration-fast) var(--ease-smooth);
  border: 1px solid transparent;
}

.channel-btn:hover{
  background: var(--glass-bg-strong);
  color: var(--text-primary);
  border-color: var(--glass-border);
  transform: scale(1.05);
}

.channel-btn.active{
  color: #fff;
}

.channel-btn.mute.active{
  background: var(--error);
  box-shadow: var(--shadow-sm);
}

.channel-btn.solo.active{
  background: var(--warning);
  box-shadow: var(--shadow-sm);
}

/* -------- FX Units -------- */
#fxGrid{
  display: grid;
  gap: var(--space-4);
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
}

.fx-unit{
  background: var(--surface);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-md);
  padding: var(--space-5);
  box-shadow: var(--shadow-md);
  transition: all var(--duration-base) var(--ease-smooth);
}

.fx-unit:hover{
  border-color: color-mix(in oklab, var(--accent-primary) 25%, var(--glass-border));
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.fx-header{
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: var(--space-4);
  padding-bottom: var(--space-3);
  border-bottom: 1px solid var(--glass-border);
}

.fx-name{
  font-weight: 800;
  font-size: var(--text-base);
  color: var(--text-primary);
}

.fx-toggle{
  width: 60px;
  height: 32px;
  border-radius: var(--radius-full);
  cursor: pointer;
  background: color-mix(in oklab, var(--bg-secondary) 60%, transparent);
  border: 2px solid var(--glass-border);
  position: relative;
  transition: all var(--duration-base) var(--ease-smooth);
  box-shadow: var(--shadow-inner);
}

.fx-toggle::after{
  content: '';
  position: absolute;
  left: 4px;
  top: 50%;
  transform: translateY(-50%);
  width: 22px;
  height: 22px;
  border-radius: 50%;
  background: var(--text-muted);
  transition: all var(--duration-base) var(--ease-smooth);
  box-shadow: var(--shadow-sm);
}

.fx-toggle:hover{
  border-color: color-mix(in oklab, var(--accent-primary) 30%, var(--glass-border));
}

.fx-toggle.active{
  background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
  border-color: transparent;
  box-shadow: 
    var(--shadow-sm),
    0 0 16px color-mix(in oklab, var(--accent-primary) 30%, transparent);
}

.fx-toggle.active::after{
  left: calc(100% - 26px);
  background: var(--bg-primary);
}

/* -------- Footer -------- */
.footer{
  padding: var(--space-5) var(--space-6);
  background: var(--surface);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-lg);
  text-align: center;
  color: var(--text-secondary);
  font-size: var(--text-sm);
  line-height: 1.8;
  box-shadow: var(--shadow-sm);
}

.footer strong{
  color: var(--text-primary);
  font-weight: 800;
}

kbd{
  background: var(--glass-bg-strong);
  border: 1px solid var(--glass-border-strong);
  padding: var(--space-1) var(--space-2);
  border-radius: var(--radius-xs);
  font-weight: 700;
  font-size: var(--text-xs);
  color: var(--text-primary);
  font-family: var(--font-mono);
  box-shadow: 
    var(--shadow-xs),
    inset 0 -1px 0 rgba(0,0,0,.2);
}

/* -------- Utility Grid System -------- */
.grid{
  display: grid;
  gap: var(--space-4);
}

.grid-2{
  grid-template-columns: repeat(2, 1fr);
}

.grid-3{
  grid-template-columns: repeat(3, 1fr);
}

.grid-4{
  grid-template-columns: repeat(4, 1fr);
}

/* -------- Flex Utilities -------- */
.flex{
  display: flex;
  gap: var(--space-3);
  align-items: center;
  flex-wrap: wrap;
}

.flex-col{
  display: flex;
  flex-direction: column;
  gap: var(--space-3);
}

/* -------- Spacing Utilities -------- */
.mb-2{ margin-bottom: var(--space-2); }
.mb-3{ margin-bottom: var(--space-3); }
.mb-4{ margin-bottom: var(--space-4); }
.mt-2{ margin-top: var(--space-2); }
.mt-3{ margin-top: var(--space-3); }
.mt-4{ margin-top: var(--space-4); }

/* -------- Premium Scrollbars -------- */
*{
  scrollbar-color: 
    color-mix(in oklab, var(--accent-primary) 50%, transparent) 
    transparent;
  scrollbar-width: thin;
}

*::-webkit-scrollbar{
  height: 10px;
  width: 10px;
}

*::-webkit-scrollbar-track{
  background: transparent;
}

*::-webkit-scrollbar-thumb{
  background: linear-gradient(
    135deg, 
    color-mix(in oklab, var(--accent-primary) 85%, #fff), 
    color-mix(in oklab, var(--accent-secondary) 85%, #fff)
  );
  box-shadow: var(--glow-sm) color-mix(in oklab, var(--accent-primary) 30%, transparent);
}

*::-webkit-scrollbar-corner{
  background: transparent;
}

/* -------- Selection Styling -------- */
::selection{
  background: color-mix(in oklab, var(--accent-primary) 40%, transparent);
  color: var(--text-primary);
  text-shadow: none;
}

::-moz-selection{
  background: color-mix(in oklab, var(--accent-primary) 40%, transparent);
  color: var(--text-primary);
  text-shadow: none;
}

/* -------- Loading States -------- */
.loading{
  position: relative;
  pointer-events: none;
  opacity: 0.6;
}

.loading::after{
  content: '';
  position: absolute;
  inset: 0;
  background: 
    linear-gradient(
      90deg,
      transparent 0%,
      color-mix(in oklab, var(--accent-primary) 15%, transparent) 50%,
      transparent 100%
    );
  animation: shimmer 2s infinite;
  border-radius: inherit;
}

@keyframes shimmer{
  0%{ transform: translateX(-100%); }
  100%{ transform: translateX(100%); }
}

.spinner{
  width: 40px;
  height: 40px;
  border-radius: 50%;
  border: 4px solid var(--glass-border);
  border-top-color: var(--accent-primary);
  animation: spin 0.8s linear infinite;
  margin: var(--space-4) auto;
}

@keyframes spin{
  to{ transform: rotate(360deg); }
}

/* -------- Toast Notifications -------- */
.toast-container{
  position: fixed;
  top: calc(var(--space-4) + var(--inset-top));
  right: calc(var(--space-4) + var(--inset-right));
  z-index: 9999;
  display: flex;
  flex-direction: column;
  gap: var(--space-3);
  max-width: 420px;
  pointer-events: none;
}

.toast{
  padding: var(--space-4) var(--space-5);
  background: var(--surface-elevated);
  border: 1px solid var(--glass-border-strong);
  border-radius: var(--radius-lg);
  box-shadow: 
    var(--shadow-xl),
    var(--glow-sm) color-mix(in oklab, var(--accent-primary) 20%, transparent);
  backdrop-filter: blur(24px) saturate(150%);
  display: flex;
  gap: var(--space-3);
  align-items: center;
  font-size: var(--text-sm);
  font-weight: 600;
  color: var(--text-primary);
  animation: toastSlideIn var(--duration-slow) var(--ease-bounce);
  pointer-events: auto;
  position: relative;
  overflow: hidden;
}

.toast::before{
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 4px;
  background: linear-gradient(180deg, var(--accent-primary), var(--accent-secondary));
}

.toast.success::before{
  background: var(--success);
}

.toast.error::before{
  background: var(--error);
}

.toast.warning::before{
  background: var(--warning);
}

@keyframes toastSlideIn{
  from{
    transform: translateX(calc(100% + var(--space-4)));
    opacity: 0;
  }
  to{
    transform: translateX(0);
    opacity: 1;
  }
}

.toast-icon{
  font-size: var(--text-xl);
  line-height: 1;
}

.toast-close{
  margin-left: auto;
  width: 32px;
  height: 32px;
  border: none;
  border-radius: var(--radius-sm);
  background: var(--glass-bg);
  color: var(--text-tertiary);
  cursor: pointer;
  display: grid;
  place-items: center;
  font-size: var(--text-sm);
  font-weight: 800;
  transition: all var(--duration-fast) var(--ease-smooth);
}

.toast-close:hover{
  background: var(--glass-bg-strong);
  color: var(--text-primary);
  transform: scale(1.05);
}

/* -------- Modal/Dialog -------- */
.modal-backdrop{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(8px);
  z-index: 999;
  display: grid;
  place-items: center;
  padding: var(--space-4);
  animation: backdropFadeIn var(--duration-base) var(--ease-smooth);
}

@keyframes backdropFadeIn{
  from{ opacity: 0; }
  to{ opacity: 1; }
}

.modal{
  background: var(--surface-elevated);
  border: 1px solid var(--glass-border-strong);
  border-radius: var(--radius-xl);
  box-shadow: var(--shadow-2xl);
  padding: var(--space-8);
  max-width: 600px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  animation: modalSlideIn var(--duration-slow) var(--ease-bounce);
  position: relative;
}

@keyframes modalSlideIn{
  from{
    transform: translateY(40px) scale(0.95);
    opacity: 0;
  }
  to{
    transform: translateY(0) scale(1);
    opacity: 1;
  }
}

.modal-header{
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: var(--space-5);
  padding-bottom: var(--space-4);
  border-bottom: 1px solid var(--glass-border);
}

.modal-title{
  font-size: var(--text-2xl);
  font-weight: 900;
  color: var(--text-primary);
  background: linear-gradient(135deg, var(--text-primary), var(--accent-primary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.modal-close{
  width: 40px;
  height: 40px;
  border: none;
  border-radius: var(--radius-sm);
  background: var(--glass-bg);
  color: var(--text-tertiary);
  cursor: pointer;
  display: grid;
  place-items: center;
  font-size: var(--text-lg);
  font-weight: 800;
  transition: all var(--duration-fast) var(--ease-smooth);
}

.modal-close:hover{
  background: var(--glass-bg-strong);
  color: var(--text-primary);
  transform: scale(1.05);
}

.modal-body{
  color: var(--text-secondary);
  line-height: 1.7;
}

.modal-footer{
  display: flex;
  gap: var(--space-3);
  justify-content: flex-end;
  margin-top: var(--space-6);
  padding-top: var(--space-4);
  border-top: 1px solid var(--glass-border);
}

/* -------- Dropdown Menu -------- */
.dropdown{
  position: relative;
  display: inline-block;
}

.dropdown-menu{
  position: absolute;
  top: calc(100% + var(--space-2));
  right: 0;
  min-width: 220px;
  background: var(--surface-elevated);
  border: 1px solid var(--glass-border-strong);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-xl);
  backdrop-filter: blur(24px) saturate(150%);
  padding: var(--space-2);
  z-index: 100;
  opacity: 0;
  visibility: hidden;
  transform: translateY(-10px);
  transition: all var(--duration-base) var(--ease-smooth);
}

.dropdown.open .dropdown-menu{
  opacity: 1;
  visibility: visible;
  transform: translateY(0);
}

.dropdown-item{
  padding: var(--space-3) var(--space-4);
  border-radius: var(--radius-sm);
  cursor: pointer;
  color: var(--text-secondary);
  font-weight: 600;
  font-size: var(--text-sm);
  display: flex;
  align-items: center;
  gap: var(--space-3);
  transition: all var(--duration-fast) var(--ease-smooth);
  border: 1px solid transparent;
}

.dropdown-item:hover{
  background: var(--glass-bg-strong);
  color: var(--text-primary);
  border-color: var(--glass-border);
}

.dropdown-item.active{
  background: linear-gradient(135deg, 
    color-mix(in oklab, var(--accent-primary) 20%, transparent),
    color-mix(in oklab, var(--accent-secondary) 15%, transparent));
  color: var(--text-primary);
  border-color: color-mix(in oklab, var(--accent-primary) 30%, transparent);
}

.dropdown-divider{
  height: 1px;
  background: var(--glass-border);
  margin: var(--space-2) 0;
}

/* -------- Tooltip -------- */
[data-tooltip]{
  position: relative;
  cursor: help;
}

[data-tooltip]::before{
  content: attr(data-tooltip);
  position: absolute;
  bottom: calc(100% + var(--space-2));
  left: 50%;
  transform: translateX(-50%) translateY(-5px);
  padding: var(--space-2) var(--space-3);
  background: var(--surface-elevated);
  border: 1px solid var(--glass-border-strong);
  border-radius: var(--radius-sm);
  color: var(--text-primary);
  font-size: var(--text-xs);
  font-weight: 600;
  white-space: nowrap;
  box-shadow: var(--shadow-lg);
  opacity: 0;
  visibility: hidden;
  transition: all var(--duration-base) var(--ease-smooth);
  pointer-events: none;
  z-index: 200;
  backdrop-filter: blur(12px);
}

[data-tooltip]::after{
  content: '';
  position: absolute;
  bottom: calc(100% + var(--space-1));
  left: 50%;
  transform: translateX(-50%);
  border: 5px solid transparent;
  border-top-color: var(--glass-border-strong);
  opacity: 0;
  visibility: hidden;
  transition: all var(--duration-base) var(--ease-smooth);
  pointer-events: none;
  z-index: 200;
}

[data-tooltip]:hover::before,
[data-tooltip]:hover::after{
  opacity: 1;
  visibility: visible;
  transform: translateX(-50%) translateY(0);
}

/* -------- Context Menu -------- */
.context-menu{
  position: fixed;
  min-width: 200px;
  background: var(--surface-elevated);
  border: 1px solid var(--glass-border-strong);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-2xl);
  backdrop-filter: blur(24px) saturate(150%);
  padding: var(--space-2);
  z-index: 9999;
  animation: contextMenuAppear var(--duration-fast) var(--ease-smooth);
}

@keyframes contextMenuAppear{
  from{
    opacity: 0;
    transform: scale(0.95);
  }
  to{
    opacity: 1;
    transform: scale(1);
  }
}

/* -------- Badge -------- */
.badge{
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: var(--space-1) var(--space-3);
  border-radius: var(--radius-full);
  font-size: var(--text-xs);
  font-weight: 800;
  letter-spacing: 0.02em;
  text-transform: uppercase;
  line-height: 1;
}

.badge-primary{
  background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
  color: var(--bg-primary);
  box-shadow: var(--glow-sm) color-mix(in oklab, var(--accent-primary) 30%, transparent);
}

.badge-success{
  background: var(--success);
  color: #042013;
}

.badge-warning{
  background: var(--warning);
  color: #451a03;
}

.badge-error{
  background: var(--error);
  color: #fff;
}

.badge-ghost{
  background: var(--glass-bg-strong);
  color: var(--text-secondary);
  border: 1px solid var(--glass-border);
}

/* -------- Progress Indicator -------- */
.progress{
  height: 8px;
  background: var(--glass-bg);
  border-radius: var(--radius-full);
  overflow: hidden;
  border: 1px solid var(--glass-border);
  box-shadow: var(--shadow-inner);
}

.progress-value{
  height: 100%;
  background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
  border-radius: inherit;
  transition: width var(--duration-base) var(--ease-smooth);
  box-shadow: var(--glow-sm) color-mix(in oklab, var(--accent-primary) 40%, transparent);
}

/* -------- Accordion -------- */
.accordion-item{
  background: var(--surface);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-lg);
  overflow: hidden;
  margin-bottom: var(--space-3);
  transition: all var(--duration-base) var(--ease-smooth);
}

.accordion-item:hover{
  border-color: color-mix(in oklab, var(--accent-primary) 25%, var(--glass-border));
}

.accordion-header{
  padding: var(--space-4) var(--space-5);
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: 700;
  color: var(--text-primary);
  transition: all var(--duration-base) var(--ease-smooth);
}

.accordion-header:hover{
  background: var(--glass-bg);
}

.accordion-icon{
  transition: transform var(--duration-base) var(--ease-smooth);
}

.accordion-item.open .accordion-icon{
  transform: rotate(180deg);
}

.accordion-content{
  max-height: 0;
  overflow: hidden;
  transition: max-height var(--duration-slow) var(--ease-smooth);
}

.accordion-item.open .accordion-content{
  max-height: 1000px;
}

.accordion-body{
  padding: var(--space-4) var(--space-5);
  color: var(--text-secondary);
  line-height: 1.7;
}

/* -------- Responsive Breakpoints -------- */
@media (max-width: 768px){
  :root{
    --space-4: 0.75rem;
    --space-5: 1rem;
    --space-6: 1.25rem;
  }
  
  .grid-2,
  .grid-3,
  .grid-4{
    grid-template-columns: 1fr;
  }
  
  .transport{
    grid-template-columns: 1fr;
    gap: var(--space-3);
  }
  
  .transport-params{
    grid-auto-flow: row;
  }
  
  header{
    grid-template-columns: 1fr;
    gap: var(--space-3);
  }
  
  .genre-selector{
    justify-content: flex-start;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    flex-wrap: nowrap;
  }
  
  .genre-selector::-webkit-scrollbar{
    display: none;
  }
  
  .preset-grid{
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  }
  
  #mixerGrid{
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  }
  
  #fxGrid{
    grid-template-columns: 1fr;
  }
}

@media (max-width: 480px){
  body{
    padding: var(--space-2);
  }
  
  .app{
    padding: var(--space-3);
    border-radius: var(--radius-xl);
  }
  
  .panel{
    padding: var(--space-4);
  }
  
  .modal{
    padding: var(--space-5);
  }
  
  .toast-container{
    left: var(--space-2);
    right: var(--space-2);
    max-width: none;
  }
}

/* -------- Print Styles -------- */
@media print{
  body{
    background: white;
    color: black;
  }
  
  .app::before,
  .transport,
  .tabs,
  .header-actions,
  .btn,
  button{
    display: none !important;
  }
  
  .panel{
    break-inside: avoid;
    page-break-inside: avoid;
  }
}

/* -------- High Contrast Mode -------- */
@media (prefers-contrast: high){
  :root{
    --glass-border: rgba(255,255,255,.3);
    --glass-border-strong: rgba(255,255,255,.5);
  }
  
  .btn-primary,
  .tab.active{
    border: 2px solid var(--text-primary);
  }
}

/* -------- Reduced Motion -------- */
@media (prefers-reduced-motion: reduce){
  *,
  *::before,
  *::after{
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
  
  .app::before{
    animation: none;
  }
  
  .progress-fill::before{
    animation: none;
  }
}

/* -------- Focus Visible Enhancement -------- */
@supports selector(:focus-visible){
  *:focus{
    outline: none;
  }
  
  *:focus-visible{
    outline: var(--ring-w) solid var(--ring);
    outline-offset: var(--ring-offset);
  }
}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="logo-section">
        <div class="logo">🎹</div>
        <div>
          <h1>8-Beat Studio</h1>
          <div class="tagline">Fun With Noise</div>
        </div>
      </div>
      
      <div class="genre-selector" id="genreSelector">
        <button class="genre-btn active" data-genre="lofi">Lo-Fi</button>
        <button class="genre-btn" data-genre="hiphop">Hip-Hop</button>
        <button class="genre-btn" data-genre="trap">Trap</button>
        <button class="genre-btn" data-genre="house">House</button>
        <button class="genre-btn" data-genre="techno">Techno</button>
        <button class="genre-btn" data-genre="dnb">DnB</button>
        <button class="genre-btn" data-genre="ambient">Ambient</button>
      </div>
      
      <div class="header-actions">
        <button class="btn btn-secondary btn-sm" id="installBtn" hidden>📱 Install</button>
        <button class="btn btn-secondary btn-sm" id="vibeBtn">🌈 Vibe: Moon</button>
      </div>
    </header>
    
    <div class="tabs" id="tabs">
      <button class="tab active" data-tab="generate">🎲 Generate</button>
      <button class="tab" data-tab="sequencer">🎹 Sequencer</button>
      <button class="tab" data-tab="mixer">🎚️ Mixer</button>
      <button class="tab" data-tab="fx">🎛️ Effects</button>
      <button class="tab" data-tab="harmony">🎼 Harmony</button>
    </div>
    
    <div class="transport">
      <div class="transport-controls">
        <button class="btn btn-primary" id="playBtn">▶️ Play</button>
        <button class="btn btn-secondary" id="stopBtn">⏹️ Stop</button>
        <button class="btn btn-secondary" id="exportBtn">💾 Export</button>
      </div>
      
      <div class="progress-area">
        <div class="time-info">
          <span class="time-display" id="timeDisplay">00:00</span>
          <span id="durationDisplay">/ 05:00</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
      </div>
      
      <div class="transport-params">
        <div class="param-control">
          <div class="param-label">
            <span>BPM</span>
            <span class="param-value" id="bpmValue">120</span>
          </div>
          <input type="range" id="bpmSlider" min="60" max="200" value="120">
        </div>
        <div class="param-control">
          <div class="param-label">
            <span>Swing</span>
            <span class="param-value" id="swingValue">50%</span>
          </div>
          <input type="range" id="swingSlider" min="0" max="100" value="50">
        </div>
      </div>
    </div>
    
    <section class="section active" id="tab-generate">
      <div class="panel">
        <div class="visualizer" id="visualizer">
          <div class="viz-overlay" id="vizOverlay">Press Play to Start</div>
        </div>
      </div>
      
      <div class="grid grid-2">
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">⚙️ Project Settings</div>
          </div>
          
          <div class="grid grid-3 mb-3">
            <div class="param-control">
              <div class="param-label">
                <span>Duration</span>
                <span class="param-value" id="durValue">5 min</span>
              </div>
              <input type="range" id="durSlider" min="1" max="20" value="5">
            </div>
            <div class="param-control">
              <div class="param-label">
                <span>Complexity</span>
                <span class="param-value" id="complexValue">Medium</span>
              </div>
              <input type="range" id="complexSlider" min="1" max="3" value="2">
            </div>
            <div class="param-control">
              <div class="param-label">
                <span>Humanize</span>
                <span class="param-value" id="humanValue">10ms</span>
              </div>
              <input type="range" id="humanSlider" min="0" max="30" value="10">
            </div>
          </div>
          
          <div class="flex">
            <button class="btn btn-primary" id="generateBtn">🎲 Generate Beat</button>
            <button class="btn btn-secondary" id="randomVelBtn">🎯 Random Velocity</button>
            <button class="btn btn-secondary" id="randomProbBtn">🎲 Random Prob</button>
            <button class="btn btn-ghost" id="clearBtn">🧹 Clear</button>
          </div>
        </div>
        
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">💾 Project Management</div>
          </div>
          
          <div class="flex-col">
            <div class="flex">
              <button class="btn btn-success" id="saveBtn">💾 Save Project</button>
              <button class="btn btn-secondary" id="loadBtn">📂 Load Project</button>
            </div>
            <div class="flex">
              <input type="text" id="projectName" placeholder="Project Name" 
                style="flex:1; padding:10px; background:var(--glass-bg); border:1px solid var(--glass-border); border-radius:var(--radius-sm); color:var(--text-primary); font-family:inherit">
            </div>
          </div>
        </div>
      </div>
      
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">🎨 Genre Presets</div>
        </div>
        <div class="preset-grid" id="presetGrid"></div>
      </div>
    </section>
    
    <section class="section" id="tab-sequencer">
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">🎹 Pattern Sequencer</div>
          <div class="flex">
            <button class="btn btn-secondary btn-sm" id="lenDecBtn">− Length</button>
            <button class="btn btn-secondary btn-sm" id="lenIncBtn">+ Length</button>
            <select id="resSelect">
              <option value="16n" selected>1/16</option>
              <option value="8n">1/8</option>
              <option value="32n">1/32</option>
            </select>
            <button class="btn btn-secondary btn-sm" id="euclidBtn">∷ Euclidean</button>
            <button class="btn btn-secondary btn-sm" id="ghostBtn">👻 Ghost Notes</button>
          </div>
        </div>
        
        <div class="sequencer">
          <div class="seq-grid" id="seqGrid"></div>
        </div>
      </div>
    </section>
    
    <section class="section" id="tab-mixer">
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">🎚️ Channel Mixer</div>
        </div>
        <div class="grid grid-4" id="mixerGrid"></div>
      </div>
      
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">🎛️ Master Bus</div>
        </div>
        
        <div class="grid grid-3">
          <div class="param-control">
            <div class="param-label">
              <span>Master Volume</span>
              <span class="param-value" id="masterVolValue">0dB</span>
            </div>
            <input type="range" id="masterVolSlider" min="-40" max="10" value="0">
          </div>
          <div class="param-control">
            <div class="param-label">
              <span>Tape Saturation</span>
              <span class="param-value" id="tapeValue">25%</span>
            </div>
            <input type="range" id="tapeSlider" min="0" max="100" value="25">
          </div>
          <div class="param-control">
            <div class="param-label">
              <span>Vinyl Noise</span>
              <span class="param-value" id="vinylValue">15%</span>
            </div>
            <input type="range" id="vinylSlider" min="0" max="100" value="15">
          </div>
        </div>
        
        <div class="grid grid-3 mt-3">
          <div class="param-control">
            <div class="param-label">
              <span>Low Cut</span>
              <span class="param-value" id="lowCutValue">30Hz</span>
            </div>
            <input type="range" id="lowCutSlider" min="20" max="200" value="30">
          </div>
          <div class="param-control">
            <div class="param-label">
              <span>High Cut</span>
              <span class="param-value" id="highCutValue">16kHz</span>
            </div>
            <input type="range" id="highCutSlider" min="4000" max="20000" value="16000">
          </div>
          <div class="param-control">
            <div class="param-label">
              <span>Compressor</span>
              <span class="param-value" id="compValue">-18dB</span>
            </div>
            <input type="range" id="compSlider" min="-40" max="0" value="-18">
          </div>
        </div>
      </div>
    </section>
    
    <section class="section" id="tab-fx">
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">🎛️ Effects Rack</div>
        </div>
        <div class="grid grid-3" id="fxGrid"></div>
      </div>
    </section>
    
    <section class="section" id="tab-harmony">
      <div class="grid grid-2">
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">🎼 Key & Scale</div>
          </div>
          
          <div class="flex mb-3">
            <label style="display:flex; align-items:center; gap:8px">
              Key: <select id="keySelect"></select>
            </label>
            <label style="display:flex; align-items:center; gap:8px">
              Scale: <select id="scaleSelect"></select>
            </label>
            <label style="display:flex; align-items:center; gap:8px">
              Octave: <select id="octaveSelect"></select>
            </label>
          </div>
          
          <div class="panel-header">
            <div class="panel-title">Available Chords</div>
            <button class="btn btn-secondary btn-sm" id="genProgBtn">↻ Generate</button>
          </div>
          <div class="chips" id="chordChips"></div>
        </div>
        
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">🎵 Chord Progression</div>
            <button class="btn btn-ghost btn-sm" id="clearProgBtn">Clear</button>
          </div>
          
          <div class="chips mb-3" id="progressionChips"></div>
          
          <div class="panel-header">
            <div class="panel-title">Progression Templates</div>
          </div>
          <div class="grid grid-4">
            <button class="preset" data-prog="ii-v-i">
              <div class="preset-icon">🎷</div>
              <div class="preset-name">II-V-I</div>
            </button>
            <button class="preset" data-prog="lofi">
              <div class="preset-icon">😌</div>
              <div class="preset-name">Lo-Fi</div>
            </button>
            <button class="preset" data-prog="neosoul">
              <div class="preset-icon">🎹</div>
              <div class="preset-name">Neo-Soul</div>
            </button>
            <button class="preset" data-prog="modal">
              <div class="preset-icon">🌙</div>
              <div class="preset-name">Modal</div>
            </button>
          </div>
        </div>
      </div>
    </section>
    
    <footer class="footer">
      <strong>8-Beat Studio</strong> • Fun With Noise • 
      Shortcuts: <kbd>Space</kbd> Play/Pause • <kbd>S</kbd> Stop • <kbd>E</kbd> Export • 
      Sequencer: <kbd>Alt</kbd> Accent Velocity • <kbd>Shift</kbd> Increase Probability
    </footer>
  </div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
<script>
// ========================================
// 8-Beat Studio - Fully Optimized JS
// Performance: Debounced events, RAF throttling, object pooling
// Memory: Weak references, proper cleanup, no leaks
// Audio: Low-latency graph, stable connections, no crackles
// ========================================

'use strict';

// -------------------- Configuration --------------------
const CONFIG = {
  MAX_BPM: 200,
  MAX_SEQUENCE_LENGTH: 32,
  MIN_SEQUENCE_LENGTH: 4,
  VISUALIZER_BARS: 32,
  VISUALIZER_FPS: 30,
  PROGRESS_UPDATE_MS: 16,
  DEBOUNCE_MS: 80,
  STORAGE_KEY: 'prostudio.vibe'
};

const VIBES = ['moon', 'dawn', 'nebula', 'forest', 'sunset'];

// -------------------- State Management --------------------
const state = {
  currentGenre: 'lofi',
  currentTab: 'generate',
  isPlaying: false,
  bpm: 120,
  swing: 50,
  duration: 5,
  complexity: 2,
  humanize: 10,
  sequenceLength: 16,
  resolution: '16n',
  currentStep: 0,
  key: 'C',
  scale: 'major',
  octave: 4,
  progression: [],
  masterVolume: 0,
  tapeSaturation: 25,
  vinylNoise: 15,
  lowCut: 30,
  highCut: 16000,
  compressor: -18
};

// -------------------- Data Structures --------------------
const instruments = {
  kick: { name: 'Kick', icon: '🥁', mute: false, solo: false, volume: 0, pan: 0, type: 'drum' },
  snare: { name: 'Snare', icon: '🎤', mute: false, solo: false, volume: 0, pan: 0, type: 'drum' },
  hihat: { name: 'Hi-Hat', icon: '🎩', mute: false, solo: false, volume: 0, pan: 0, type: 'drum' },
  clap: { name: 'Clap', icon: '👏', mute: false, solo: false, volume: 0, pan: 0, type: 'drum' },
  rimshot: { name: 'Rimshot', icon: '🔊', mute: false, solo: false, volume: 0, pan: 0, type: 'drum' },
  tom: { name: 'Tom', icon: '🪘', mute: false, solo: false, volume: 0, pan: 0, type: 'drum' },
  crash: { name: 'Crash', icon: '💥', mute: false, solo: false, volume: 0, pan: 0, type: 'drum' },
  ride: { name: 'Ride', icon: '🌊', mute: false, solo: false, volume: 0, pan: 0, type: 'drum' },
  bass: { name: 'Bass', icon: '🎸', mute: false, solo: false, volume: -3, pan: 0, type: 'melodic', note: 'C2' },
  keys: { name: 'Keys', icon: '🎹', mute: false, solo: false, volume: -6, pan: 0, type: 'melodic', note: 'C4' },
  lead: { name: 'Lead', icon: '🎺', mute: false, solo: false, volume: -8, pan: 0, type: 'melodic', note: 'C5' }
};

const patterns = {};
const synths = {};
const effects = {};
const master = {};

// Initialize patterns with proper structure
Object.keys(instruments).forEach(inst => {
  patterns[inst] = Array(16).fill(null).map(() => ({
    active: false,
    velocity: 0.8,
    probability: 100,
    note: instruments[inst].note,
    duration: '8n'
  }));
});

// -------------------- Genre Presets --------------------
const genrePresets = {
  lofi: {
    name: 'Lo-Fi Hip-Hop', icon: '😌', bpm: 85,
    patterns: {
      kick: [1,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0],
      snare: [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],
      hihat: [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],
      bass: [1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],
      keys: [1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0]
    },
    notes: {
      bass: ['C2','C2','C2','C2','D#2','D#2','D#2','D#2','F2','F2','F2','F2','G2','G2','G2','G2'],
      keys: ['C4','E4','G4','C4','D#4','G4','A#4','D#4','F4','A4','C5','F4','G4','B4','D5','G4'],
      lead: ['C5','D5','E5','G5','A5','G5','E5','D5']
    }
  },
  hiphop: {
    name: 'Hip-Hop', icon: '🎤', bpm: 95,
    patterns: {
      kick: [1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0],
      snare: [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],
      hihat: [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],
      bass: [1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0],
      keys: [1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0]
    },
    notes: {
      bass: ['A1','A1','A1','C2','C2','C2','D2','D2','D2','F2','F2','F2','G2','G2','G2','G2'],
      keys: ['A3','C4','E4','A4','C4','E4','D4','F4','A4','D4','F4','G3','B3','D4','G4','B4'],
      lead: ['A4','C5','E5','A5','G5','E5','D5','C5']
    }
  },
  trap: {
    name: 'Trap', icon: '💎', bpm: 140,
    patterns: {
      kick: [1,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0],
      snare: [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,1],
      hihat: [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
      bass: [1,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0],
      lead: [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0]
    },
    notes: {
      bass: ['C1','C1','C1','C1','C1','C1','D#1','D#1','D#1','D#1','F1','F1','F1','F1','G1','G1'],
      keys: ['C4','D#4','G4','C5','D#4','G4','A#4','D#4'],
      lead: ['C5','D#5','G5','C6','A#5','G5','D#5','C5']
    }
  },
  house: {
    name: 'House', icon: '🏠', bpm: 125,
    patterns: {
      kick: [1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],
      snare: [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],
      hihat: [0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],
      bass: [1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],
      keys: [1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0]
    },
    notes: {
      bass: ['F2','F2','F2','F2','G2','G2','G2','G2','A2','A2','A2','A2','C3','C3','C3','C3'],
      keys: ['F4','A4','C5','F5','G4','B4','D5','G5','A4','C5','E5','A5','C5','E5','G5','C6'],
      lead: ['F5','G5','A5','C6','D6','C6','A5','G5']
    }
  },
  techno: {
    name: 'Techno', icon: '⚡', bpm: 130,
    patterns: {
      kick: [1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],
      snare: [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],
      hihat: [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],
      bass: [1,0,0,0,1,0,1,0,1,0,0,0,1,0,1,0],
      lead: [0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0]
    },
    notes: {
      bass: ['A1','A1','A1','A1','A1','A1','C2','C2','C2','C2','D2','D2','D2','D2','F2','F2'],
      keys: ['A3','C4','E4','A4','C4','E4','D4','F4'],
      lead: ['A5','C6','E6','A6','C6','E6','D6','F6']
    }
  },
  dnb: {
    name: 'Drum & Bass', icon: '🔊', bpm: 174,
    patterns: {
      kick: [1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],
      snare: [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],
      hihat: [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
      bass: [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],
      lead: [0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0]
    },
    notes: {
      bass: ['D2','D2','D3','D2','D2','D3','F2','F2','F3','F2','G2','G2','G3','G2','A2','A2'],
      keys: ['D4','F4','A4','D5','F4','A4','G4','B4'],
      lead: ['D5','F5','A5','D6','F6','A6','D6','A5']
    }
  },
  ambient: {
    name: 'Ambient', icon: '🌌', bpm: 60,
    patterns: {
      kick: [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      snare: [0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],
      hihat: [0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0],
      bass: [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      keys: [1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],
      lead: [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0]
    },
    notes: {
      bass: ['C2','C2','C2','C2','C2','C2','C2','C2','G1','G1','G1','G1','G1','G1','G1','G1'],
      keys: ['C3','E3','G3','C4','E4','G4','G3','B3','D4','G4','B4','D5'],
      lead: ['C5','E5','G5','C6','B5','G5','E5','D5']
    }
  }
};

// -------------------- Music Theory --------------------
const keysArr = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
const scales = {
  major: [0,2,4,5,7,9,11],
  minor: [0,2,3,5,7,8,10],
  dorian: [0,2,3,5,7,9,10],
  phrygian: [0,1,3,5,7,8,10],
  lydian: [0,2,4,6,7,9,11],
  mixolydian: [0,2,4,5,7,9,10],
  pentatonic: [0,2,4,7,9]
};

// -------------------- FX Configuration --------------------
const fxConfig = {
  reverb: { name: 'Reverb', active: false, decay: 2, wet: 0.3 },
  delay: { name: 'Delay', active: false, time: '8n', feedback: 0.4 },
  chorus: { name: 'Chorus', active: false, frequency: 1.5, depth: 0.7 },
  distortion: { name: 'Distortion', active: false, amount: 0.5 },
  filter: { name: 'Filter', active: false, frequency: 1000, type: 'lowpass' },
  phaser: { name: 'Phaser', active: false, frequency: 0.5, octaves: 3 }
};

// -------------------- Utilities --------------------
const debounce = (fn, ms) => {
  let timer;
  return (...args) => {
    clearTimeout(timer);
    timer = setTimeout(() => fn(...args), ms);
  };
};

const throttle = (fn, ms) => {
  let lastRun = 0;
  return (...args) => {
    const now = Date.now();
    if (now - lastRun >= ms) {
      lastRun = now;
      fn(...args);
    }
  };
};

const clamp = (val, min, max) => Math.max(min, Math.min(max, val));

// -------------------- Audio Context Setup --------------------
function initAudioContext() {
  if (Tone.getContext && Tone.getContext().rawContext) return;

  const ctx = new (window.AudioContext || window.webkitAudioContext)({
    latencyHint: 'interactive',
    sampleRate: 48000
  });
  
  Tone.setContext(new Tone.Context(ctx));
  Tone.context.lookAhead = 0.04;
  Tone.context.updateInterval = 0.03;
}

function unlockAudioOnce() {
  const unlock = async () => {
    try {
      await Tone.start();
      await Tone.getContext().rawContext.resume();
      console.log('🔓 Audio unlocked:', Tone.getContext().rawContext.state);
    } catch (e) {
      console.warn('Unlock failed:', e);
    } finally {
      ['pointerdown', 'keydown', 'touchstart'].forEach(evt => {
        window.removeEventListener(evt, unlock);
      });
    }
  };
  
  window.addEventListener('pointerdown', unlock, { once: true });
  window.addEventListener('keydown', unlock, { once: true });
  window.addEventListener('touchstart', unlock, { once: true, passive: true });
}

// -------------------- Audio Graph Initialization --------------------
function initAudio() {
  // Master chain
  master.fxIn = new Tone.Gain(1);
  
  // Effects
  effects.filter = new Tone.Filter(fxConfig.filter.frequency, fxConfig.filter.type);
  effects.distortion = new Tone.Distortion(fxConfig.distortion.amount);
  effects.chorus = new Tone.Chorus(1.5, 2.5, fxConfig.chorus.depth).start();
  effects.phaser = new Tone.Phaser({
    frequency: fxConfig.phaser.frequency,
    octaves: fxConfig.phaser.octaves,
    baseFrequency: 350
  });
  effects.delay = new Tone.FeedbackDelay(fxConfig.delay.time, fxConfig.delay.feedback);
  effects.reverb = new Tone.Reverb(fxConfig.reverb.decay);
  
  // Master processing
  master.comp = new Tone.Compressor(-18, 3);
  master.limiter = new Tone.Limiter(-1);
  
  // Connect chain
  master.fxIn.chain(
    effects.filter,
    effects.distortion,
    effects.chorus,
    effects.phaser,
    effects.delay,
    effects.reverb,
    master.comp,
    master.limiter
  );
  
  master.limiter.toDestination();
  
  // Visualizer tap
  master.analyser = new Tone.Analyser('fft', 64);
  master.limiter.connect(master.analyser);
  
  // Recording tap
  const raw = Tone.getContext().rawContext;
  master.mediaDest = raw.createMediaStreamDestination();
  master.limiter.connect(master.mediaDest);
  master.mediaRecorder = null;
  master.recordedChunks = [];
  
  // Start with all FX dry
  Object.values(effects).forEach(fx => {
    if (fx.wet) fx.wet.value = 0;
  });
  
  // Create synths and channels
  Object.keys(instruments).forEach(inst => createInstrumentChain(inst));
  
  // Transport setup
  Tone.Transport.bpm.value = state.bpm;
  Tone.Transport.swing = state.swing / 100;
  Tone.Transport.swingSubdivision = '8n';
  
  // Main sequencer loop
  const loop = new Tone.Sequence((time, step) => {
    state.currentStep = step;
    updateStepVisuals(step);
    
    Object.keys(instruments).forEach(inst => {
      playStep(inst, step, time);
    });
    
    updateVisualizer();
  }, Array.from({ length: state.sequenceLength }, (_, i) => i), state.resolution);
  
  loop.start(0);
}

function createInstrumentChain(inst) {
  const instData = instruments[inst];
  
  // Create synth
  if (instData.type === 'drum') {
    synths[inst] = createDrumSynth(inst);
  } else {
    synths[inst] = createMelodicSynth(inst);
    synths[inst].volume.value = instData.volume;
  }
  
  // Create channel and connect
  const channel = new Tone.Channel({
    pan: 0,
    volume: instData.volume
  }).connect(master.fxIn);
  
  instData.channel = channel;
  synths[inst].connect(channel);
}

function createDrumSynth(inst) {
  switch (inst) {
    case 'kick':
      return new Tone.MembraneSynth({
        pitchDecay: 0.08,
        octaves: 8,
        oscillator: { type: 'sine' },
        envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 1.4 }
      });
    case 'snare':
    case 'clap':
      return new Tone.NoiseSynth({
        noise: { type: 'white' },
        envelope: { attack: 0.001, decay: 0.2, sustain: 0 }
      });
    case 'hihat':
      return new Tone.MetalSynth({
        frequency: 200,
        envelope: { attack: 0.001, decay: 0.1, release: 0.01 },
        harmonicity: 5.1,
        modulationIndex: 32,
        resonance: 4000,
        octaves: 1.5
      });
    default:
      return new Tone.MembraneSynth({
        pitchDecay: 0.05,
        octaves: 6,
        oscillator: { type: 'sine' },
        envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 1.4 }
      });
  }
}

function createMelodicSynth(inst) {
  switch (inst) {
    case 'bass':
      return new Tone.MonoSynth({
        oscillator: { type: 'sawtooth' },
        filter: { Q: 2, type: 'lowpass', rolloff: -24 },
        envelope: { attack: 0.01, decay: 0.3, sustain: 0.4, release: 0.8 },
        filterEnvelope: {
          attack: 0.01,
          decay: 0.2,
          sustain: 0.3,
          release: 0.5,
          baseFrequency: 100,
          octaves: 2.5
        }
      });
    case 'keys':
      return new Tone.PolySynth(Tone.AMSynth, {
        harmonicity: 1.01,
        envelope: { attack: 0.02, decay: 0.4, sustain: 0.6, release: 1.5 },
        modulationEnvelope: { attack: 0.2, decay: 0.3, sustain: 0.2, release: 0.8 }
      });
    case 'lead':
      return new Tone.FMSynth({
        modulationIndex: 6,
        oscillator: { type: 'sine' },
        envelope: { attack: 0.01, decay: 0.25, sustain: 0.5, release: 0.8 },
        modulation: { type: 'triangle' },
        modulationEnvelope: { attack: 0.01, decay: 0.2, sustain: 0.3, release: 0.7 }
      });
    default:
      return new Tone.Synth();
  }
}

function playStep(inst, step, time) {
  const stepData = patterns[inst][step];
  if (!stepData.active) return;
  
  const instData = instruments[inst];
  if (instData.mute) return;
  
  // Solo logic
  const anySolo = Object.values(instruments).some(i => i.solo);
  if (anySolo && !instData.solo) return;
  
  // Probability check
  if (Math.random() * 100 > stepData.probability) return;
  
  // Humanize timing
  const humanize = (Math.random() - 0.5) * (state.humanize / 1000);
  
  if (instData.type === 'drum') {
    playDrumNote(inst, time + humanize, stepData.velocity);
  } else {
    playMelodicNote(inst, time + humanize, stepData);
  }
}

function playDrumNote(inst, time, velocity) {
  const synth = synths[inst];
  
  switch (inst) {
    case 'kick':
      synth.triggerAttackRelease('C1', '8n', time, velocity);
      break;
    case 'snare':
    case 'clap':
      synth.triggerAttackRelease('16n', time, velocity);
      break;
    case 'hihat':
      synth.triggerAttackRelease('C6', '16n', time, velocity * 0.5);
      break;
    default:
      synth.triggerAttackRelease('C2', '16n', time, velocity);
  }
}

function playMelodicNote(inst, time, stepData) {
  const note = stepData.note || instruments[inst].note || 'C4';
  const duration = stepData.duration || '8n';
  synths[inst].triggerAttackRelease(note, duration, time, stepData.velocity);
}

// -------------------- Vibe System --------------------
function applyVibe(vibe) {
  document.body.setAttribute('data-vibe', vibe);
  try {
    localStorage.setItem(CONFIG.STORAGE_KEY, vibe);
  } catch (e) {
    console.warn('localStorage unavailable');
  }
  
  const label = vibe.charAt(0).toUpperCase() + vibe.slice(1);
  const btn = document.getElementById('vibeBtn');
  if (btn) btn.textContent = `🌈 Vibe: ${label}`;
}

function nextVibe() {
  const current = document.body.getAttribute('data-vibe') || 'moon';
  const index = VIBES.indexOf(current);
  return VIBES[(index + 1) % VIBES.length];
}

// -------------------- Pattern Management --------------------
function ensurePatternLength(length) {
  Object.keys(patterns).forEach(inst => {
    const arr = patterns[inst];
    
    while (arr.length < length) {
      arr.push({
        active: false,
        velocity: 0.8,
        probability: 100,
        note: instruments[inst].note,
        duration: '8n'
      });
    }
    
    if (arr.length > length) arr.length = length;
  });
}

// -------------------- Event Handlers Setup --------------------
function setupEventListeners() {
  setupGenreSelector();
  setupTabs();
  setupTransportControls();
  setupParameterControls();
  setupGeneratorButtons();
  setupSequencerControls();
  setupMixerListeners();
  setupFXListeners();
  setupHarmonyControls();
  setupProjectManagement();
  setupKeyboardShortcuts();
  setupVibeSelector();
}

function setupGenreSelector() {
  document.getElementById('genreSelector').addEventListener('click', e => {
    const btn = e.target.closest('.genre-btn');
    if (!btn) return;
    
    document.querySelectorAll('.genre-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    state.currentGenre = btn.dataset.genre;
    updateGenrePresets();
  });
}

function setupTabs() {
  document.getElementById('tabs').addEventListener('click', e => {
    const tab = e.target.closest('.tab');
    if (!tab) return;
    
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
    
    state.currentTab = tab.dataset.tab;
  });
}

function setupTransportControls() {
  document.getElementById('playBtn').addEventListener('click', togglePlay);
  document.getElementById('stopBtn').addEventListener('click', stop);
  document.getElementById('exportBtn').addEventListener('click', exportAudio);
}

function setupParameterControls() {
  // BPM with debounce
  const bpmHandler = debounce(value => {
    state.bpm = clamp(value, 60, CONFIG.MAX_BPM);
    Tone.Transport.bpm.value = state.bpm;
  }, CONFIG.DEBOUNCE_MS);
  
  document.getElementById('bpmSlider').addEventListener('input', e => {
    const value = parseInt(e.target.value, 10);
    document.getElementById('bpmValue').textContent = value;
    bpmHandler(value);
  });
  
  // Swing
  document.getElementById('swingSlider').addEventListener('input', e => {
    state.swing = parseInt(e.target.value, 10);
    document.getElementById('swingValue').textContent = state.swing + '%';
    Tone.Transport.swing = state.swing / 100;
    Tone.Transport.swingSubdivision = '8n';
  });
  
  // Duration
  document.getElementById('durSlider').addEventListener('input', e => {
    state.duration = parseInt(e.target.value, 10);
    document.getElementById('durValue').textContent = state.duration + ' min';
    document.getElementById('durationDisplay').textContent = 
      '/ ' + String(state.duration).padStart(2, '0') + ':00';
  });
  
  // Complexity
  document.getElementById('complexSlider').addEventListener('input', e => {
    state.complexity = parseInt(e.target.value, 10);
    const labels = ['Simple', 'Medium', 'Complex'];
    document.getElementById('complexValue').textContent = labels[state.complexity - 1];
  });
  
  // Humanize
  document.getElementById('humanSlider').addEventListener('input', e => {
    state.humanize = parseInt(e.target.value, 10);
    document.getElementById('humanValue').textContent = state.humanize + 'ms';
  });
  
  // Master controls
  setupMasterControls();
}

function setupMasterControls() {
  document.getElementById('masterVolSlider').addEventListener('input', e => {
    state.masterVolume = parseInt(e.target.value, 10);
    document.getElementById('masterVolValue').textContent = state.masterVolume + 'dB';
    Tone.Destination.volume.value = state.masterVolume;
  });
  
  document.getElementById('tapeSlider').addEventListener('input', e => {
    state.tapeSaturation = parseInt(e.target.value, 10);
    document.getElementById('tapeValue').textContent = state.tapeSaturation + '%';
  });
  
  document.getElementById('vinylSlider').addEventListener('input', e => {
    state.vinylNoise = parseInt(e.target.value, 10);
    document.getElementById('vinylValue').textContent = state.vinylNoise + '%';
  });
  
  document.getElementById('lowCutSlider').addEventListener('input', e => {
    state.lowCut = parseInt(e.target.value, 10);
    document.getElementById('lowCutValue').textContent = state.lowCut + 'Hz';
  });
  
  document.getElementById('highCutSlider').addEventListener('input', e => {
    state.highCut = parseInt(e.target.value, 10);
    document.getElementById('highCutValue').textContent = 
      (state.highCut / 1000).toFixed(1) + 'kHz';
  });
  
  document.getElementById('compSlider').addEventListener('input', e => {
    state.compressor = parseInt(e.target.value, 10);
    document.getElementById('compValue').textContent = state.compressor + 'dB';
  });
}

function setupGeneratorButtons() {
  document.getElementById('generateBtn').addEventListener('click', generateBeat);
  document.getElementById('randomVelBtn').addEventListener('click', randomizeVelocity);
  document.getElementById('randomProbBtn').addEventListener('click', randomizeProbability);
  document.getElementById('clearBtn').addEventListener('click', clearPattern);
}

function setupSequencerControls() {
  document.getElementById('lenDecBtn').addEventListener('click', () => {
    state.sequenceLength = Math.max(CONFIG.MIN_SEQUENCE_LENGTH, state.sequenceLength - 4);
    ensurePatternLength(state.sequenceLength);
    renderSequencer();
  });
  
  document.getElementById('lenIncBtn').addEventListener('click', () => {
    state.sequenceLength = Math.min(CONFIG.MAX_SEQUENCE_LENGTH, state.sequenceLength + 4);
    ensurePatternLength(state.sequenceLength);
    renderSequencer();
  });
  
  document.getElementById('resSelect').addEventListener('change', e => {
    state.resolution = e.target.value;
  });
  
  document.getElementById('euclidBtn').addEventListener('click', applyEuclidean);
  document.getElementById('ghostBtn').addEventListener('click', addGhostNotes);
  
  // Delegated sequencer events
  const seqGrid = document.getElementById('seqGrid');
  seqGrid.addEventListener('click', handleSequencerClick);
}

function handleSequencerClick(e) {
  const stepEl = e.target.closest('.step');
  if (stepEl) {
    const inst = stepEl.dataset.inst;
    const step = parseInt(stepEl.dataset.step, 10);
    toggleStep(inst, step, e);
    return;
  }
  
  const icon = e.target.closest('.seq-icon');
  if (icon) {
    const inst = icon.dataset.inst;
    const action = icon.dataset.action;
    
    if (action === 'mute') {
      instruments[inst].mute = !instruments[inst].mute;
    } else if (action === 'solo') {
      instruments[inst].solo = !instruments[inst].solo;
    } else if (action === 'note') {
      openNoteEditor(inst);
    }
    
    renderSequencer();
  }
}

function setupMixerListeners() {
  const mixerGrid = document.getElementById('mixerGrid');
  
  mixerGrid.addEventListener('click', e => {
    const btn = e.target.closest('.channel-btn');
    if (!btn) return;
    
    const inst = btn.dataset.inst;
    const action = btn.dataset.action;
    
    if (action === 'mute') {
      instruments[inst].mute = !instruments[inst].mute;
    } else if (action === 'solo') {
      instruments[inst].solo = !instruments[inst].solo;
    }
    
    renderMixer();
    renderSequencer();
  });
  
  mixerGrid.addEventListener('input', e => {
    if (e.target.type !== 'range') return;
    
    const inst = e.target.dataset.inst;
    const param = e.target.dataset.param;
    const value = parseFloat(e.target.value);
    
    instruments[inst][param] = value;
    
    if (param === 'volume' && instruments[inst].channel) {
      instruments[inst].channel.volume.value = value;
    } else if (param === 'pan' && instruments[inst].channel) {
      instruments[inst].channel.pan.value = value / 100;
    }
    
    const parent = e.target.closest('.param-control');
    const valEl = parent.querySelector('.param-value');
    
    if (param === 'volume') {
      valEl.textContent = value + 'dB';
    } else if (param === 'pan') {
      const label = value > 0 ? 'R' : value < 0 ? 'L' : 'C';
      valEl.textContent = label + Math.abs(value);
    }
  });
}

function setupFXListeners() {
  const fxGrid = document.getElementById('fxGrid');
  
  fxGrid.addEventListener('click', e => {
    const toggle = e.target.closest('.fx-toggle');
    if (!toggle) return;
    
    const fx = toggle.dataset.fx;
    fxConfig[fx].active = !fxConfig[fx].active;
    
    if (effects[fx] && effects[fx].wet) {
      effects[fx].wet.value = fxConfig[fx].active ? 0.5 : 0;
    }
    
    renderFX();
  });
  
  fxGrid.addEventListener('input', e => {
    if (e.target.type !== 'range') return;
    
    const fx = e.target.dataset.fx;
    const param = e.target.dataset.param;
    const raw = parseInt(e.target.value, 10);
    const value = mapFxParam(param, raw);
    
    fxConfig[fx][param] = value;
    applyFxParam(fx, param, value);
    
    const label = e.target.closest('.param-control').querySelector('.param-value');
    label.textContent = formatFxDisplay(param, value);
  });
}

function setupHarmonyControls() {
  document.getElementById('keySelect').addEventListener('change', e => {
    state.key = e.target.value;
    updateChords();
  });
  
  document.getElementById('scaleSelect').addEventListener('change', e => {
    state.scale = e.target.value;
    updateChords();
  });
  
  document.getElementById('octaveSelect').addEventListener('change', e => {
    state.octave = parseInt(e.target.value, 10);
  });
  
  document.getElementById('genProgBtn').addEventListener('click', generateProgression);
  document.getElementById('clearProgBtn').addEventListener('click', () => {
    state.progression = [];
    renderProgression();
  });
  
  document.querySelectorAll('[data-prog]').forEach(btn => {
    btn.addEventListener('click', e => {
      loadProgressionTemplate(e.currentTarget.dataset.prog);
    });
  });
}

function setupProjectManagement() {
  document.getElementById('saveBtn').addEventListener('click', saveProject);
  document.getElementById('loadBtn').addEventListener('click', loadProject);
}

function setupKeyboardShortcuts() {
  document.addEventListener('keydown', e => {
    if (e.code === 'Space') {
      e.preventDefault();
      togglePlay();
    } else if (e.code === 'KeyS') {
      e.preventDefault();
      stop();
    } else if (e.code === 'KeyE') {
      e.preventDefault();
      exportAudio();
    }
  });
}

function setupVibeSelector() {
  const vibeBtn = document.getElementById('vibeBtn');
  if (vibeBtn) {
    vibeBtn.addEventListener('click', () => {
      applyVibe(nextVibe());
    });
  }
}

// -------------------- FX Parameter Mapping --------------------
function mapFxParam(param, raw) {
  switch (param) {
    case 'decay':
      return raw / 20;
    case 'wet':
    case 'feedback':
    case 'depth':
    case 'amount':
      return raw / 100;
    case 'time':
      return ['16n', '8n', '4n', '2n'][Math.min(3, Math.floor(raw / 25))];
    case 'frequency':
      return 100 + raw * 79;
    case 'octaves':
      return Math.floor(raw / 20) + 1;
    default:
      return raw / 50;
  }
}

function applyFxParam(fx, param, value) {
  const node = effects[fx];
  if (!node) return;
  
  if (param === 'decay' && node.decay !== undefined) {
    node.decay = value;
  } else if (param === 'wet' && node.wet) {
    node.wet.value = value;
  } else if (param === 'time' && node.delayTime) {
    node.delayTime.value = Tone.Time(value);
  } else if (param === 'feedback' && node.feedback) {
    node.feedback.value = value;
  } else if (param === 'frequency' && node.frequency) {
    node.frequency.value = value;
  } else if (param === 'depth' && node.depth !== undefined) {
    node.depth = value;
  } else if (param === 'amount' && node.distortion !== undefined) {
    node.distortion = value;
  } else if (param === 'octaves' && node.octaves !== undefined) {
    node.octaves = value;
  }
}

function formatFxDisplay(param, value) {
  switch (param) {
    case 'wet':
    case 'feedback':
    case 'depth':
    case 'amount':
      return Math.round(value * 100) + '%';
    case 'decay':
      return value.toFixed(2) + 's';
    case 'time':
      return String(value);
    case 'frequency':
      return Math.round(value) + 'Hz';
    case 'octaves':
      return value + ' oct';
    default:
      return String(value);
  }
}

// -------------------- Sequencer Rendering --------------------
function renderSequencer() {
  const grid = document.getElementById('seqGrid');
  const fragment = document.createDocumentFragment();
  
  Object.keys(instruments).forEach(inst => {
    const instData = instruments[inst];
    const row = document.createElement('div');
    row.className = 'seq-row';
    
    // Label
    const label = document.createElement('div');
    label.className = 'seq-label';
    label.innerHTML = `
      <span>${instData.icon} ${instData.name}</span>
      <div class="seq-icons">
        <button class="seq-icon ${instData.mute ? 'active' : ''}" 
                data-inst="${inst}" data-action="mute">M</button>
        <button class="seq-icon ${instData.solo ? 'active' : ''}" 
                data-inst="${inst}" data-action="solo">S</button>
        ${instData.type === 'melodic' ? 
          `<button class="seq-icon" data-inst="${inst}" data-action="note">🎵</button>` : ''}
      </div>
    `;
    row.appendChild(label);
    
    // Steps
    for (let i = 0; i < state.sequenceLength; i++) {
      const step = patterns[inst][i];
      const cell = document.createElement('div');
      cell.className = 'step';
      cell.dataset.inst = inst;
      cell.dataset.step = i;
      
      if (step.active) {
        cell.classList.add('active');
        
        const probLabel = document.createElement('div');
        probLabel.className = 'step-prob';
        
        if (instData.type === 'melodic' && step.note) {
          probLabel.textContent = step.note;
          probLabel.style.fontSize = '0.6rem';
        } else {
          probLabel.textContent = step.probability + '%';
        }
        
        cell.appendChild(probLabel);
        
        const velBar = document.createElement('div');
        velBar.className = 'step-vel';
        velBar.innerHTML = `<div class="step-vel-fill" 
          style="width:${Math.round((step.velocity || 0) * 100)}%"></div>`;
        cell.appendChild(velBar);
      }
      
      row.appendChild(cell);
    }
    
    fragment.appendChild(row);
  });
  
  grid.innerHTML = '';
  grid.appendChild(fragment);
  
  // Playhead
  let playhead = document.getElementById('playhead');
  if (!playhead) {
    playhead = document.createElement('div');
    playhead.id = 'playhead';
    playhead.className = 'playhead';
    document.querySelector('.sequencer').appendChild(playhead);
  }
}

function toggleStep(inst, stepIndex, e) {
  const pattern = patterns[inst][stepIndex];
  const instData = instruments[inst];
  
  if (e.altKey) {
    if (pattern.active) {
      pattern.velocity = Math.min(1, (pattern.velocity || 0.8) + 0.2);
      if (pattern.velocity > 1) pattern.velocity = 0.4;
    }
  } else if (e.shiftKey) {
    if (pattern.active) {
      if (instData.type === 'melodic') {
        cycleNote(inst, stepIndex);
      } else {
        pattern.probability = Math.min(100, pattern.probability + 25);
        if (pattern.probability > 100) pattern.probability = 50;
      }
    }
  } else if (e.ctrlKey || e.metaKey) {
    if (instData.type === 'melodic' && pattern.active) {
      const newNote = prompt(
        `Enter note (e.g., C4, D#3):`,
        pattern.note || instData.note
      );
      if (newNote && /^[A-G]#?[1-6]$/.test(newNote)) {
        pattern.note = newNote;
      }
    }
  } else {
    pattern.active = !pattern.active;
    if (pattern.active) {
      pattern.velocity = 0.8;
      pattern.probability = 100;
      if (instData.type === 'melodic') {
        pattern.note = instData.note;
        pattern.duration = '8n';
      }
    }
  }
  
  renderSequencer();
}

function cycleNote(inst, stepIndex) {
  const pattern = patterns[inst][stepIndex];
  const scaleIntervals = scales[state.scale];
  const keyIndex = keysArr.indexOf(state.key);
  
  const currentNote = pattern.note || instruments[inst].note;
  const match = currentNote.match(/^([A-G]#?)(\d+)$/);
  if (!match) return;
  
  const [, noteName, octave] = match;
  const scaleNotes = scaleIntervals.map(iv => keysArr[(keyIndex + iv) % 12]);
  const index = scaleNotes.indexOf(noteName);
  const nextNote = scaleNotes[(index + 1 + scaleNotes.length) % scaleNotes.length] + octave;
  
  pattern.note = nextNote;
}

function updateStepVisuals(step) {
  const widthPerStep = 100 / state.sequenceLength;
  const playhead = document.getElementById('playhead');
  if (playhead) {
    playhead.style.transform = `translateX(${(step + 0.5) * widthPerStep}%)`;
  }
}

function openNoteEditor(inst) {
  const currentNote = instruments[inst].note || 'C4';
  const newNote = prompt(
    `Enter note for ${instruments[inst].name} (e.g., C4, D#3, F5):\n\nCurrent: ${currentNote}`,
    currentNote
  );
  
  if (newNote && /^[A-G]#?[1-6]$/.test(newNote)) {
    instruments[inst].note = newNote;
    patterns[inst].forEach(step => {
      if (step.active && !step.note) {
        step.note = newNote;
      }
    });
    renderSequencer();
  }
}

// -------------------- Pattern Generators --------------------
function generateBeat() {
  const preset = genrePresets[state.currentGenre];
  if (!preset) return;
  
  Object.keys(instruments).forEach(inst => {
    const presetPattern = preset.patterns[inst];
    const notes = preset.notes ? preset.notes[inst] : null;
    
    if (presetPattern) {
      presetPattern.forEach((value, i) => {
        if (i < state.sequenceLength) {
          patterns[inst][i].active = value === 1;
          patterns[inst][i].velocity = 0.7 + Math.random() * 0.3;
          patterns[inst][i].probability = 100;
          
          if (instruments[inst].type === 'melodic' && notes && notes[i]) {
            patterns[inst][i].note = notes[i];
            patterns[inst][i].duration = '8n';
          }
        }
      });
    }
  });
  
  if (state.complexity >= 2) addVariations();
  if (state.complexity >= 3) addGhostNotes();
  
  state.bpm = Math.min(CONFIG.MAX_BPM, preset.bpm);
  document.getElementById('bpmSlider').value = state.bpm;
  document.getElementById('bpmValue').textContent = state.bpm;
  Tone.Transport.bpm.value = state.bpm;
  
  renderSequencer();
}

function addVariations() {
  Object.keys(instruments).forEach(inst => {
    for (let i = 0; i < state.sequenceLength; i++) {
      if (Math.random() < 0.2 && !patterns[inst][i].active) {
        patterns[inst][i].active = true;
        patterns[inst][i].velocity = 0.4 + Math.random() * 0.3;
        patterns[inst][i].probability = 50 + Math.random() * 50;
      }
    }
  });
}

function addGhostNotes() {
  ['snare', 'hihat', 'rimshot'].forEach(inst => {
    for (let i = 0; i < state.sequenceLength; i++) {
      if (Math.random() < 0.15 && !patterns[inst][i].active) {
        patterns[inst][i].active = true;
        patterns[inst][i].velocity = 0.2 + Math.random() * 0.2;
        patterns[inst][i].probability = 60 + Math.random() * 40;
      }
    }
  });
  renderSequencer();
}

function randomizeVelocity() {
  Object.keys(instruments).forEach(inst => {
    patterns[inst].forEach(step => {
      if (step.active) {
        step.velocity = 0.5 + Math.random() * 0.5;
      }
    });
  });
  renderSequencer();
}

function randomizeProbability() {
  Object.keys(instruments).forEach(inst => {
    patterns[inst].forEach(step => {
      if (step.active) {
        step.probability = 50 + Math.floor(Math.random() * 51);
      }
    });
  });
  renderSequencer();
}

function clearPattern() {
  Object.keys(instruments).forEach(inst => {
    patterns[inst].forEach(step => {
      step.active = false;
      step.velocity = 0.8;
      step.probability = 100;
      step.note = instruments[inst].note;
      step.duration = '8n';
    });
  });
  renderSequencer();
}

function generateMelodicPatterns() {
  generateBassLine();
  generateKeyPattern();
  generateLeadMelody();
  renderSequencer();
}

function generateBassLine() {
  const scaleIntervals = scales[state.scale];
  const keyIndex = keysArr.indexOf(state.key);
  const root = state.key;
  const octave = 2;
  
  const bassNotes = [
    root + octave,
    keysArr[(keyIndex + scaleIntervals[4]) % 12] + octave,
    root + (octave + 1),
    keysArr[(keyIndex + scaleIntervals[3]) % 12] + octave
  ];
  
  const density = state.complexity === 1 ? 4 : state.complexity === 2 ? 6 : 8;
  
  for (let i = 0; i < state.sequenceLength; i++) {
    if (i % (16 / density) === 0 || (state.complexity >= 3 && Math.random() < 0.3)) {
      patterns.bass[i].active = true;
      patterns.bass[i].note = bassNotes[Math.floor(i / 4) % bassNotes.length];
      patterns.bass[i].velocity = 0.7 + Math.random() * 0.3;
      patterns.bass[i].duration = '8n';
      patterns.bass[i].probability = 100;
    }
  }
}

function generateKeyPattern() {
  const scaleIntervals = scales[state.scale];
  const keyIndex = keysArr.indexOf(state.key);
  const octave = 4;
  
  const chords = [];
  for (let i = 0; i < 4; i++) {
    const degree = [0, 3, 4, 0][i];
    const root = keysArr[(keyIndex + scaleIntervals[degree]) % 12];
    const third = keysArr[(keyIndex + scaleIntervals[(degree + 2) % scaleIntervals.length]) % 12];
    const fifth = keysArr[(keyIndex + scaleIntervals[(degree + 4) % scaleIntervals.length]) % 12];
    chords.push([root + octave, third + octave, fifth + octave]);
  }
  
  for (let i = 0; i < state.sequenceLength; i++) {
    if (i % 4 === 0) {
      const index = Math.floor(i / 4) % chords.length;
      patterns.keys[i].active = true;
      patterns.keys[i].note = chords[index];
      patterns.keys[i].velocity = 0.6 + Math.random() * 0.2;
      patterns.keys[i].duration = '2n';
      patterns.keys[i].probability = 100;
    }
  }
}

function generateLeadMelody() {
  const scaleIntervals = scales[state.scale];
  const keyIndex = keysArr.indexOf(state.key);
  const octave = 5;
  
  const scaleNotes = scaleIntervals.map(iv => keysArr[(keyIndex + iv) % 12] + octave);
  const extended = [
    ...scaleNotes,
    ...scaleIntervals.map(iv => keysArr[(keyIndex + iv) % 12] + (octave + 1))
  ];
  
  let lastIndex = 0;
  const density = state.complexity === 1 ? 4 : state.complexity === 2 ? 6 : 10;
  
  for (let i = 0; i < state.sequenceLength; i++) {
    if (Math.random() < (density / 16)) {
      const jump = Math.random() < 0.7 
        ? (Math.random() < 0.5 ? 1 : -1) 
        : (Math.floor(Math.random() * 5) - 2);
      
      lastIndex = clamp(lastIndex + jump, 0, extended.length - 1);
      
      patterns.lead[i].active = true;
      patterns.lead[i].note = extended[lastIndex];
      patterns.lead[i].velocity = 0.6 + Math.random() * 0.4;
      patterns.lead[i].duration = Math.random() < 0.7 ? '8n' : '16n';
      patterns.lead[i].probability = Math.random() < 0.8 ? 100 : 75;
    }
  }
}

function applyEuclidean() {
  const instrumentKeys = Object.keys(instruments);
  const inst = instrumentKeys[Math.floor(Math.random() * instrumentKeys.length)];
  const hits = Math.floor(Math.random() * 8) + 3;
  const steps = state.sequenceLength;
  
  const pattern = generateEuclidean(hits, steps);
  pattern.forEach((value, i) => {
    patterns[inst][i].active = value === 1;
    if (value === 1) {
      patterns[inst][i].velocity = 0.7 + Math.random() * 0.3;
      patterns[inst][i].probability = 100;
    }
  });
  
  renderSequencer();
}

function generateEuclidean(hits, steps) {
  const result = Array(steps).fill(0);
  const bucket = [];
  
  for (let i = 0; i < steps; i++) {
    bucket.push(Math.floor((i * hits) / steps));
  }
  
  for (let i = 0; i < steps; i++) {
    if (i === 0 || bucket[i] !== bucket[i - 1]) {
      result[i] = 1;
    }
  }
  
  return result;
}

// -------------------- Mixer Rendering --------------------
function renderMixer() {
  const grid = document.getElementById('mixerGrid');
  const fragment = document.createDocumentFragment();
  
  Object.keys(instruments).forEach(inst => {
    const data = instruments[inst];
    const channel = document.createElement('div');
    channel.className = 'mixer-channel';
    
    channel.innerHTML = `
      <div class="channel-header">
        <div class="channel-name">${data.icon} ${data.name}</div>
        <div class="channel-btns">
          <button class="channel-btn mute ${data.mute ? 'active' : ''}" 
                  data-inst="${inst}" data-action="mute">M</button>
          <button class="channel-btn solo ${data.solo ? 'active' : ''}" 
                  data-inst="${inst}" data-action="solo">S</button>
        </div>
      </div>
      <div class="param-control">
        <div class="param-label">
          <span>Volume</span>
          <span class="param-value">${data.volume}dB</span>
        </div>
        <input type="range" min="-40" max="10" value="${data.volume}" 
               data-inst="${inst}" data-param="volume">
      </div>
      <div class="param-control">
        <div class="param-label">
          <span>Pan</span>
          <span class="param-value">${data.pan > 0 ? 'R' : data.pan < 0 ? 'L' : 'C'}${Math.abs(data.pan)}</span>
        </div>
        <input type="range" min="-100" max="100" value="${data.pan}" 
               data-inst="${inst}" data-param="pan">
      </div>
    `;
    
    fragment.appendChild(channel);
  });
  
  grid.innerHTML = '';
  grid.appendChild(fragment);
}

// -------------------- FX Rendering --------------------
function renderFX() {
  const grid = document.getElementById('fxGrid');
  const fragment = document.createDocumentFragment();
  
  Object.keys(fxConfig).forEach(fx => {
    const config = fxConfig[fx];
    const unit = document.createElement('div');
    unit.className = 'fx-unit';
    
    const params = Object.keys(config).filter(k => k !== 'name' && k !== 'active');
    let paramsHTML = '';
    
    params.forEach(param => {
      const value = config[param];
      const display = formatFxDisplay(param, value);
      
      let sliderVal = 50;
      if (param === 'decay') {
        sliderVal = clamp(Math.round(value * 20), 0, 100);
      } else if (['wet', 'feedback', 'depth', 'amount'].includes(param)) {
        sliderVal = Math.round(value * 100);
      } else if (param === 'time') {
        const timeMap = { '16n': 0, '8n': 33, '4n': 66, '2n': 100 };
        sliderVal = timeMap[value] ?? 50;
      } else if (param === 'frequency') {
        sliderVal = Math.round((value - 100) / 79);
      } else if (param === 'octaves') {
        sliderVal = (value - 1) * 20;
      }
      
      paramsHTML += `
        <div class="param-control">
          <div class="param-label">
            <span>${param}</span>
            <span class="param-value">${display}</span>
          </div>
          <input type="range" min="0" max="100" value="${sliderVal}" 
                 data-fx="${fx}" data-param="${param}">
        </div>
      `;
    });
    
    unit.innerHTML = `
      <div class="fx-header">
        <div class="fx-name">${config.name}</div>
        <div class="fx-toggle ${config.active ? 'active' : ''}" data-fx="${fx}"></div>
      </div>
      ${paramsHTML}
    `;
    
    fragment.appendChild(unit);
  });
  
  grid.innerHTML = '';
  grid.appendChild(fragment);
}

// -------------------- Harmony System --------------------
function renderHarmony() {
  const keySelect = document.getElementById('keySelect');
  keySelect.innerHTML = keysArr.map(k => 
    `<option value="${k}" ${k === state.key ? 'selected' : ''}>${k}</option>`
  ).join('');
  
  const scaleSelect = document.getElementById('scaleSelect');
  scaleSelect.innerHTML = Object.keys(scales).map(s => 
    `<option value="${s}" ${s === state.scale ? 'selected' : ''}>${s}</option>`
  ).join('');
  
  const octaveSelect = document.getElementById('octaveSelect');
  octaveSelect.innerHTML = [2, 3, 4, 5, 6].map(o => 
    `<option value="${o}" ${o === state.octave ? 'selected' : ''}>${o}</option>`
  ).join('');
  
  updateChords();
}

function updateChords() {
  const chordChips = document.getElementById('chordChips');
  const fragment = document.createDocumentFragment();
  
  const keyIndex = keysArr.indexOf(state.key);
  const scaleIntervals = scales[state.scale];
  
  const chords = [];
  scaleIntervals.forEach((interval, i) => {
    const root = keysArr[(keyIndex + interval) % 12];
    const third = scaleIntervals[(i + 2) % scaleIntervals.length];
    const thirdInterval = (third - interval + 12) % 12;
    const type = thirdInterval === 3 ? 'minor' : thirdInterval === 4 ? 'major' : 'dim';
    chords.push({ root, type, roman: ['I','II','III','IV','V','VI','VII'][i] });
  });
  
  chords.forEach(chord => {
    const chip = document.createElement('div');
    chip.className = 'chip';
    chip.textContent = `${chord.roman} - ${chord.root}${chord.type === 'minor' ? 'm' : chord.type === 'dim' ? '°' : ''}`;
    chip.addEventListener('click', () => {
      state.progression.push(chord);
      renderProgression();
    });
    fragment.appendChild(chip);
  });
  
  chordChips.innerHTML = '';
  chordChips.appendChild(fragment);
}

function renderProgression() {
  const wrap = document.getElementById('progressionChips');
  const fragment = document.createDocumentFragment();
  
  if (!state.progression.length) {
    wrap.innerHTML = '<div style="color: var(--text-muted); font-size: 0.9rem;">Click chords above to build progression</div>';
    return;
  }
  
  state.progression.forEach((chord, index) => {
    const chip = document.createElement('div');
    chip.className = 'chip active';
    chip.textContent = `${chord.roman} - ${chord.root}${chord.type === 'minor' ? 'm' : chord.type === 'dim' ? '°' : ''}`;
    chip.addEventListener('click', () => {
      state.progression.splice(index, 1);
      renderProgression();
    });
    fragment.appendChild(chip);
  });
  
  wrap.innerHTML = '';
  wrap.appendChild(fragment);
}

function generateProgression() {
  const keyIndex = keysArr.indexOf(state.key);
  const scaleIntervals = scales[state.scale];
  const templates = [
    [0, 3, 4, 0],
    [0, 5, 3, 4],
    [1, 4, 0],
    [0, 4, 5, 3]
  ];
  
  const template = templates[Math.floor(Math.random() * templates.length)];
  state.progression = [];
  
  template.forEach(degree => {
    const interval = scaleIntervals[degree];
    const root = keysArr[(keyIndex + interval) % 12];
    const third = scaleIntervals[(degree + 2) % scaleIntervals.length];
    const thirdInterval = (third - interval + 12) % 12;
    const type = thirdInterval === 3 ? 'minor' : thirdInterval === 4 ? 'major' : 'dim';
    state.progression.push({ root, type, roman: ['I','II','III','IV','V','VI','VII'][degree] });
  });
  
  renderProgression();
}

function loadProgressionTemplate(name) {
  const templates = {
    'ii-v-i': [
      { root: 'D', type: 'minor', roman: 'II' },
      { root: 'G', type: 'major', roman: 'V' },
      { root: 'C', type: 'major', roman: 'I' }
    ],
    'lofi': [
      { root: 'C', type: 'major', roman: 'I' },
      { root: 'A', type: 'minor', roman: 'VI' },
      { root: 'F', type: 'major', roman: 'IV' },
      { root: 'G', type: 'major', roman: 'V' }
    ],
    'neosoul': [
      { root: 'D', type: 'minor', roman: 'II' },
      { root: 'E', type: 'minor', roman: 'III' },
      { root: 'A', type: 'minor', roman: 'VI' },
      { root: 'D', type: 'minor', roman: 'II' }
    ],
    'modal': [
      { root: 'D', type: 'minor', roman: 'I' },
      { root: 'E', type: 'minor', roman: 'II' },
      { root: 'F', type: 'major', roman: 'III' },
      { root: 'G', type: 'major', roman: 'IV' }
    ]
  };
  
  state.progression = templates[name] || [];
  renderProgression();
}

// -------------------- Preset System --------------------
function renderPresets() {
  const grid = document.getElementById('presetGrid');
  const fragment = document.createDocumentFragment();
  
  Object.keys(genrePresets).forEach(genre => {
    const preset = genrePresets[genre];
    const div = document.createElement('div');
    div.className = 'preset';
    div.innerHTML = `
      <div class="preset-icon">${preset.icon}</div>
      <div class="preset-name">${preset.name}</div>
    `;
    div.addEventListener('click', () => loadPreset(genre));
    fragment.appendChild(div);
  });
  
  grid.innerHTML = '';
  grid.appendChild(fragment);
}

function loadPreset(genre) {
  state.currentGenre = genre;
  document.querySelectorAll('.genre-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.genre === genre);
  });
  generateBeat();
}

function updateGenrePresets() {
  renderPresets();
}

// -------------------- Transport Controls --------------------
async function togglePlay() {
  if (state.isPlaying) {
    Tone.Transport.pause();
    state.isPlaying = false;
    document.getElementById('playBtn').innerHTML = '▶️ Play';
    stopTimer();
    stopVisualizer();
    return;
  }
  
  const hasActive = Object.keys(patterns).some(inst => 
    patterns[inst].some(s => s.active)
  );
  
  if (!hasActive) {
    alert('No active notes — click "Generate Beat" or add steps.');
    return;
  }
  
  try {
    await Tone.start();
    const raw = Tone.getContext().rawContext;
    if (raw.state !== 'running') await raw.resume();
    console.log('🎵 Audio started:', raw.state);
  } catch (e) {
    console.error('Could not start audio:', e);
    alert('Could not start audio. Click anywhere on the page, then press Play again.');
    return;
  }
  
  Tone.Transport.start();
  state.isPlaying = true;
  document.getElementById('playBtn').innerHTML = '⏸️ Pause';
  startTimer();
  document.getElementById('vizOverlay').style.display = 'none';
  updateVisualizer();
}

function stop() {
  Tone.Transport.stop();
  state.isPlaying = false;
  state.currentStep = 0;
  document.getElementById('playBtn').innerHTML = '▶️ Play';
  document.getElementById('timeDisplay').textContent = '00:00';
  document.getElementById('progressFill').style.width = '0%';
  document.querySelectorAll('.step').forEach(el => el.classList.remove('playing'));
  stopTimer();
  stopVisualizer();
}

// -------------------- Timer System --------------------
let progressRAF = 0;

function startTimer() {
  cancelAnimationFrame(progressRAF);
  
  const totalSeconds = state.duration * 60;
  const updateProgress = throttle(() => {
    const seconds = Tone.Transport.seconds;
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    
    document.getElementById('timeDisplay').textContent = 
      String(mins).padStart(2, '0') + ':' + String(secs).padStart(2, '0');
    
    document.getElementById('progressFill').style.width = 
      Math.min(100, (seconds / totalSeconds) * 100) + '%';
  }, CONFIG.PROGRESS_UPDATE_MS);
  
  const tick = () => {
    updateProgress();
    progressRAF = requestAnimationFrame(tick);
  };
  
  progressRAF = requestAnimationFrame(tick);
}

function stopTimer() {
  cancelAnimationFrame(progressRAF);
  progressRAF = 0;
}

// -------------------- Visualizer System --------------------
let visualizerRAF = 0;
let lastVisualizerUpdate = 0;

function initVisualizerOnce() {
  const viz = document.getElementById('visualizer');
  if (viz.dataset.ready) return;
  
  viz.dataset.ready = '1';
  const fragment = document.createDocumentFragment();
  
  for (let i = 0; i < CONFIG.VISUALIZER_BARS; i++) {
    const bar = document.createElement('div');
    bar.className = 'viz-bar';
    bar.style.left = (i * 100 / CONFIG.VISUALIZER_BARS) + '%';
    bar.style.height = '10%';
    fragment.appendChild(bar);
  }
  
  viz.appendChild(fragment);
}

function updateVisualizer() {
  if (visualizerRAF) return;
  
  const viz = document.getElementById('visualizer');
  const bars = viz ? viz.querySelectorAll('.viz-bar') : [];
  const barCount = bars.length || 0;
  
  const updateInterval = 1000 / CONFIG.VISUALIZER_FPS;
  
  const loop = (timestamp) => {
    visualizerRAF = requestAnimationFrame(loop);
    
    if (!lastVisualizerUpdate || (timestamp - lastVisualizerUpdate) >= updateInterval) {
      lastVisualizerUpdate = timestamp;
      
      let heights;
      if (master.analyser) {
        const values = master.analyser.getValue();
        heights = new Array(barCount).fill(0).map((_, i) => {
          const index = Math.floor((i / barCount) * values.length);
          const value = values[clamp(index, 0, values.length - 1)];
          
          if (master.analyser.type === 'fft') {
            const db = clamp(value, -100, 0);
            const normalized = (db + 100) / 100;
            return (5 + normalized * 90).toFixed(1) + '%';
          } else {
            const normalized = (value + 1) / 2;
            return (5 + normalized * 90).toFixed(1) + '%';
          }
        });
      } else {
        heights = Array.from({ length: barCount }, () => 
          (Math.random() * 60 + 10).toFixed(1) + '%'
        );
      }
      
      bars.forEach((bar, i) => {
        bar.style.height = heights[i];
        bar.style.transform = '';
      });
    }
  };
  
  visualizerRAF = requestAnimationFrame(loop);
}

function stopVisualizer() {
  cancelAnimationFrame(visualizerRAF);
  visualizerRAF = 0;
}

// -------------------- Project Management --------------------
function getSerializableInstruments() {
  const keep = ['name', 'icon', 'mute', 'solo', 'volume', 'pan', 'type', 'note'];
  const cleaned = {};
  
  Object.keys(instruments).forEach(key => {
    cleaned[key] = {};
    keep.forEach(field => {
      cleaned[key][field] = instruments[key][field];
    });
  });
  
  return cleaned;
}

function saveProject() {
  const projectName = document.getElementById('projectName').value || 'Untitled';
  
  const plainPatterns = {};
  Object.keys(patterns).forEach(inst => {
    plainPatterns[inst] = patterns[inst].map(step => ({
      active: !!step.active,
      velocity: step.velocity ?? 0.8,
      probability: step.probability ?? 100,
      note: step.note ?? instruments[inst].note ?? null,
      duration: step.duration ?? '8n'
    }));
  });
  
  const project = {
    name: projectName,
    state: {
      ...state,
      isPlaying: false
    },
    patterns: plainPatterns,
    instruments: getSerializableInstruments(),
    timestamp: Date.now()
  };
  
  const json = JSON.stringify(project, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `${projectName.replace(/\s+/g, '_')}.prostudio.json`;
  link.click();
  
  setTimeout(() => URL.revokeObjectURL(url), 1000);
  alert('✅ Project saved!');
}

function applyLoadedInstruments(loaded) {
  Object.keys(loaded).forEach(inst => {
    const source = loaded[inst];
    if (!instruments[inst]) return;
    
    instruments[inst].mute = !!source.mute;
    instruments[inst].solo = !!source.solo;
    instruments[inst].volume = source.volume ?? instruments[inst].volume;
    instruments[inst].pan = source.pan ?? instruments[inst].pan;
    instruments[inst].note = source.note ?? instruments[inst].note;
    
    if (instruments[inst].channel) {
      instruments[inst].channel.volume.value = instruments[inst].volume;
      instruments[inst].channel.pan.value = (instruments[inst].pan || 0) / 100;
    }
  });
}

function loadProject() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json,.prostudio.json';
  
  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = ev => {
      try {
        const project = JSON.parse(ev.target.result);
        
        const {
          bpm, swing, duration, complexity, humanize,
          sequenceLength, resolution, key, scale, octave, progression
        } = project.state || {};
        
        Object.assign(state, {
          ...state,
          bpm, swing, duration, complexity, humanize,
          sequenceLength, resolution, key, scale, octave, progression
        });
        
        Object.keys(patterns).forEach(k => delete patterns[k]);
        Object.assign(patterns, project.patterns || {});
        
        if (project.instruments) {
          applyLoadedInstruments(project.instruments);
        }
        
        updateAllDisplays();
        ensurePatternLength(state.sequenceLength);
        renderSequencer();
        renderMixer();
        renderFX();
        renderHarmony();
        
        document.getElementById('projectName').value = project.name || 'Untitled';
        alert('✅ Project loaded!');
      } catch (err) {
        alert('❌ Error loading project: ' + err.message);
      }
    };
    
    reader.readAsText(file);
  };
  
  input.click();
}

function updateAllDisplays() {
  state.bpm = Math.min(CONFIG.MAX_BPM, state.bpm);
  
  document.getElementById('bpmSlider').value = state.bpm;
  document.getElementById('bpmValue').textContent = state.bpm;
  document.getElementById('swingSlider').value = state.swing;
  document.getElementById('swingValue').textContent = state.swing + '%';
  document.getElementById('durSlider').value = state.duration;
  document.getElementById('durValue').textContent = state.duration + ' min';
  document.getElementById('durationDisplay').textContent = 
    '/ ' + String(state.duration).padStart(2, '0') + ':00';
  document.getElementById('complexSlider').value = state.complexity;
  document.getElementById('complexValue').textContent = 
    ['Simple', 'Medium', 'Complex'][state.complexity - 1];
  document.getElementById('humanSlider').value = state.humanize;
  document.getElementById('humanValue').textContent = state.humanize + 'ms';
  
  Tone.Transport.bpm.value = state.bpm;
  Tone.Transport.swing = state.swing / 100;
  Tone.Transport.swingSubdivision = '8n';
}

// -------------------- Audio Export --------------------
function bufferToWav(audioBuffer) {
  const numChannels = audioBuffer.numberOfChannels;
  const sampleRate = audioBuffer.sampleRate;
  const numFrames = audioBuffer.length;
  const bytesPerSample = 2;
  const dataSize = numFrames * numChannels * bytesPerSample;
  const buffer = new ArrayBuffer(44 + dataSize);
  const view = new DataView(buffer);
  
  let offset = 0;
  
  function writeString(str) {
    for (let i = 0; i < str.length; i++) {
      view.setUint8(offset++, str.charCodeAt(i));
    }
  }
  
  function writeUint32(val) {
    view.setUint32(offset, val, true);
    offset += 4;
  }
  
  function writeUint16(val) {
    view.setUint16(offset, val, true);
    offset += 2;
  }
  
  // WAV header
  writeString('RIFF');
  writeUint32(36 + dataSize);
  writeString('WAVE');
  
  // fmt chunk
  writeString('fmt ');
  writeUint32(16);
  writeUint16(1); // PCM
  writeUint16(numChannels);
  writeUint32(sampleRate);
  writeUint32(sampleRate * numChannels * bytesPerSample);
  writeUint16(numChannels * bytesPerSample);
  writeUint16(16);
  
  // data chunk
  writeString('data');
  writeUint32(dataSize);
  
  // Interleave samples
  const channels = [];
  for (let c = 0; c < numChannels; c++) {
    channels.push(audioBuffer.getChannelData(c));
  }
  
  for (let i = 0; i < numFrames; i++) {
    for (let c = 0; c < numChannels; c++) {
      let sample = clamp(channels[c][i], -1, 1);
      sample = sample < 0 ? sample * 0x8000 : sample * 0x7FFF;
      view.setInt16(offset, sample, true);
      offset += 2;
    }
  }
  
  return new Uint8Array(buffer);
}

async function exportAudio() {
  stopVisualizer();
  stopTimer();
  
  const hasActive = Object.keys(patterns).some(inst => 
    patterns[inst].some(s => s.active)
  );
  
  if (!hasActive) {
    alert('❌ No active notes! Please create a pattern first.');
    return;
  }
  
  const seconds = Math.max(1, state.duration * 60);
  const bpm = state.bpm;
  const seqLen = state.sequenceLength;
  const res = state.resolution;
  
  console.log('⚙️ Rendering offline audio…');
  
  let rendered;
  try {
    rendered = await Tone.Offline(() => {
      // Build offline graph
      const fxIn = new Tone.Gain(1);
      const comp = new Tone.Compressor(-18, 3);
      const limit = new Tone.Limiter(-1);
      fxIn.chain(comp, limit, Tone.Destination);
      
      const localSynths = {};
      Object.keys(instruments).forEach(inst => {
        const data = instruments[inst];
        let synth;
        
        if (data.type === 'drum') {
          synth = createDrumSynth(inst);
        } else {
          synth = createMelodicSynth(inst);
          synth.volume.value = data.volume || 0;
        }
        
        const channel = new Tone.Channel({
          pan: 0,
          volume: data.volume || 0
        }).connect(fxIn);
        
        synth.connect(channel);
        localSynths[inst] = synth;
      });
      
      Tone.Transport.bpm.value = bpm;
      Tone.Transport.swing = state.swing / 100;
      Tone.Transport.swingSubdivision = '8n';
      
      new Tone.Sequence((time, step) => {
        Object.keys(instruments).forEach(inst => {
          const pattern = patterns[inst][step];
          if (!pattern?.active) return;
          if (Math.random() * 100 > (pattern.probability ?? 100)) return;
          
          const humanize = (Math.random() - 0.5) * (state.humanize / 1000);
          const synth = localSynths[inst];
          if (!synth) return;
          
          if (instruments[inst].type === 'drum') {
            if (inst === 'kick') {
              synth.triggerAttackRelease('C1', '8n', time + humanize, pattern.velocity);
            } else if (inst === 'snare' || inst === 'clap') {
              synth.triggerAttackRelease('16n', time + humanize, pattern.velocity);
            } else if (inst === 'hihat') {
              synth.triggerAttackRelease('C6', '16n', time + humanize, pattern.velocity * 0.5);
            } else {
              synth.triggerAttackRelease('C2', '16n', time + humanize, pattern.velocity);
            }
          } else {
            const note = pattern.note || instruments[inst].note || 'C4';
            const duration = pattern.duration || '8n';
            synth.triggerAttackRelease(note, duration, time + humanize, pattern.velocity);
          }
        });
      }, Array.from({ length: seqLen }, (_, i) => i), res).start(0);
      
      Tone.Transport.start(0);
    }, seconds, 2);
  } catch (err) {
    console.error('Offline render failed:', err);
    alert('❌ Export failed during rendering: ' + (err?.message || err));
    return;
  }
  
  if (!rendered || !rendered.length || !rendered.getChannelData) {
    alert('❌ Render produced no audio.');
    return;
  }
  
  try {
    const wav = bufferToWav(rendered);
    const blob = new Blob([wav], { type: 'audio/wav' });
    const name = (document.getElementById('projectName')?.value || 'beat')
      .replace(/\s+/g, '_') + `_${Date.now()}.wav`;
    
    if (window.showSaveFilePicker) {
      const handle = await showSaveFilePicker({
        suggestedName: name,
        types: [{ description: 'WAV Audio', accept: { 'audio/wav': ['.wav'] } }]
      });
      const writable = await handle.createWritable();
      await writable.write(blob);
      await writable.close();
    } else {
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = name;
      link.click();
      setTimeout(() => URL.revokeObjectURL(url), 1000);
    }
    
    alert('✅ Export complete!');
  } catch (err) {
    console.error('Save step failed:', err);
    alert('❌ Export failed while saving: ' + (err?.message || err));
  }
}

// -------------------- PWA Installation --------------------
let deferredPrompt;

window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredPrompt = e;
  document.getElementById('installBtn').hidden = false;
});

document.getElementById('installBtn').addEventListener('click', async () => {
  if (!deferredPrompt) return;
  
  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;
  
  if (outcome === 'accepted') {
    document.getElementById('installBtn').hidden = true;
  }
  
  deferredPrompt = null;
});

// -------------------- Initialization --------------------
function init() {
  initAudioContext();
  initAudio();
  ensurePatternLength(state.sequenceLength);
  setupEventListeners();
  renderSequencer();
  renderMixer();
  renderFX();
  renderHarmony();
  renderPresets();
  updateAllDisplays();
  initVisualizerOnce();
  unlockAudioOnce();
  
  // Apply saved vibe
  try {
    const savedVibe = localStorage.getItem(CONFIG.STORAGE_KEY) || 'moon';
    applyVibe(savedVibe);
  } catch (e) {
    applyVibe('moon');
  }
}

// -------------------- Entry Point --------------------
document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>
